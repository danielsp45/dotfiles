"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[25556],{245549:(e,s,t)=>{t.r(s),t.d(s,{usePageSubscriptionManager:()=>u});t(16280),t(898992),t(354520);var i=t(296540),n=()=>t(484714),r=()=>t(941541),o=()=>t(670631),a=()=>t(722038),l=()=>t(884064),h=()=>t(537972);let c;function u(){const e=(0,n().v3)(),{currentUser:{id:s}}=e,t=(0,a().y)(),r=(0,a().R)(),o=(0,l()._)(),u="none"!==o;(0,i.useEffect)((()=>{(t||r)&&u&&s&&(c?c.environment=e:c=new d(e,o,s))}),[e,s,t,r,u,o]);const f=c&&s!==c.userId;(0,i.useEffect)((()=>{f&&c&&c.handleUserChange(s)}),[s,f]);const g=(0,i.useCallback)((()=>{var e;null===(e=c)||void 0===e||e.handleOfflinePagesChange()}),[]);(0,h().Gf)(g)}class d{constructor(e,s,i){this.status="stopped",this.lockAbortController=void 0,this.releaseUserLock=void 0,this.environment=e,this.updateSource=s,this.userId=i,this.handleOfflinePagesChange=t(496603).nF(this.handleOfflinePagesChange.bind(this),1e3,{leading:!0}),this.trySubscribing()}trySubscribing(){if(!this.userId)throw new Error("No userId provided for subscribing");var e;this.lockAbortController=new AbortController,this.status="waiting-for-lock",navigator.locks.request((e=this.userId,`page-updates-${e}`),{signal:this.lockAbortController.signal},(()=>(this.status="subscribing",this.refreshListeners(),new Promise((e=>{this.releaseUserLock=e}))))).catch((e=>{}))}handleUserChange(e){var s;if(this.userId=e,"subscribing"===this.status)this.removeAllListeners(),this.status="stopped",null===(s=this.releaseUserLock)||void 0===s||s.call(this),this.releaseUserLock=void 0;else if("waiting-for-lock"===this.status){var t;null===(t=this.lockAbortController)||void 0===t||t.abort(),this.lockAbortController=void 0,this.status="stopped"}this.userId&&this.trySubscribing()}handleOfflinePagesChange(){"subscribing"===this.status&&this.refreshListeners()}async refreshListeners(){const{defaultRecordCache:{persistedRecordCache:e}}=this.environment;if(!e||!this.userId)return;const s=(await e.getOfflinePages({userId:this.userId})).filter((e=>"success"===e.downloadStatus)),i=o().A.state.offlinePageListeners,n={},a={};for(const o of s){const e=o.id;n[e]=o;const s=null==i?void 0:i[e];if(s){a[e]=s;continue}const l=(0,t(921997).z9)({pageId:e,updateSource:this.updateSource}),h=r().Ay.addListener(l,void 0,(s=>{let{value:i}=s;if("number"!=typeof i)return;const n={pageId:e,lastServerUpdateTime:i,updateSource:this.updateSource};(0,t(554894).Tt)(this.environment,n)}),void 0,this.environment);a[e]=h}if(i)for(const t of Object.keys(i)){const e=i[t];e&&!(t in a)&&r().Ay.removeListener(e,this.environment)}o().A.setState({...o().A.state,offlinePages:n,offlinePageListeners:a})}removeAllListeners(){const e=o().A.state.offlinePageListeners;if(e){for(const[s,i]of(0,t(534177).WP)(e))i&&r().Ay.removeListener(i,this.environment);o().A.setState({...o().A.state,offlinePageListeners:void 0})}}}}}]);