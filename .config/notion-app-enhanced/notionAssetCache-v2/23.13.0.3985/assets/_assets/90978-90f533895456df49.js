"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[90978],{109054:(e,t,r)=>{r.d(t,{Nt:()=>a,oU:()=>s,uv:()=>l});r(898992),r(823215),r(354520),r(672577),r(737550);function a(e){return e.trim().normalize().toLocaleLowerCase().replace(/[^\w\s]/gu," ").split(/\s/gu).filter((e=>e.length>0))}function l(e){const{query:t,resultText:r,isLastQueryTermPartialMatchOK:l}=e,s=a(t),n=a(r);let o;if(l&&(o=s.pop(),!o))return!1;const u=s.every((e=>n.some((t=>t===e)))),i=!l||void 0!==n.find((e=>e.startsWith(o??"")));return u&&i}function s(e){const{blockStore:t,shouldShowPeopleCollection:r,shouldShowUserProfiles:a}=e;return!(!r&&t.isPeopleCollectionViewPage())&&!(!a&&t.isPersonProfile())}},282834:(e,t,r)=>{r.d(t,{Bu:()=>d,qw:()=>f});r(898992),r(354520),r(803949);var a=()=>r(496603);const l=/[\u4E00-\u9FA5]/g,s=/[\u3000-\u303f\u3040-\u309f\u30a0-\u30ff\uff00-\uff9f\u4e00-\u9faf\u3400-\u4dbf]/g,n=/[\u3041-\u3096\u30A0-\u30FF\u31F0-\u31FF\u3220-\u3243\u3280-\u337F]/g,o=/[\u1100-\u11FF\u3130-\u318F\uA960-\uA97F\uAC00-\uD7AF\uD7B0-\uD7FF]/g,u=/[-./\\()"'’‘”“，。、·～；,;<>~!@#$%^&*|+=[\]{}`~?:\s]/u;function i(e){return Boolean(e.match(l))}function c(e){return Boolean(e.match(o))}function h(e){return Boolean(e.match(s))}function f(e){return(0,a().oE)(e.split(u))}function d(e,t){const r=c(e);return i(e)||h(e)||r?r?"ko":function(e){return Boolean(e.match(n))}(e)||"ja-JP"===t?"ja":"zh":"none"}},690978:(e,t,r)=>{r.d(t,{r:()=>le,k:()=>ae});r(898992),r(823215),r(354520),r(672577),r(430670),r(803949),r(581454),r(737550);var a=()=>r(179034),l=()=>r(519831),s=()=>r(282834),n=()=>r(245241),o=()=>r(778078),u=()=>r(496603),i=()=>r(498212),c=()=>r(534177),h=()=>r(720665),f=()=>r(222917),d=()=>r(679924),_=()=>r(780865),E=()=>r(470928),g=()=>r(12974);r(944114),r(517642),r(658004),r(733853),r(845876),r(432475),r(515024),r(731698);async function T(e){const{spaceId:t,userId:a,blocks:l,environment:s}=e,n=l.map((e=>e.blockModel.id));if(!t||!a||!(0,c().EI)(n))return;const o=await r(449506).callApi({eventName:"getPageSignals",environment:s,data:{spaceId:t,pageIds:n,includeRecords:!0,signals:[{name:"pageAuthorityV1"}]}});if("success"===o.type){const e=n.map((e=>({})));o.data.signals.forEach((t=>{if("success"===t.status){const{name:r,data:a}=t;a.forEach(((t,a)=>{e[a][r]=t}))}}));const r=(0,h().MU)(e.map(((e,t)=>[n[t],e]))),l=S.getKey(t,a);S.update((e=>{const t=e.pageSignals.get(l),a=e.pageSignals.set(l,{...t,...r});return{...e,pageSignals:a}}))}}class v extends(()=>r(757695))().Store{getInitialState(){return{pageSignals:new Map}}getKey(e,t){return`${e}:${t}`}getPageSignals(e){let{spaceId:t,userId:r}=e;if(!t||!r)return;const a=this.getKey(t,r),l=this.state.pageSignals.get(a);return l||void 0}async updatePageSignals(e){const{spaceId:t,userId:r,blocks:a}=e;if(!t||!r)return;const l=this.getPageSignals(e),s=void 0===l?a:a.filter((e=>!l.hasOwnProperty(e.blockModel.id)));if(s.length>0&&await T({...e,blocks:s}),l){const e=Object.keys(l).length+s.length;if(e>2048){const s=e-2048,n=new Set(a.map((e=>e.blockModel.id)));!function(e){const{spaceId:t,userId:r,pageIds:a}=e,l=S.getKey(t,r);S.update((e=>{const t={...e.pageSignals.get(l)};a.forEach((e=>delete t[e]));const r=e.pageSignals.set(l,t);return{...e,pageSignals:r}}))}({spaceId:t,userId:r,pageIds:Object.keys(l).filter((e=>!n.has(e))).slice(0,s)})}}}}const S=new v;class I{constructor(e,t,a){var l;this.featuresets=void 0,this.queryLower=void 0,this.userId=void 0,this.spaceId=void 0,this.currentTimeMs=void 0,this.currentDateMs=void 0,this.pageSignals=void 0,this.resultsFeatureMetadata={},this.recentPagesMap=void 0,this.featuresets=e,this.queryLower=a.toLowerCase();const s=t.currentUser.id,n=null===(l=r(765957).default.state.currentSpaceStore)||void 0===l?void 0:l.id;this.userId=s,this.spaceId=n,this.currentTimeMs=Date.now(),this.currentDateMs=new Date(new Date(this.currentTimeMs).toDateString()).getTime(),this.pageSignals=S.getPageSignals({spaceId:this.spaceId,userId:this.userId}),this.recentPagesMap=u().Bj((()=>{const e=(n?r(968172).A.get(n):[])??[];return new Map(e.map((e=>[e.pageId,e.visitedAt])))}))}searchFrecencyVisits(e){const{spaceId:t,userId:a}=this;if(t&&a)return(0,r(355012).C8)({spaceId:t,userId:a,pageId:e})}searchSimilarUserVisits(e){const{spaceId:t,userId:a}=this;if(t&&a)return function(e){const{spaceId:t,userId:a,pageId:l}=e,s=r(314648).default.getUserSignals({spaceId:t,userId:a});if(!s)return;return s.similarUserRecentPages[l]}({spaceId:t,userId:a,pageId:e})}extractFeatureGroup(e){const t=[];for(const r of this.featuresets){const a={groupName:r.name,features:[]};for(const t of r.features)a.features.push(t({result:e,featureExtractor:this}));t.push(a)}return t}}var C=()=>r(430483),p=()=>r(217429),O=()=>r(148832),m=()=>r(543665),R=()=>r(250484),M=()=>r(523584);function L(e){return Number.isFinite(e)?e:0}const A={name:"CLIENT_FEATURESET_RELEVANCY_MODEL",features:[function(e){let{result:t,featureExtractor:r}=e;return{name:"TIME_SINCE_LAST_EDIT",value:r.currentTimeMs-t.block.blockModel.last_edited_time}},function(e){let{result:t,featureExtractor:r}=e;return{name:"IS_LAST_EDITED_BY_ME",value:r.userId&&t.block.blockModel.last_edited_by_id===r.userId?1:0}},function(e){let{result:t,featureExtractor:r}=e;return{name:"IS_CREATED_BY_ME",value:r.userId&&t.block.blockModel.created_by_id===r.userId?1:0}},...n().jp.map((e=>t=>{let{result:r}=t;return{name:`BLOCK_SOURCE_${e}`,value:r.block.source.has(e)?1:0}})),function(e){var t;let{result:r,featureExtractor:a}=e;return{name:"PAGE_AUTHORITY_V1",value:a.pageSignals?null===(t=a.pageSignals[r.block.blockModel.id])||void 0===t?void 0:t.pageAuthorityV1:void 0}},function(e){let{result:t}=e;return{name:"TITLE_LENGTH",value:t.block.text.length}},function(e){let{result:{terms:t},featureExtractor:{queryLower:r}}=e;return{name:"TERMS_COUNT_NORMALIZED",value:L(t.length/(0,M().Bj)(r).length)}},function(e){let{result:{terms:t},featureExtractor:{queryLower:r}}=e;const a=(0,M().Bj)(r),l=new Set(t);return{name:"FULL_MATCH_TERM_COUNT_NORMALIZED",value:L(a.filter((e=>l.has(e))).length/a.length)}},function(e){let{result:{terms:t,block:{text:r}}}=e;const a=(0,M().Bj)(r.toLowerCase());return{name:"MATCHING_PERCENTAGE_OF_TITLE",value:L(t.length/a.length)}}]},U={name:"CLIENT_FEATURESET_RELEVANCY_MODEL_UNIFIED",features:[function(e){let{result:t,featureExtractor:r}=e;const a=t.block.blockModel.id,l=r.recentPagesMap().get(a),s=r.currentDateMs,n=Math.max(l??-1);return n<0?{name:"RECENT_VISIT_SCORE",value:B}:{name:"RECENT_VISIT_SCORE",value:1+N({nowDateMs:s,visitedAt:n})}},function(e){let{result:t,featureExtractor:r}=e;const a=t.block.blockModel.id,l=r.searchFrecencyVisits(a),s=r.currentDateMs;if(!l)return{name:"SEARCH_FRECENCY_SCORE",value:B};const n=l.visits.map((e=>N({nowDateMs:s,visitedAt:e}))),o=(0,u().cz)(n)/n.length;return{name:"SEARCH_FRECENCY_SCORE",value:1+l.totalVisits*o}},function(e){let{result:t,featureExtractor:r}=e;const a=t.block.blockModel.id,l=r.searchSimilarUserVisits(a);return l&&l.sortedSimilarUserSignals.length?{name:"SIMILAR_USER_VISIT_SCORE",value:1+l.sortedSimilarUserSignals[0].similarity}:{name:"SIMILAR_USER_VISIT_SCORE",value:0}},function(e){let{result:t,featureExtractor:r}=e;return{name:"MINISEARCH_SCORE",value:t.minisearchScore}},function(e){let{result:t,featureExtractor:r}=e;return{name:"MINISEARCH_SCORE_BOOST",value:t.score/t.minisearchScore}}]};function N(e){let{nowDateMs:t,visitedAt:r}=e;const a=new Date(new Date(r).toDateString()).getTime(),l=Math.max(Math.round((t-a)/h().nD),0);return b[Math.min(l,119)]??0}const b=[1,.434123725,.2014437701,.1884654745,.15822173,.1422946031,.142166057,.1585730404,.104180793,.08345552147,.08087231107,.07897914664,.07896564574,.08624855475,.1008828419,.07266583529,.06040518516,.05852083656,.05753743353,.05815673014,.0642358674,.07381557067,.05695876233,.04843320955,.0470903377,.0466126019,.04746668155,.05325934739,.06307552903,.04855074175,.04160564903,.04030096372,.0391499705,.03939387352,.04339750927,.04955280165,.03917733172,.03338547498,.03209648275,.03168258564,.03227832486,.03591521672,.04128251996,.03310833841,.02833391706,.0272294016,.02689436518,.02729836191,.03046923141,.03441215965,.02831271484,.02449716514,.02354647072,.02317412649,.02358864378,.0263629034,.03012237319,.02459941584,.02126459634,.02046809053,.02030330894,.02052315898,.0228313469,.02579947184,.02105456017,.01811545682,.01734374938,.01698213336,.01714570426,.01897155626,.02136217635,.01769765159,.01529119728,.01463419502,.01431262545,.01444443674,.0159017961,.01772871671,.01474489776,.01280999558,.01220517103,.01190906906,.01197576757,.01314474565,.01475010088,.01212414472,.01051461218,.009996802444,.009711358103,.009723316362,.01077170102,.01191292066,.009778124374,.008391943098,.007831708926,.007399958434,.007365904844,.008059776794,.008782521067,.007061224987,.006022772552,.005622109974,.005249218012,.005053326649,.005458692089,.005740997442,.004543123306,.00380476497,.003402129751,.003036012596,.002836157214,.00291875208,.00288708271,.002093633442,.001635128163,.001354411665,.001031197037,.0007361583583,.0005966154595,.000366973101],B=.4558522322;r(16280),r(908872);function k(e,t){return G(e,t,0)}function G(e,t,r){const a=t[r];if("value"in a)return a.value;const{feature:l,threshold:s,left:n,right:o}=a;return e[l]<=s?G(e,t,o):G(e,t,n)}const P=[{feature:"NUMBER_OF_BLOCK_SOURCES",threshold:.9803883731365204,left:1,right:64},{feature:"NUMBER_OF_BLOCK_SOURCES",threshold:-.02051524817943573,left:2,right:33},{feature:"TITLE_LENGTH",threshold:-.9804741442203522,left:3,right:18},{feature:"BLOCK_SOURCE_frecencyStore",threshold:.5,left:4,right:11},{feature:"PAGE_AUTHORITY_V1",threshold:.9929431676864624,left:5,right:8},{feature:"BLOCK_SOURCE_recentVisit",threshold:.5,left:6,right:7},{value:.055661729574773056},{value:.11489805030510493},{feature:"IS_LAST_EDITED_BY_ME",threshold:.5,left:9,right:10},{value:.1303473491773309},{value:.2761679479597871},{feature:"PAGE_AUTHORITY_V1",threshold:.7070983946323395,left:12,right:15},{feature:"BLOCK_SOURCE_recentVisit",threshold:.5,left:13,right:14},{value:.15403218305273927},{value:.2901420576840293},{feature:"BLOCK_SOURCE_recentVisit",threshold:.5,left:16,right:17},{value:.3969548667754214},{value:.5434689507494647},{feature:"BLOCK_SOURCE_frecencyStore",threshold:.5,left:19,right:26},{feature:"PAGE_AUTHORITY_V1",threshold:-9373319335297929e-20,left:20,right:23},{feature:"BLOCK_SOURCE_recentVisit",threshold:.5,left:21,right:22},{value:.019246861924686193},{value:.0422577337207315},{feature:"MATCHING_PERCENTAGE_OF_TITLE",threshold:.38750000298023224,left:24,right:25},{value:.04463445567238064},{value:.08163417730973187},{feature:"PAGE_AUTHORITY_V1",threshold:.9430259466171265,left:27,right:30},{feature:"BLOCK_SOURCE_recentVisit",threshold:.5,left:28,right:29},{value:.04921499627799959},{value:.11522081288769559},{feature:"BLOCK_SOURCE_recentVisit",threshold:.5,left:31,right:32},{value:.15812057498390902},{value:.26642904878592116},{feature:"TITLE_LENGTH",threshold:-.8644499182701111,left:34,right:49},{feature:"PAGE_AUTHORITY_V1",threshold:.7071063816547394,left:35,right:42},{feature:"TIME_SINCE_LAST_EDIT",threshold:-.9999998509883881,left:36,right:39},{feature:"MATCHING_PERCENTAGE_OF_TITLE",threshold:.7386363744735718,left:37,right:38},{value:.5046524356869184},{value:.6139737991266375},{feature:"MATCHING_PERCENTAGE_OF_TITLE",threshold:.9545454680919647,left:40,right:41},{value:.35265916931762176},{value:.4631217838765009},{feature:"IS_LAST_EDITED_BY_ME",threshold:.5,left:43,right:46},{feature:"BLOCK_SOURCE_teamPage",threshold:.5,left:44,right:45},{value:.5826717293752157},{value:.3459669582118562},{feature:"MATCHING_PERCENTAGE_OF_TITLE",threshold:.9285714328289032,left:47,right:48},{value:.6696084874659657},{value:.7931906286870049},{feature:"PAGE_AUTHORITY_V1",threshold:.7071079015731812,left:50,right:57},{feature:"TIME_SINCE_LAST_EDIT",threshold:-.7071194350719452,left:51,right:54},{feature:"TITLE_LENGTH",threshold:.0027717105112969875,left:52,right:53},{value:.3084340622029064},{value:.20221830985915493},{feature:"TITLE_LENGTH",threshold:.0014528378378599882,left:55,right:56},{value:.19599360481519798},{value:.12874983418294833},{feature:"BLOCK_SOURCE_frecencyStore",threshold:.5,left:58,right:61},{feature:"MATCHING_PERCENTAGE_OF_TITLE",threshold:.3484848588705063,left:59,right:60},{value:.1674727932285369},{value:.2761101463656661},{feature:"MATCHING_PERCENTAGE_OF_TITLE",threshold:.3229166716337204,left:62,right:63},{value:.31311018131101814},{value:.4333284274045184},{feature:"TITLE_LENGTH",threshold:-.8199742436408997,left:65,right:96},{feature:"PAGE_AUTHORITY_V1",threshold:.9987315237522125,left:66,right:81},{feature:"TIME_SINCE_LAST_EDIT",threshold:-.7075438499450684,left:67,right:74},{feature:"TERMS_COUNT_NORMALIZED",threshold:.7859025001525879,left:68,right:71},{feature:"NUMBER_OF_BLOCK_SOURCES",threshold:1.0080004930496216,left:69,right:70},{value:.6666666666666666},{value:.5572065378900446},{feature:"MATCHING_PERCENTAGE_OF_TITLE",threshold:.8090909123420715,left:72,right:73},{value:.730962836028703},{value:.82483781278962},{feature:"TERMS_COUNT_NORMALIZED",threshold:.7750000059604645,left:75,right:78},{feature:"BLOCK_SOURCE_defaultRecordCache",threshold:.5,left:76,right:77},{value:.5598243688254665},{value:.3112244897959184},{feature:"BLOCK_SOURCE_frecencyStore",threshold:.5,left:79,right:80},{value:.48986486486486486},{value:.6522655426765016},{feature:"TIME_SINCE_LAST_EDIT",threshold:-.9759486615657806,left:82,right:89},{feature:"IS_CREATED_BY_ME",threshold:.5,left:83,right:86},{feature:"BLOCK_SOURCE_frecencyStore",threshold:.5,left:84,right:85},{value:.7596830985915493},{value:.8754666411409974},{feature:"TERMS_COUNT_NORMALIZED",threshold:.7750000059604645,left:87,right:88},{value:.8577648766328012},{value:.9412431085265464},{feature:"TERMS_COUNT_NORMALIZED",threshold:.9000000059604645,left:90,right:93},{feature:"MATCHING_PERCENTAGE_OF_TITLE",threshold:.7083333432674408,left:91,right:92},{value:.7364085667215815},{value:.4639175257731959},{feature:"BLOCK_SOURCE_frecencyStore",threshold:.5,left:94,right:95},{value:.7003610108303249},{value:.8495272810115048},{feature:"PAGE_AUTHORITY_V1",threshold:.9999995827674866,left:97,right:112},{feature:"TITLE_LENGTH",threshold:1.0038834810256958,left:98,right:105},{feature:"BLOCK_SOURCE_frecencyStore",threshold:.5,left:99,right:102},{feature:"BLOCK_SOURCE_recentVisit",threshold:.5,left:100,right:101},{value:.18298261665141813},{value:.34929850024189646},{feature:"TIME_SINCE_LAST_EDIT",threshold:-.7071070969104767,left:103,right:104},{value:.5148422178641469},{value:.42366514623021195},{feature:"NUMBER_OF_BLOCK_SOURCES",threshold:1.3351261019706726,left:106,right:109},{feature:"TITLE_LENGTH",threshold:1.4187065362930298,left:107,right:108},{value:.2810958904109589},{value:.14157014157014158},{feature:"BLOCK_SOURCE_frecencyStore",threshold:.5,left:110,right:111},{value:.19499105545617174},{value:.40776554596846176},{feature:"BLOCK_SOURCE_frecencyStore",threshold:.5,left:113,right:120},{feature:"PAGE_AUTHORITY_V1",threshold:1.4150558710098267,left:114,right:117},{feature:"TITLE_LENGTH",threshold:.09616653248667717,left:115,right:116},{value:.5727355901189387},{value:.4002079002079002},{feature:"TITLE_LENGTH",threshold:.36996421217918396,left:118,right:119},{value:.3089700996677741},{value:.10194174757281553},{feature:"PAGE_AUTHORITY_V1",threshold:1.000001072883606,left:121,right:124},{feature:"MATCHING_PERCENTAGE_OF_TITLE",threshold:.22649572789669037,left:122,right:123},{value:.6954795357361027},{value:.7911777488048675},{feature:"TITLE_LENGTH",threshold:-.2670345604419708,left:125,right:126},{value:.7278492480521833},{value:.5908471377647305}],y=["PAGE_AUTHORITY_V1"],w=["TIME_SINCE_LAST_EDIT"],D=["TIME_SINCE_LAST_EDIT","PAGE_AUTHORITY_V1","TITLE_LENGTH","NUMBER_OF_BLOCK_SOURCES"];class K extends Error{constructor(e,t){super(e),this.name="MathError",this.cause=void 0,this.cause=t}}function F(e){if(0===e.length)throw new Error("Can't compute std of an empty array.");const t=(0,u().i2)(e),r=(0,u().cz)(e.map((e=>Math.pow(e-t,2))))/e.length;return Math.sqrt(r)}const x=[function(e){return{name:"NUMBER_OF_BLOCK_SOURCES",value:e.reduce(((e,t)=>{let{name:r,value:a}=t;return void 0!==a&&r.startsWith("BLOCK_SOURCE")?e+a:e}),0)}}];function H(e){return[...e,...x.map((t=>t(e)))]}const V={TIME_SINCE_LAST_EDIT:-.17725330223424154,IS_LAST_EDITED_BY_ME:.16176141450635628,IS_CREATED_BY_ME:.0593282388860205,BLOCK_SOURCE_spacePage:-.1800298837847493,BLOCK_SOURCE_recentVisit:.38019907955270416,BLOCK_SOURCE_bookmarkedPage:.2273554336295929,BLOCK_SOURCE_sharedPage:-.11405912441003871,BLOCK_SOURCE_frecencyStore:.7303811564943883,BLOCK_SOURCE_teamPage:-.3886937481702676,BLOCK_SOURCE_defaultRecordCache:-.08630181620439217,BLOCK_SOURCE_similarUser1dRecentPages:.1516065982402135,BLOCK_SOURCE_topPages7dPageView:.04024980669809112,BLOCK_SOURCE_editedPages1d:-.12760596916369363,BLOCK_SOURCE_similarUsersEditedPages1d:-.209104241796053,BLOCK_SOURCE_offlinePage:0,BLOCK_SOURCE_unknown:0,PAGE_AUTHORITY_V1:.4303514640388112,TITLE_LENGTH:-.4316382562266375,TERMS_COUNT_NORMALIZED:-.1032745452783248,FULL_MATCH_TERM_COUNT_NORMALIZED:.18313025417928205,MATCHING_PERCENTAGE_OF_TITLE:1.0003388486917193,NUMBER_OF_BLOCK_SOURCES:.7940652678793755},Y=-2.48072057;function q(e){const t=e.map((e=>{let{name:t,value:r}=e;return V[t]*(r??0)}));return r=(0,u().cz)([Y,...t]),1/(1+Math.exp(-r/2));var r}function j(e){if(e.some((e=>{let{value:t}=e;return void 0===t})))return 0;const t=(0,h().MU)(e.map((e=>{let{name:t,value:r}=e;return[t,r]}))),r=[P].map((e=>k(t,e)));return(0,u().i2)([...r,q(e)])}var $=()=>r(109054);const z=1.25,Z=[A],W=0;function X(e){const{results:t,featureGroups:r,shouldCalculateRelevancies:a}=e,l=t.map(((e,t)=>{const{block:a,score:l,personalizationBoost:s,rendered:o,terms:u}=e;return{sources:[n().Ni.Local],id:a.blockModel.id,collectionId:a.collectionModel?a.collectionModel.id:void 0,spaceId:a.blockModel.space_id,score:l,localSource:a.source,personalizationBoost:s,terms:u,highlight:{text:o},featureGroups:r[t]}})),s=a?function(e){const t=Z.map(((t,r)=>{const a=e.map((e=>{var t;let{featureGroups:a}=e;return null===(t=a[r])||void 0===t?void 0:t.features}));if(a.some((e=>void 0===e)))return;return function(e){const t=(0,u().mg)(e);for(const s of t)for(const e of s)(0,c().Xk)(y,e.name)?e.value??=0:(0,c().Xk)(w,e.name)&&(e.value=Math.log(e.value??1));const r=new Map,a=new Map,l=new Map;for(const s of t)for(const e of s)if(void 0!==e.value&&(0,c().Xk)(D,e.name)){r.has(e.name)||r.set(e.name,[]);const t=r.get(e.name);t&&t.push(e.value)}for(const[s,n]of r.entries())a.set(s,(0,u().i2)(n)),l.set(s,F(n));for(const s of t)for(const e of s)if((0,c().Xk)(D,e.name)){const t=a.get(e.name),r=l.get(e.name);if(void 0===e.value||void 0===t||void 0===r)throw new K(`Couldn't scale feature ${e.name}`);e.value=0===r?0:(e.value-t)/r}return t}(a.map(H)).map(j)}));if(!t.some((e=>void 0===e)))return(0,u().sn)(t.filter(c().O9))}(l):void 0;return l.map(((e,t)=>({...e,localRelevancies:void 0!==s?s[t]:void 0})))}function J(e,t,r){const a=e=>r.matches(e.block),l=(0,s().qw)(t);if(1===l.length)return e.search(t,{filter:a,prefix:!0,fields:["text","inits"]});const n=e.search(t,{filter:a,combineWith:"AND",fields:["text"]});if(n.length>0)return n;const o=l.filter((e=>e.length>=M().k2)),u=(i=o.length,Math.round(.6*i+.5));var i;return e.search(t,{filter:e=>e.queryTerms.length>=u&&a(e)})}function Q(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function ee(e){const{block:t,score:r,terms:a}=e,{source:l,text:s}=t,o=function(e,t){const r=t.map(Q).join("|"),a=new RegExp(r,"ig");return t.length>0?e.replaceAll(a,`${n().$8}$&${n()._x}`):e}(s,a);var u;return{block:t,rendered:o,score:r,personalizationBoost:(u=l).has("recentVisit")||u.has("frecencyStore")||u.has("bookmarkedPage")||u.has("defaultRecordCache")?z:1,terms:a,minisearchScore:e.minisearchScore??r}}function te(e,t,r){const{blocks:a,getAllBlocks:l}=e,s=r.text.trim(),n=(0,i().dY)(s),u=n.length>0?n.join(" "):s,c=new(_().Zd)(t);return u.length>0?function(e){const{blocksIndex:t,queryString:r,filterMatcher:a}=e,l=J(t,r,a),s=C().zD.isMiniSearchModalEnabled()||"search_frecency_store_new_recency_score"===p().default.getEligibleGroup({experimentId:"search_local_ranking_new_frecency_and_score",defaultGroup:"control"})?{exactMatch:o().gK,prefixMatch:1.5,wordPrefixMatch:1.25,substringMatch:1}:{exactMatch:o().gK,prefixMatch:o().tb,wordPrefixMatch:o().sH,substringMatch:o().qR};return l.map((e=>{const t=(0,M().B1)(r,e.block.text,s);return{...e,score:e.score*t,minisearchScore:e.score}})).map(ee)}({blocksIndex:a,queryString:u,filterMatcher:c}):l().filter((e=>c.matches(e.block))).map(ee)}const re=(0,u().sg)(((e,t)=>{t[0].featureGroups.forEach(((r,a)=>{let{groupName:l}=r;const s=t.map((e=>({features:e.featureGroups[a].features,id:e.id})));(0,d().v)(e,"search_local_result_features",{search_session_id:f().wr(),group_name:l,results_features:s})}))}),1e3,{leading:!1,trailing:!0});function ae(e){let{query:t,localCachedPages:r,userId:l,includeRecordMap:s,environment:n,shouldUseNewRerankerDebugOverrideEnabled:o,spaceStore:i}=e;const{query:c,limit:h}=t,{filters:f,sort:d}=c,T=te(r,f,c),v=C().zD.isMiniSearchModalEnabled()||"search_frecency_store_new_recency_score"===p().default.getEligibleGroup({experimentId:"search_local_ranking_new_frecency_and_score",defaultGroup:"control"});if(0===T.length)return;const S=function(e,t){const{field:r}=e,a="relevance"===r||"desc"===e.direction?-1:1;switch(r){case"lastEdited":case"scroll":return(0,u().Ul)(t,(e=>{let{block:{blockModel:t}}=e;return a*(t.last_edited_time||0)}));case"created":return(0,u().Ul)(t,(e=>{let{block:{blockModel:t}}=e;return a*(t.created_time||0)}));default:return(0,u().Ul)(t,(e=>{let{score:t}=e;return a*t}))}}(d,T),m="relevance"===d.field,M=o||"on"===p().default.getEligibleGroup({experimentId:"search-use-local-reranker-layered",parameter:"shouldUseLocalReranker",defaultGroup:"control"}),L=function(e,t,r,a){const l=new I(t,e,r);return a.map((e=>l.extractFeatureGroup(e)))}(n,v?M?[A,U]:[U]:Z,t.query.text,S),N=X({results:S,featureGroups:L,shouldCalculateRelevancies:M}),b=M&&N.every((e=>{let{localRelevancies:t}=e;return void 0!==t&&t.length>0&&void 0!==t[W]})),B=m?b?(k=W,N.sort(((e,t)=>{let{localRelevancies:r}=e,{localRelevancies:a}=t;return(a??[])[k]-(r??[])[k]}))):v?function(e){const t=e.map((e=>{const t=e.featureGroups.flatMap((e=>e.groupName===U.name?e.features:[])).find((e=>"SEARCH_FRECENCY_SCORE"===e.name)),r=t?t.value:void 0;return r&&(e.score*=r),e}));return(0,u().Ul)(t,(e=>{let{score:t}=e;return-1*t}))}(N):(0,_().Fj)({sort:d,currentUserId:l,unsorted:N,batchSize:R().ZK}):N;var k;let G=B;if(i){const e=(0,g().$e)(i),t=(0,g().jj)(i);t&&e||(G=G.filter((r=>{const l=O().B.createChildStore(i,{table:a().ev,id:r.id});return(0,$().oU)({blockStore:l,shouldShowPeopleCollection:t,shouldShowUserProfiles:e})})))}const P=G.slice(0,h);return(0,E().EG)({results:P,recordMap:r.recordMap}),{total:T.length,results:P,recordMap:s??1?r.recordMap.toJson():{},trackEventProperties:void 0,allMatchingResultIds:B.map((e=>e.id))}}function le(e){let{query:t,localCachedPages:r,parentStore:s,spaceStore:o,isOnline:i,environment:E,shouldLimitLocalResultsWhenOnline:g,canUseLtr:T,shouldUseNewRerankerDebugOverrideEnabled:v}=e;const S=ae({query:t,localCachedPages:r,userId:E.currentUser.id,environment:E,shouldUseNewRerankerDebugOverrideEnabled:v,spaceStore:o});if(!S)return;if(0===S.results.length)return{error:n().yq.NoResults};const I=S.results.map(((e,t)=>({...e,originalPosition:t,store:O().B.createChildStore(s,{table:a().ev,id:e.id}),collectionStore:e.collectionId?m().m.createChildStore(s,{table:l().Vl,id:e.collectionId}):void 0,serverEventProperties:void 0}))),C=i&&g,R=(C?e=>(0,_().kZ)(E,e):e=>e)(I);if(0===R.length)return{error:n().yq.NoResults};const M=I.map((e=>{let{localRelevancies:t}=e;return t})),L=(0,u().sn)(M.filter(c().O9)),A=L.map(u().i2),U=(0,u().sn)(R.map((e=>{let{localRelevancies:t}=e;return t})).filter(c().O9)).map(u().i2),N=M.some(c().O9)?{...(0,h().MU)(L.map(((e,t)=>[`result_relevancies_${t}`,e]))),result_relevancies_means:A,visible_result_relevancy_means:U}:{},b=t.query.text.length>1&&T;return(0,d().v)(E,"search_local_recall_results",{results:I.map(se),search_session_id:f().wr(),num_local_results:R.length,are_results_limited:C,...N}),b&&(re(E,R),p().default.logEvent("visible_local_search_results",R.length,{resultRelevancyV1:A[0],visibleResultRelevancyV1:U[0]})),{value:{total:I.length,totalResultIds:I.map((e=>e.id)),allMatchingResultIds:S.allMatchingResultIds,results:R,debugInfo:void 0}}}function se(e){const{id:t,localSource:r}=e;return{id:t,localSource:[...r??[]]}}}}]);