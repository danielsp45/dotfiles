"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[73801],{503388:(e,t,r)=>{r.d(t,{Jc:()=>g,U8:()=>m,Yj:()=>v,d8:()=>_,dH:()=>I,uC:()=>f});r(16280),r(898992),r(354520),r(581454);var a=()=>r(700500),n=()=>r(416845),o=()=>r(534177),s=()=>r(449506),c=()=>r(899193),i=()=>r(246826),l=()=>r(345913),d=()=>r(898486),p=()=>r(972435),u=()=>r(261450);function m(e){const{environment:t,sourceBlocks:r,targetRecordCache:n,transaction:s,spaceId:c}=e,l=r.map(((e,r)=>i().Wv({environment:t,type:a().xd.copyIndicator,inMemoryRecordCache:n,transaction:s,spaceId:c})));if(l.length!==r.length)throw new Error("copyIndicators must be same length as source blocks");if(!(0,o().EI)(l))throw new Error("copyIndicators must cannot be empty");return l}function v(e){for(const t of e)c().n_(t.id)}function I(e){for(const t of e)c().L7(t.id)}function _(e,t){for(const r of t)c().DW(e,r.id)}function g(e,t){const r=(0,n().op4)(e)?(0,d().DX)(p().A.getIntl(),e):void 0;t.resolve({status:"error",errorMessage:r??p().A.formatMessage(u().V.unknownError),error:e})}function f(e){const{environment:t,copyIndicators:r}=e;s().callApi({eventName:"deleteBlocks",environment:t,data:{blocks:r.filter((e=>e.useCrdt())).map((e=>({id:e.id,spaceId:e.pointer.spaceId}))),permanentlyDelete:!1}}),l().LS({environment:t,blocks:r.filter((e=>!e.useCrdt())),from:"server_duplication_copy_indicators"})}},677733:(e,t,r)=>{r.r(t),r.d(t,{performServerDuplicate:()=>k,serverDuplicate:()=>y,shouldUseDuplicateAndTranslateTemplateBlock:()=>b,shouldUseDuplicateTemplateBlock:()=>M});r(16280),r(944114),r(581454);var a=()=>r(416504),n=()=>r(388821),o=()=>r(763824),s=()=>r(435345),c=()=>r(583835);const i=(0,c().Dv)("duplicateAndTranslateTemplateBlock"),l=(0,c().Dv)("duplicateTemplateBlock");var d=()=>r(466614),p=()=>r(449506),u=()=>r(357625),m=()=>r(898486),v=()=>r(972435),I=()=>r(217429),_=()=>r(261450),g=()=>r(503388),f=()=>r(966152);function y(e){const{environment:t,sourceBlocks:r,targetInMemoryRecordCache:a,transaction:s,options:c,targetSpaceId:i,installationImprint:l,templateInstallationMetadata:d={},shouldUseSynchronousDuplicationAPI:p,stopwatch:u}=e,m=performance.now();null==u||u.mark("server_duplicate_start");const v=e.copyIndicators??(0,g().U8)({environment:t,sourceBlocks:r,targetRecordCache:a,transaction:s,spaceId:i});null==u||u.mark("create_copy_indicators");const I=o().yX();return s.postSubmitCallbacks.push((async e=>{if(null==u||u.mark("transaction_post_submit_callback"),e)return(0,f().P0)({environment:t,type:"server_duplicate_transaction_post_submit_callback_error",data:{copyIndicatorIds:v.map((e=>e.id)),error:e,targetSpaceId:i,options:c}}),void(0,g().Jc)(e,I);(0,g().Yj)(v),null==u||u.mark("initialize_copy_indicators_progress_state");const a=await k({environment:t,copyIndicators:v,sourceBlocks:r,targetSpaceId:i,options:c,templateInstallationMetadata:d,installationImprint:l,shouldUseSynchronousDuplicationAPI:p,stopwatch:u});if(null==u||u.mark("perform_server_duplicate_finished"),(0,f().JW)({environment:t,type:"server_duplicate_duplicate_block_iterator_success",data:{result:a,targetSpaceId:i,options:c}}),(0,g().dH)(v),!a.success)return(0,g().uC)({environment:t,copyIndicators:v}),(0,f().P0)({environment:t,type:"server_duplicate_iterator_error",data:{errorMessage:a.errorMessage}}),void I.resolve({status:"error",errorMessage:a.errorMessage,error:a.error});(0,_().E)({environment:t,success:!0,time:performance.now()-m,user_action:s.getUserActionForAnalyticsPurposesOnly(),is_duplication_local:!1,duplication_size:a.size,method:"server_duplication"}),null==u||u.mark("server_duplicate_success"),I.resolve({status:"success",recordIdMap:a.recordIdMapJson?n().RecordMapPolymorphic.create(a.recordIdMapJson):void 0})})),{blockStores:v,onComplete:I.promise}}async function k(e){const{environment:t,copyIndicators:r,sourceBlocks:n,targetSpaceId:o,options:c,templateInstallationMetadata:d,installationImprint:I,shouldUseSynchronousDuplicationAPI:_,stopwatch:g}=e,f=n[0].spaceId||o,y=n.map((e=>({...e,spaceId:e.spaceId||f}))),k=r.map((e=>({id:e.id,spaceId:e.getSpaceId()}))),w=!!c.resolveTemplateVariables&&{currentUserId:t.currentUser.id,currentTimeZone:(0,a().P)()},S={sourceBlocks:y,targetBlocks:k,addCopyName:c.addCopyName,deepCopyTransclusionContainers:c.deepCopyTransclusionContainers,convertExternalObjectInstancesToPlaceholders:c.convertExternalObjectInstancesToPlaceholders,duplicateOnlyCollectionSchema:c.duplicateOnlyCollectionSchema,createActivities:c.createActivities,resolveTemplateVariables:w,allowRedundancy:c.allowRedundancy},A=M(d.source),B=b(c.shouldTranslate,c.sourceLanguage,c.targetLanguage);let C;if(A)if(_)C=await async function(e){const{environment:t,request:r,stopwatch:a}=e,n=await p().callApi({eventName:"duplicateTemplateBlockSynchronously",environment:t,data:r});if(null==a||a.mark("duplicate_template_synchronous_finished"),"failed"===n.type)return{success:!1,error:n.error,errorMessage:(0,m().A)(v().A.getIntl(),n.error)};return{success:!0,recordIdMapJson:n.data.recordIdMapJson,size:n.data.totalBlocks}}({environment:t,request:{...S,sourceLanguage:c.sourceLanguage,targetLanguage:c.targetLanguage}}),null==g||g.mark("duplicate_template_synchronously_finished");else{const e=u().UT(t,l,{...S,source:d.source,context:d.context,isEmailShared:d.isEmailShared,isFromDuplicateParam:d.isFromDuplicateParam},{spaceIds:[]});C=await h({environment:t,copyIndicators:r,targetSpaceId:o,options:c,duplicateBlockIterator:e}),null==g||g.mark("duplicate_template_finished")}else if(B){const e=u().UT(t,i,{...S,sourceLanguage:c.sourceLanguage,targetLanguage:c.targetLanguage},{spaceIds:[]});C=await h({environment:t,copyIndicators:r,targetSpaceId:o,options:c,duplicateBlockIterator:e}),null==g||g.mark("duplicate_and_translate_template_finished")}else if(_)C=await async function(e){const{environment:t,request:r}=e,a=await p().callApi({eventName:"duplicateBlockSynchronously",environment:t,data:r});if("failed"===a.type)return{success:!1,error:a.error,errorMessage:(0,m().A)(v().A.getIntl(),a.error)};return{success:!0,recordIdMapJson:a.data.recordIdMapJson,size:a.data.size}}({environment:t,request:{...S,installationImprint:I,returnRecordIdMapJson:c.returnRecordIdMap}}),null==g||g.mark("duplicate_block_synchronously_finished");else{const e=u().UT(t,s().w,{...S,installationImprint:I,returnRecordIdMapJson:c.returnRecordIdMap},{spaceIds:[...y.map((e=>e.spaceId)),...k.map((e=>e.spaceId))]});C=await h({environment:t,copyIndicators:r,targetSpaceId:o,options:c,duplicateBlockIterator:e}),null==g||g.mark("duplicate_block_finished")}return C}async function h(e){var t,r;const{environment:a,copyIndicators:n,targetSpaceId:o,options:s,duplicateBlockIterator:c}=e;let i;try{for await(const e of c)(0,f().JW)({environment:a,type:"server_duplicate_duplicate_block_iterator",data:{response:e,targetSpaceId:o,options:s}}),(0,g().d8)(e,n),d().$2(a,e),i=e}catch(u){}if(!i||i.error){var l,p;const e=null!==(l=i)&&void 0!==l&&l.error?(0,m().A)(v().A.getIntl(),i.error):v().A.formatMessage(_().V.unknownError);return{success:!1,error:(null===(p=i)||void 0===p?void 0:p.error)??new Error(e),errorMessage:e}}return{success:!0,recordIdMapJson:null===(t=i)||void 0===t?void 0:t.value.recordIdMapJson,size:(null===(r=i)||void 0===r?void 0:r.value.totalBlocks)??0}}function M(e){if(!e)return!1;const t=I().default.getConfigKey("enabled_installation_sources_for_duplicate_template_block",e);return Boolean(t)}function b(e,t,r){return Boolean(e&&t&&r)&&I().default.checkGate({gateName:"translate_template_top_bar"})}},966152:(e,t,r)=>{r.d(t,{JW:()=>o,P0:()=>s});var a=()=>r(857639),n=()=>r(217429);function o(e){const{environment:t,type:r,data:a}=e;c({environment:t,level:"info",from:"duplicateActions",type:r,data:a})}function s(e){const{environment:t,type:r,data:a}=e;c({environment:t,level:"warning",from:"duplicateActions",type:r,data:a})}function c(e){const{environment:t,level:r,from:o,type:s,data:c}=e,i=n().default.getConfigKey("page_template_duplication_verbose_logging_config","userIds");t.currentUser.id&&i.includes(t.currentUser.id)&&a().log({level:r,from:o,type:s,data:c})}}}]);