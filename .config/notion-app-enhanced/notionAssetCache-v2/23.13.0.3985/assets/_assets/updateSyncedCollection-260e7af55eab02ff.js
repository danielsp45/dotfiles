"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[70522],{748768:(e,t,o)=>{o.r(t),o.d(t,{toggleTwoWaySyncOnCollection:()=>_,updateSyncedData:()=>g});o(16280),o(898992),o(672577);var n=()=>o(282883),i=()=>o(179034),r=()=>o(343666),c=()=>o(919709),a=()=>o(312296),l=()=>o(789557),s=()=>o(972435),d=()=>o(252833),p=()=>o(630116),u=()=>o(449506),m=()=>o(896628),v=()=>o(436572),y=()=>o(751156);function _(e){var t;const{environment:o,taskCollectionStore:i,projectCollectionStore:r}=e,c=!(null===(t=i.getFormat().sync_state)||void 0===t?void 0:t.enable_two_way_sync);c&&function(e){const{environment:t,taskCollectionStore:o}=e,i=o.getSchema(),r={};for(const c of n().En){const e=i[c];e&&"read_write"!==e.synced_permissions&&("notion://tasks/assign_property"===c&&"person"===e.type?r[c]={...e,synced_permissions:"read_write",limit:1}:r[c]={...e,synced_permissions:"read_write"})}Object.keys(r).length>0&&y().createAndCommit({userAction:"updateSyncedCollectionActions.addSyncedPermissionsToSchema",environment:t,canUndo:!0,perform:e=>{(0,a().F)({environment:t,collectionStore:o,update:r,transaction:e})}})}({environment:o,taskCollectionStore:i});const l=i.getFormat().sync_state||{syncing:!1};y().createAndCommit({userAction:"updateSyncedCollectionActions.toggleTwoWaySyncOnCollection",environment:o,canUndo:!0,perform:e=>{m().zA({stores:[i,r],update:{sync_state:{...l,enable_two_way_sync:c}},transaction:e})}})}async function g(e){const{transaction:t,environment:o}=e,a=t.operations.find((e=>(0,d().C0)(e)&&2===e.path.length&&"properties"===e.path[0]&&n().En.includes(e.path[1].toString())));if(a){const e=(0,d().sP)({transaction:t,updateOperation:a,environment:o});if(!e)return;return void(await async function(e){const{transaction:t,environment:o,updateOperation:n,syncedCollectionStore:i}=e,r=()=>{try{return(0,d().jg)({updateOperation:n,transaction:t,collectionStore:i})}catch(e){throw f({}),e}},c=r();if("UPDATE_PROPERTY"===c.syncCollectionUpdates[0].updateType){const e=d().vT({pageId:c.syncCollectionUpdates[0].collectionPagePointer.id,propertyId:c.syncCollectionUpdates[0].propertyId});d().Jv({uniquePropertyId:e});const t=await u().callApi({eventName:"updateSyncedCollectionData",environment:o,data:c});if(d().NW(e),"success"===t.type){if(t.data.success)return;var a;throw f({errorCode:t.data.errorCode,syncCollectionType:i.getFormat().external_collection_type,propertyName:1===c.syncCollectionUpdates.length?null===(a=i.getSchema()[c.syncCollectionUpdates[0].propertyId])||void 0===a?void 0:a.name:void 0}),new Error(t.data.message)}var l;throw f({syncCollectionType:i.getFormat().external_collection_type}),new Error((null===(l=t.error)||void 0===l||null===(l=l.name)||void 0===l?void 0:l.toString())??"Unknown error")}}({transaction:t,environment:o,updateOperation:a,syncedCollectionStore:e}))}const s=t.operations.find((e=>"set"===e.command&&1===e.path.length&&"text"===e.path[0]));if(s&&s.pointer.table===r().SN){const e=(0,d().cb)({transaction:t,commentPointer:s.pointer,environment:o});if(!e)return;const{collectionStore:n,collectionPagePointer:i}=e;return void(await async function(e){const{transaction:t,environment:o,updateOperation:n,syncedCollectionStore:i,collectionPagePointer:r}=e,c=()=>{try{return(0,d().mE)({updateOperation:n,transaction:t,collectionStore:i,collectionPagePointer:r})}catch(e){throw f({}),e}},a=c();d().L$({commentId:n.pointer.id});const l=await u().callApi({eventName:"updateSyncedCollectionData",environment:o,data:a});if(d().Rw(n.pointer.id),"success"===(null==l?void 0:l.type)){if(l.data.success)return;throw f({errorCode:l.data.errorCode,syncCollectionType:i.getFormat().external_collection_type}),new Error(l.data.message)}var s;throw f({syncCollectionType:i.getFormat().external_collection_type}),new Error((null===(s=l.error)||void 0===s||null===(s=s.name)||void 0===s?void 0:s.toString())??"Unknown error")}({transaction:t,environment:o,updateOperation:s,syncedCollectionStore:n,collectionPagePointer:i}))}const m=t.operations.find((e=>{var t;return"update"===e.command&&1===e.path.length&&"properties"===e.path[0]&&(null===(t=e.args)||void 0===t?void 0:t.source)}));if(m){const e=(0,d().m0)({transaction:t,updateOperation:m,environment:o});if(!e)return;try{await async function(e){var t;const{transaction:o,environment:n,updateOperation:i,syncedCollectionStore:r,collectionPagePointer:a,commentPointer:l}=e,s=c().q4_(null===(t=i.args)||void 0===t?void 0:t.source);if(!s)return;const d=s.split(":").pop();if(!d)return;const p=r.getFormat().external_collection_type;if(!p)throw f({}),new Error("Collection is not an external synced collection");const m={spaceId:o.spaceId,syncType:p,syncCollectionUpdates:[{collectionPagePointer:a,notionCommentId:l.id,attachment:{fileName:d,s3Data:{path:s}},updateType:"APPEND_ATTACHMENT"}]},v=await u().callApi({eventName:"updateSyncedCollectionData",environment:n,data:m});if("success"===(null==v?void 0:v.type)){if(v.data.success)return;throw f({errorCode:v.data.errorCode,syncCollectionType:r.getFormat().external_collection_type}),new Error(v.data.message)}var y;throw f({syncCollectionType:r.getFormat().external_collection_type}),new Error((null===(y=v.error)||void 0===y||null===(y=y.name)||void 0===y?void 0:y.toString())??"Unknown error")}({transaction:t,environment:o,updateOperation:m,syncedCollectionStore:e.collectionStore,collectionPagePointer:e.collectionPagePointer,commentPointer:e.commentPointer})}catch(v){const n=new(p().jg)(o,e.commentPointer),r=new(p().Bv)(o,{id:m.pointer.id,table:i().ev,spaceId:t.spaceId});throw n&&r&&y().createAndCommit({userAction:"Comment.handleRemoveFileFromActionsDueToSyncFailure",environment:o,canUndo:!0,perform:e=>{l().L6({commentStore:n,fileBlocks:[r],transaction:e})}}),v}}else;}function f(e){const{errorCode:t,syncCollectionType:o,propertyName:n}=e,i=s().A.getIntl();if(!o)return void v().yq({item:{label:i.formatMessage({id:"syncedCollectionUpdateError.syncCollectionTypeMissing",defaultMessage:"Failed to update: incorrect sync collection setup"})}});if(!t)return void v().yq({item:{label:`Failed to update ${n??o}`}});const r=d().LA({syncCollectionType:o,errorCode:t,intl:i});v().yq({item:{label:r}})}},789557:(e,t,o)=>{o.d(t,{DZ:()=>F,E3:()=>A,L6:()=>E,QA:()=>k,Tu:()=>I,lV:()=>x});o(944114),o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698),o(898992),o(354520),o(803949);var n=()=>o(908006),i=()=>o(785082),r=()=>o(955825),c=()=>o(496603),a=()=>o(878523),l=()=>o(112873),s=()=>o(722101),d=()=>o(246826),p=()=>o(620689),u=()=>o(255460),m=()=>o(319975),v=()=>o(751156),y=()=>o(892632),_=()=>o(299545),g=()=>o(906537),f=()=>o(630116),S=()=>o(606846),C=()=>o(374026),w=()=>o(807060),h=()=>o(337090),P=()=>o(855821),T=()=>o(741817),b=()=>o(301523);function k(e){var t,o;const{environment:n,store:r,text:c,files:l,transaction:s,discussionLocation:d,property_id:p,blockStore:u}=e,v=_().eK(r);if(!v)return;const{filesToCreate:y,fileStoresToDelete:g}=function(e,t){const o=[],n=new Set;t.forEach((e=>{"local"===e.type?o.push(e.file):n.add(e.id)}));const i=_().dd(e),r=i.filter((e=>e.getAlive()&&!n.has(e.id)));return{filesToCreate:o,fileStoresToDelete:r}}(r,l);E({commentStore:r,fileBlocks:g,transaction:s}),(0,P().t)({commentStore:r,files:y,environment:n,transaction:s});const f=_().gp(r);m().R9({environment:n,store:f,value:c,transaction:s}),(0,b().x)(r,s);const C=null==r||null===(t=r.getParentStore())||void 0===t?void 0:t.getParentStore(),h=i().eR.includes(d),T=null==v||null===(o=v.getParentStore())||void 0===o?void 0:o.getNavigableBlockStore(),{property_type:k,collection_id:I,collection_view_id:A,view_type:x,collection_view_block_id:F}=(0,w().q)(p,u);a().ZM(n,{from:d,comment_id:r.id,discussion_id:v.id,discussion_type:v.getType(),parent_block_id:v.getParentId(),parent_collection_id:null==C?void 0:C.getParentCollectionIdUpToTwoLevels(),...h&&{inbox_session_id:S().Ay.state.sessionId,notification_page_id:null==T?void 0:T.id},property_type:k,collection_id:I,collection_view_id:A,view_type:x,collection_view_block_id:F})}function I(e){var t,o;const{environment:n,commentStore:r,transaction:c,discussionLocation:l}=e,s=_().eK(r);if(!s)return;const p=_().uB(s),u=p.getValue();if(!u)return;E({commentStore:r,fileBlocks:_().dd(r),transaction:c}),d().zv({store:r,transaction:c,data:{alive:!1}}),v().applyOperation({store:p,operation:{pointer:p.pointer,path:p.path,command:"listRemove",args:{id:r.id}},transaction:c}),(0===u.length||1===u.length&&u[0]===r.id)&&(0,T().v)({environment:n,discussionStore:s,transaction:c}),(0,b().x)(r,c);const m=i().eR.includes(l),y=null==s||null===(t=s.getParentStore())||void 0===t?void 0:t.getNavigableBlockStore();a().gN(n,{from:e.discussionLocation,discussion_id:s.id,discussion_type:s.getType(),comment_id:r.id,parent_block_id:s.getParentId(),parent_collection_id:null===(o=s.getParentStore())||void 0===o?void 0:o.getParentCollectionIdUpToTwoLevels(),...m&&{inbox_session_id:S().Ay.state.sessionId,notification_page_id:null==y?void 0:y.id}})}function A(e){var t,o;const{environment:n,commentStore:r,discussionStore:c,transaction:l,discussionLocation:s}=e;d().zv({store:c,data:{resolved:!1},transaction:l});const p=i().eR.includes(s),u=null==c||null===(t=c.getParentStore())||void 0===t?void 0:t.getNavigableBlockStore();a().Jg(n,{comment_id:r.id,discussion_id:c.id,from:e.discussionLocation,parent_block_id:c.getParentId(),parent_collection_id:null===(o=c.getParentStore())||void 0===o?void 0:o.getAssociatedCollectionId(),...p&&{inbox_session_id:S().Ay.state.sessionId,notification_page_id:null==u?void 0:u.id}})}function x(e){var t,o;const{environment:n,discussionStore:r,textValue:l,transaction:s,files:d,property_id:p,blockStore:u}=e,{id:m}=n.currentUser;if(!m)return;const v=y().JC(d);if(c().n4(l,[])&&0===v.length)return;const _=(0,h().G)({discussionStore:r,text:l,files:v,markDiscussionRead:!0,environment:n,transaction:s}),g=i().eR.includes(e.discussionLocation),f=null===(t=r.getParentStore())||void 0===t?void 0:t.getNavigableBlockStore(),{property_type:C,collection_id:P,collection_view_id:T,view_type:b,collection_view_block_id:k}=(0,w().q)(p,u);a().mw(n,{from:e.discussionLocation,comment_id:_.id,discussion_id:r.id,discussion_type:r.getType(),parent_block_id:r.getParentId(),parent_collection_id:null==r||null===(o=r.getParentStore())||void 0===o?void 0:o.getParentCollectionIdUpToTwoLevels(),...g&&{inbox_session_id:S().Ay.state.sessionId,notification_page_id:null==f?void 0:f.id},property_type:C,collection_id:P,collection_view_id:T,view_type:b,collection_view_block_id:k})}function E(e){const{commentStore:t,fileBlocks:o,transaction:n}=e,i=_().eP(t);o.forEach((e=>{d().zv({store:e,data:{alive:!1},transaction:n}),s().TF({parentStore:i,childToRemoveStore:e,transaction:n})}))}async function F(e){var t;let{discussionStore:o,currentBlockStore:i,environment:c,analyticsFrom:a,currentEl:s}=e;if(!i)return null;if(!o.isDefined())return;function d(e){const t=(0,C().S)({discussionId:o.id,blockId:e});if(!t)return;const n=document.getElementsByClassName((0,r().wV)({discussionId:o.id}))[0];return n?p().hT({element:n,environment:c,scrollerContext:t.getScrollerContext(),vertical:{reveal:"top"},horizontal:{reveal:"closest"},animate:!0}):p().pb({environment:c,handle:t,vertical:{reveal:"top"},horizontal:{reveal:"closest"},animate:!0}),t.displaySelectionHalo(750),t}const m=(null===(t=o.getRecordStoreUIParent())||void 0===t?void 0:t.id)??o.getParentId();d(m)||(await u().NH(i,[m]),await n().default.afterNextFlush(),d(m));const v=f().Bv.createChildStore(i,o.getParentPointer()),y=g().get(),_=null==y?void 0:y.commonAncestorContainer,S=!(null!=y&&y.collapsed)&&_&&(s===_||(null==s?void 0:s.contains(_)));l().B4({environment:c,blockStore:v||i,analyticsFrom:a,discussionIds:[o.id],shouldFocusDiscussion:!S,recursivelyLoadAllDiscussions:!1})}}}]);