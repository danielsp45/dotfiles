"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[25583],{73928:(t,e,n)=>{n.r(e),n.d(e,{TldrawAdapter:()=>tt});n(16280),n(18107),n(944114),n(898992),n(354520),n(672577),n(581454),n(737550);var o=()=>n(875954),r=()=>n(351084),s=()=>n(696521),i=n(296540),a=()=>n(484714),l=()=>n(401497),d=(n(517642),n(658004),n(733853),n(845876),n(432475),n(515024),n(731698),()=>n(534177)),c=()=>n(738182);function*u(t){for(const[e,n]of(0,d().WP)(t.added))yield[e,[void 0,n]];for(const[e,n]of(0,d().WP)(t.updated))yield[e,n];for(const[e,n]of(0,d().WP)(t.removed))yield[e,[n,void 0]]}class p{constructor(){this.added={},this.removed=new Set}static fromSerializedSnapshot(t){const e=new p;return e.mergeSnapshot(t),e}add(t){this.added[t.id]=t,this.removed.delete(t.id)}remove(t){delete this.added[t],this.removed.add(t)}ignore(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];for(const o of e)delete this.added[o],this.removed.delete(o)}mergeSnapshot(t){for(const[e,n]of(0,d().WP)(t))n?this.add(c().v.deserialize(n)):this.remove(e)}hasChanges(){return this.removed.size>0||Object.keys(this.added).length>0}}class h{constructor(){this.pendingChanges=[]}getPendingIds(){if(0===this.pendingChanges.length)return new Set;this.pendingChanges.length>1&&(this.pendingChanges=[this.clear()]);const[t]=this.pendingChanges,e=new Set;for(const[n]of u(t))e.add(n);return e}add(t){this.pendingChanges.push(t)}clear(){const t=(0,s().Dm)(this.pendingChanges);return this.pendingChanges=[],t}}var g=()=>n(959013),m=()=>n(319625),f=()=>n(496603),b=()=>n(939768),v=()=>n(720665),y=()=>n(901389),w=()=>n(246826),x=()=>n(751156),k=()=>n(381349),S=()=>n(284371),_=n(474848);function I(){const t=(0,l().DP)(),e=(0,i.useMemo)((()=>{const e="3px",n=k().Ay.blueWithAlpha(1),o="dark"===t.mode;return{"--color-text":t.text.primary,"--color-text-0":t.text.primary,"--color-text-1":t.text.primary,"--color-text-2":t.text.secondary,"--color-text-3":t.text.tertiary,"--color-accent":t.palette.red[800],"--color-focus":k().Ay.blueWithAlpha(.14),"--color-selection-stroke":n,"--color-selection-fill":k().Ay.blueWithAlpha(.025),"--color-brush-stroke":"transparent","--color-brush-fill":k().Ay.blueWithAlpha(.14),"--color-muted-2":t.buttonHoveredBackground,"--color-selected":n,"--color-selected-contrast":t.contentBackground,"--color-text-selection":k().Ay.blueWithAlpha(.28),"--color-primary":t.blueButtonBackground,"--color-warn":k().Ay.red,"--radius-0":e,"--radius-1":e,"--radius-2":e,"--radius-3":e,"--radius-4":e,"--color-low":t.popoverBackground,"--opacity-low":.93,"--radius-5":"6px","--color-panel":t.popoverBackground,"--color-panel-contrast":"transparent","--color-divider":t.regularDividerColor,"--shadow-2":t.shadowMD,"--color-background":t.contentBackground,"--palette-black":t.palette.gray[900],"--palette-blue":o?t.palette.blue[800]:t.palette.blue[500],"--palette-green":o?t.palette.green[800]:t.palette.green[500],"--palette-grey":o?t.palette.gray[700]:t.palette.gray[300],"--palette-light-blue":o?t.palette.blue[500]:t.palette.blue[200],"--palette-light-green":o?t.palette.green[500]:t.palette.green[300],"--palette-red":o?t.palette.red[800]:t.palette.red[500],"--palette-light-red":o?t.palette.red[500]:t.palette.red[300],"--palette-violet":o?t.palette.purple[800]:t.palette.purple[500],"--palette-light-violet":o?t.palette.purple[500]:t.palette.purple[300],"--palette-orange":o?t.palette.orange[700]:t.palette.orange[500],"--palette-yellow":o?t.palette.yellow[800]:t.palette.yellow[500],"--palette-white":t.contentBackground}}),[t]),n=(0,i.useMemo)((()=>{let t=".rs-container {";for(const[n,o]of Object.entries(e))void 0!==o&&(t+=`\n  ${n}: ${o};`);return t+="\n}",t+=`\n\t\t.tlui-button {\n\t\t\ttext-shadow: none;\n\t\t}\n\n\t\t.tlui-slider__range {\n\t\t\tbackground: var(--color-selection-stroke);\n\t\t}\n\n\t\t/* Try to make menu items look like Notion menu items */\n\t\t.tlui-menu__button {\n\t\t\theight: 28px;\n\t\t\tline-height: 150%;\n\t\t\tfont-size: ${S().J.UIRegular.desktop}px;\n\t\t\tpadding: 0 12px;\n\t\t}\n\n\t\t.tlui-menu__checkbox-item {\n\t\t\tpadding-left: 28px;\n\t\t}\n\n\t\t.tlui-menu__checkbox-item__check .tlui-icon__small {\n\t\t\twidth: 18px;\n\t\t\theight: 18px;\n\t\t}\n\n\t\t.tlui-menu__button::after {\n\t\t\twidth: calc(100% - 8px);\n\t\t\theight: 100%;\n\t\t\tleft: 4px;\n\t\t\tright: 4px;\n\t\t\tbottom: 0;\n\t\t\ttop: 0;\n\t\t}\n\n\t\t.tlui-menu__button:nth-child(n + 2) {\n\t\t\tmargin-top: 0;\n\t\t}\n\n\t\t.tlui-menu__button:nth-last-child(n + 2) {\n\t\t\tmargin-bottom: 0;\n\t\t}\n\n\t\t.tlui-menu__group {\n\t\t\tpadding: 4px 0;\n\t\t}\n\n\t\t.tlui-menu__group[data-size='medium'] {\n\t\t\tmin-width: 200px;\n\t\t}\n\n\t\t/* Styling for how keyboard shortcuts are rendered next to menu items */\n\t\t.tlui-kbd {\n\t\t\tfont-size: ${S().J.UISmall.desktop}px;\n\t\t\tcolor: var(--color-text-3);\n\t\t\tdisplay: flex;\n\t\t\tgap: 0;\n\t\t}\n\n\t\t.tlui-kbd > span {\n\t\t\tpadding: 0;\n\t\t\tmargin: 0;\n\t\t}\n\n\t\t.tlui-kbd span + span::before {\n\t\t\tcontent: '+';\n\t\t}\n\n\t\t.rs-error-boundary__content .rs-error-boundary__refresh {\n\t\t\tcolor: var(--color-background);\n\t\t}\n\n\t\t/* Styling for the Tools panel */\n\t\t.tlui-toolbar__tools {\n\t\t\tborder-radius: 999px;\n\t\t\tpadding: 0 8px;\n\t\t}\n\n\t\t.tlui-button {\n\t\t\t--color-selected: transparent;\n\t\t\t--color-selected-contrast: var(--color-selection-stroke);\n\t\t}\n\n\t\t.tlui-button:not(:disabled):hover::after {\n\t\t\tbackground: var(--color-muted-2);\n\t\t}\n\n\t\t/* Styling for "low" toolbars like the top bar and zoom */\n\t\t.tlui-menu-zone::before,\n\t\t.tlui-navigation-zone,\n\t\t.tlui-navigation-zone::before,\n\t\t.tlui-debug-panel {\n\t\t\tborder: none;\n\t\t\tborder-radius: var(--radius-5);\n\t\t\topacity: var(--opacity-low);\n\t\t}\n\n\t\t.tlui-menu-zone::before,\n\t\t.tlui-navigation-zone::before,\n\t\t.tlui-debug-panel\n\t\t{\n\t\t\tinset: 0;\n\t\t\tbox-shadow: var(--shadow-1);\n\t\t}\n\n\t\t.tlui-help-menu__button {\n\t\t\tdisplay: none;\n\t\t}\n\t\t.tlui-help-menu__button::before  {\n\t\t\tbox-shadow: var(--shadow-1);\n\t\t\topacity: var(--opacity-low);\n\t\t}\n\n\t\t/* Styling for extra-small width controls */\n\t\t.tlui-toolbar__extras__controls {\n\t\t\tmargin-left: 20px;\n\t\t}\n\n\t\t.tlui-toolbar__extras__controls,\n\t\t.tlui-toolbar__extras__controls::before\n\t\t{\n\t\t\tborder: none;\n\t\t\tborder-radius: 12px;\n\t\t\tborder-bottom-left-radius: 0px;\n\t\t\tborder-bottom-right-radius: 0px;\n\t\t}\n\n\n\t\t.tlui-toolbar__extras__controls::before {\n\t\t\tinset: 0;\n\t\t\tbox-shadow: var(--shadow-1);\n\t\t}\n\n\t\t/* Make dialogs fit */\n\t\t.tlui-dialog__content {\n\t\t\tmax-height: 80%;\n\t\t}\n\n\t\t/* Hide the "Page" menu */\n\t\t.tlui-popover:has(.tlui-page-menu__trigger) {\n\t\t\tdisplay: none;\n\t\t}\n\n\t\t.tlui-popover:has(.tlui-page-menu__trigger) + .tlui-menu-zone__divider {\n\t\t\tdisplay: none;\n\t\t}\n\n\t\t/* Disable spurious text selection */\n\t\t.rs-container input, *[contenteditable] .rs-container, *[contenteditable] .rs-container * {\n\t\t\tuser-select: none;\n\t\t\t-webkit-user-select: none;\n\t\t}\n\n\t\t/* Style text selection inside text components */\n\t\t.rs-text-input::selection {\n\t\t\tbackground: var(--color-text-selection);\n\t\t\tcolor: currentColor;\n\t\t\ttext-shadow: none;\n\t\t}\n\t\t`,{__html:t}}),[e]);return(0,_.jsx)("style",{dangerouslySetInnerHTML:n})}var A=()=>n(371990),C=()=>n(56366),z=()=>n(921997),M=()=>n(798880),E=()=>n(352733),V=()=>n(365233),D=()=>n(498212),P=()=>n(638681),T=()=>n(941541),j=()=>n(630116);const B=!1;function N(){if(B){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];console.log("[drawing] presence:",...e)}}const F=3*v().Xb,U=Number(v().TD),W=P().literal(0),R=P().record(P().string(),P().union([W,P().string()])),O=P().record(P().string(),P().union([W,R]));function L(t){const{blockStore:e,app:n}=t,o=(0,a().v3)(),r=(0,g().tz)(),s=e.userId,l=e.id,m=(0,z().vB)(l),b=null==n?void 0:n.instanceId,v=null==n?void 0:n.store,y=(0,C().K8)((()=>Boolean(n&&b&&s&&l&&(0,V().A)(m)&&e.canEdit())),[n,l,e,m,b,s]);(0,i.useEffect)((()=>{if(!(y&&n&&b&&s&&v))return;const t=new h,i=T().Ay.addListener(m,void 0,(function(n){let{value:o}=n;!function(t){const{blockStore:e,tldrawStore:n,maybePresenceData:o,pendingChanges:r,intl:s}=t;o||N("presence data is empty",o);let i;try{i=(0,E().n)(O,o)}catch(c){return void N("invalid presence data",c)}const a=new p;for(const[u,p]of(0,d().WP)(i))u!==e.userId&&p&&a.mergeSnapshot(p);if(a.ignore(...r.getPendingIds()),!a.hasChanges())return;const l=Object.values(a.added);for(const d of l)if(A().dVE.isInstance(d)){const{userId:t}=d,n=t.split(":",2)[1];if(n&&(0,D().uj)(n)){const o=j().sk.createChildStore(e,{table:M().oo,id:n}).getDisplayName(s);a.add(A().i5Z.create({id:t,name:o}))}}n.mergeRemoteChanges((()=>{N("Notion -> Tldraw",a),n.put(Object.values(a.added)),n.remove(Array.from(a.removed))}))}({blockStore:e,tldrawStore:v,maybePresenceData:o,pendingChanges:t,intl:r})}),b,o),a=f().nF((()=>{const n=t.clear();!function(t){const{environment:e,blockStore:n,diff:o}=t,{userId:r}=n;if(!r)return;const s=(0,z().vB)(n.id),i={};let a=!1;for(const[l,[,d]]of u(o))if(K(l)){a=!0;const t=d?c().v.serialize(d):0;i[l]=t}if(!a)return;N("Tldraw -> Notion",i),T().Ay.updateField({key:s,field:r,updates:i,ttl:F,environment:e})}({environment:o,blockStore:e,diff:n})}),U),l=v.listen((function(e){let{changes:n,source:o}=e;"user"===o&&(t.add(n),a())}));return T().Ay.onDisconnect(m,[{operation:"setField",key:m,field:s,value:0,ttl:F}],b,o),N("subscribed",m,b),()=>{N("disposed",m,b),l(),i&&T().Ay.removeListener(i,o),T().Ay.setField({key:m,field:s,value:0,ttl:F,environment:o}),T().Ay.clearOnDisconnect(m,b,o)}}),[y,e.id,m,b,o,e,r,n,s,v])}const $=[A().dVE,A().wOc,A().koU];function K(t){return $.some((e=>e.isId(t)))}const H=!1,Z=2*v().TD,q=r().i5Z.createId(),J=(0,n(904676).Z)({format:t=>t}),Y=(0,n(604341).exposeDebugValue)("drawings",{});function G(){if(H){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];console.log("[drawing]",...e)}}function X(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];G("Notion -> Tldraw:",...e)}function Q(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];G("Tldraw -> Notion:",...e)}function tt(t){const{store:e}=t,n="dark"===(0,l().DP)().mode,[o,p]=(0,i.useState)(void 0),v=(0,i.useCallback)((t=>{p(t)}),[]);(0,i.useEffect)((()=>{o&&(t.disabled?o.enableReadOnlyMode():o.updateUserDocumentSettings({isReadOnly:!1}))}),[o,t.disabled]);const k=(0,i.useRef)();(0,i.useEffect)((()=>{var e,n;t.isEditing?(null==o||o.focus(),null==o||o.updateInstanceState({isFocusMode:(null===(e=k.current)||void 0===e?void 0:e.isFocusMode)??!1}),null==o||o.setSelectedIds((null===(n=k.current)||void 0===n?void 0:n.shapeIds)??[])):o&&(k.current={shapeIds:o.selectedIds,isFocusMode:o.instanceState.isFocusMode},o.blur(),o.updateInstanceState({isFocusMode:!0}),o.setSelectedTool("hand"),o.selectNone())}),[o,t.isEditing]),(0,i.useEffect)((()=>{o&&requestAnimationFrame((()=>{it.call(o,{inset:0,include:[o.viewportPageBounds]})}))}),[o]);const S=(0,i.useCallback)((t=>{throw y().f1((0,_.jsx)(g().sA,{id:"drawing.images-not-supported",defaultMessage:"Images are not supported in drawings yet"})),new Error("Image assets are not supported yet.")}),[]),A=function(){const t=r().UFg.default;if(!lt){lt=!0;const e=t.TLShape.validate;t.TLShape.validate=function(t){const n=e.call(this,t);return n.props&&"url"in n.props&&n.props.url&&(n.props.url=(0,b().q7)(n.props.url)??"https://www.notion.so/product"),n}}return t}(),{syncedStore:C,userId:z,instanceId:M}=function(t){let{store:e,config:n}=t;const o=(0,a().v3)(),[l]=(0,i.useState)((()=>et)),p=(0,i.useMemo)((()=>{const t=e.userId;return t?r().i5Z.createCustomId(t):q}),[e.userId]),g=(0,i.useMemo)((()=>{const t=`tab/${l}/store/${e.key}`;return r().koU.createCustomId(t)}),[l,e.key]),[b,v]=(0,i.useState)(null);(0,i.useEffect)((()=>{const t=`block/${e.id}/store/${e.key}/effect/${nt++}`;G("initialize",t,{userId:p,instanceId:g}),v({id:t,syncedStore:{status:"loading"}});const r=e=>{v((n=>(null==n?void 0:n.id)===t?{id:t,syncedStore:e}:n))},i=n.createStore({userId:p,instanceId:g}),a=t=>{const e=(0,s()._e)(i.schema.serialize(),t);if(0===e)return;const n=new Error(e<0?"This drawing is from a newer version of Notion. Update Notion to edit it.":"This drawing is from an older version of Notion. Reload to edit it.");throw X("schema mismatch",{error:n,incomingSchema:t,ourSchema:i.schema.serialize()}),r({status:"error",error:n}),n},l=e.getDrawingStore(),b=e.getKeyStore("version"),y={drawingStore:l,schemaStore:l.getKeyStore("schema"),snapshotStore:l.getKeyStore("snapshot"),typeStore:l.getKeyStore("type"),getLastVersion:()=>b.isReady()?b.getValue()??-1:-1};let k=!1;const S=new h,_=()=>{if(k)return void X("skip update: ignoreNotionUpdates");const t=y.drawingStore.getValue();t?(t.schema&&a(t.schema),i.mergeRemoteChanges((()=>{const e=S.getPendingIds(),n=[],o=[];for(const[r,s]of(0,d().WP)(t.snapshot||{}))e.has(r)?X("skip record: ahead:",{id:r}):s?o.push(c().v.deserialize(s)):n.push(r);X("apply updates",{removedIds:n,updatedRecords:o,pendingDiffIds:e}),i.remove(n),i.put(o)}))):X("skip update: no Notion drawingValue")},I=function(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const n=S.clear(),s=y.getLastVersion();x().createAndCommit({environment:o,userAction:"drawing.persist",canUndo:!0,userId:e.userId,perform(e){try{k=!0,Q("begin persist",{squashed:n,initialVersion:s});const o=l.getValue();if(o&&"tldraw"!==o.type){const t=Error(`Unknown drawing value type: ${o.type}`);throw r({status:"error",error:t}),t}if(y.typeStore.isReady()&&!y.typeStore.getValue()){const t="tldraw";Q("persist type:",t),w().KY({store:y.drawingStore,value:{type:t},transaction:e})}const p=y.schemaStore.getValue(),h=t||y.schemaStore.isReady()&&!p;if(h){const t=i.schema.serialize();Q("persist schema:",t),w().KY({value:t,store:y.schemaStore,transaction:e})}p&&!t&&a(p);let g={},m=!1;const f=h||y.snapshotStore.isReady()&&!y.snapshotStore.getValue();f&&(m=!0,g=Object.fromEntries((0,d().WP)(i.serialize()).filter((t=>{let[e]=t;return ot(e)})).map((t=>{let[e,n]=t;return[e,c().v.serialize(n)]}))));for(const[t,[,e]]of u(n))ot(t)&&(m=!0,g[t]=e?c().v.serialize(e):0);m&&(Q("persist snapshot update:",g,f),w().zv({store:y.snapshotStore,transaction:e,data:g}))}finally{k=!1,Q("end persist",{initialVersion:s,finalVersion:y.getLastVersion()})}}})},A=f().nF(I,Z),C=t=>{let{changes:e,source:n}=t;Q("changes:",n,e),"user"===n&&(S.add(e),A())};let z=!1;(async()=>{try{if(await l.load(),z)return;const t=l.getValue();if(t){const e={};for(const[r,s]of(0,d().WP)(t.snapshot||{}))s&&(e[r]=c().v.deserialize(s));const n=t.schema?(0,s()._e)(t.schema,i.schema.serialize()):0,o=i.schema.migrateStoreSnapshot(e,t.schema??i.schema.serializeEarliestVersion());if("error"===o.type)throw X("migration error:",o),new Error(`This version of Notion isn't compatible with this drawing (${o.reason})`);i.mergeRemoteChanges((()=>{i.put(Object.values(e),"initialize")})),0!==n&&I(!0)}l.addListener(_),r({status:"synced",store:i})}catch(t){throw r({status:"error",error:(0,m().A)(t)}),t}})();const M=i.listen(C);return()=>{G("dispose",t),z=!0,v((e=>(null==e?void 0:e.id)===t?null:e)),l.removeListener(_),M()}}),[g,n,p,e,o]);const y=(null==b?void 0:b.syncedStore)??{status:"loading"};return{userId:p,instanceId:g,syncedStore:y}}({store:e,config:A});L({blockStore:e,app:o}),(0,i.useEffect)((()=>{if(o)return Y[M]=o,()=>{delete Y[M]}}),[M,o]);const E=(0,i.useMemo)((()=>{let t=null;return[{helpMenu(e,n,o){const s=n.find((t=>"group"===t.type&&"top"===t.id));return s?(t=(0,r().dMu)("help",...s.children),[]):[]}},{menu(e,n,o){n.push(t);for(const{item:t,parent:r,index:s}of function*(t){const e=[];function*n(t){for(let o=0;o<t.length;o++){const r=t[o];yield{index:o,item:r,path:e,parent:e.at(-1)},"group"!==r.type&&"submenu"!==r.type||(e.push(r),yield*n(r.children),e.pop())}}yield*n(t)}(n))"toggle-dark-mode"===t.id&&r&&r.children.splice(s,1),"LANGUAGE_MENU"===t.id&&r&&r.children.splice(s,1),"insert-media"===t.id&&r&&r.children.splice(s,1);return n},toolbar:(t,e,n)=>e.filter((t=>"asset"!==t.id)),actions(t,e,n){const o=e["toggle-dark-mode"];return o&&(o.kbd=void 0),e}}]}),[]),V={isDarkMode:n,config:A,assetUrls:J,overrides:E};return(0,_.jsxs)(_.Fragment,{children:[(0,_.jsx)(I,{}),(0,_.jsx)(r().O75,{onMount:v,instanceId:M,userId:z,store:C,...V,onCreateAssetFromFile:S,children:(0,_.jsx)(r().xM4,{...V,children:(0,_.jsx)(r().tzH,{children:(0,_.jsx)(r().HlI,{})})})})]})}const et=n(206267).JW();let nt=0;function ot(t){return![r().xlB,r().Mss,r().i5Z,r().dVE,r().Vbk,r().koU,r().wOc].some((e=>e.isId(t)))}const rt=.1,st=8;function it(t){if(!this.canMoveCamera)return this;const e=[...this.shapeIds];if(e.length<=0)return this;const n=f().oE(e.map((t=>this.getPageBoundsById(t))));null!=t&&t.include&&n.push(...t.include);const r=o().Ax.Common(n);return at.call(this,r.minX,r.minY,r.width,r.height,void 0,t),this}function at(t,e,n,r,s,i){if(!this.canMoveCamera)return this;const{viewportScreenBounds:a}=this,l=(null==i?void 0:i.inset)??Math.min(256,.28*a.width);let d=(0,o().qE)(Math.min((a.width-l)/n,(a.height-l)/r),rt,st);return void 0!==s&&(d=Math.min(s,d)),null!=i&&i.duration?this.animateCamera(-t+(a.width-n*d)/2/d,-e+(a.height-r*d)/2/d,d,i):this.setCamera(-t+(a.width-n*d)/2/d,-e+(a.height-r*d)/2/d,d),this}let lt=!1},352733:(t,e,n)=>{n.d(e,{j:()=>s,n:()=>i});var o=()=>n(671593),r=()=>n(416845);function s(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const s=(0,o().tf)(t,e,n);if(s)throw new(r().yI4)(s.message)}function i(t,e){const n=(0,o().tf)(t,e);if(void 0!==n)throw new(r().yI4)(n.message);return e}}}]);