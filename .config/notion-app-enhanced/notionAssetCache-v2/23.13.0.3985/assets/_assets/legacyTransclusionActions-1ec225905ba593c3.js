"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[2411,5834,34208,59388,90871,99314],{53592:(e,t,o)=>{o.r(t),o.d(t,{attemptServerBackedLocalDuplicate:()=>C,serverBackedLocalDuplicate:()=>f});o(944114),o(581454);var r=()=>o(857639),a=()=>o(386164),n=()=>o(388821),c=()=>o(912720),i=()=>o(199378),s=()=>o(502800),l=()=>o(763824),d=()=>o(466614),p=()=>o(449506),u=()=>o(666144),m=()=>o(751156),g=()=>o(974233),v=()=>o(611191),y=()=>o(603815),h=()=>o(261450),k=()=>o(503388),S=()=>o(966152),_=()=>o(59110),I=()=>o(605605),b=()=>o(677733);function f(e){const{environment:t,sourceBlock:o,targetInMemoryRecordCache:r,transaction:a,options:c,targetSpaceId:i,installationImprint:s,templateInstallationMetadata:d={},shouldUseSynchronousDuplicationAPI:p,stopwatch:u}=e,m=performance.now();null==u||u.mark("server_duplicate_start");const g=e.copyIndicators??(0,k().U8)({environment:t,sourceBlocks:[o],targetRecordCache:r,transaction:a,spaceId:i});null==u||u.mark("create_copy_indicators");const v=l().yX();return a.postSubmitCallbacks.push((async e=>{if(null==u||u.mark("transaction_post_submit_callback"),e)return(0,S().P0)({environment:t,type:"server_duplicate_transaction_post_submit_callback_error",data:{copyIndicatorIds:g.map((e=>e.id)),error:e,targetSpaceId:i,options:c}}),void(0,k().Jc)(e,v);(0,k().Yj)(g),null==u||u.mark("initialize_copy_indicators_progress_state");const{success:r,size:l}=await C({environment:t,sourceBlockPointer:o,targetBlockStore:g[0],options:c,templateInstallationMetadata:d,stopwatch:u});if(r)return(0,h().E)({environment:t,success:!0,time:performance.now()-m,user_action:a.getUserActionForAnalyticsPurposesOnly(),is_duplication_local:!0,duplication_size:l,method:"server_backed_local_duplication"}),null==u||u.mark("server_backed_local_duplicate_success"),(0,k().dH)(g),void v.resolve({status:"success"});const y=await(0,b().performServerDuplicate)({environment:t,copyIndicators:g,sourceBlocks:[o],targetSpaceId:i,options:c,templateInstallationMetadata:d,installationImprint:s,shouldUseSynchronousDuplicationAPI:p,stopwatch:u});if((0,k().dH)(g),!y.success)return(0,k().uC)({environment:t,copyIndicators:g}),(0,S().P0)({environment:t,type:"server_duplicate_iterator_error",data:{errorMessage:y.errorMessage}}),void v.resolve({status:"error",errorMessage:y.errorMessage,error:y.error});(0,h().E)({environment:t,success:!0,time:performance.now()-m,user_action:a.getUserActionForAnalyticsPurposesOnly(),is_duplication_local:!0,duplication_size:y.size,method:"sbld_fallback_server_duplication"}),null==u||u.mark("server_duplicate_success"),v.resolve({status:"success",recordIdMap:y.recordIdMapJson?n().RecordMapPolymorphic.create(y.recordIdMapJson):void 0})})),{blockStores:g,onComplete:v.promise}}async function C(e){const{environment:t,sourceBlockPointer:o,targetBlockStore:l,options:h,templateInstallationMetadata:k,recordLimit:b=500,targetInMemoryRecordCache:f,stopwatch:C}=e;null==C||C.mark("attempt_server_backed_local_duplicate_start"),(0,S().JW)({environment:t,type:"server_duplicate_attempt_server_backed_local_duplicate",data:{sourceBlockPointer:o,targetBlockStore:l,targetSpaceId:l.getSpaceId(),options:h}});const B=(0,v().$J)(),M=await async function(e){const{environment:t,sourceBlockPointer:o,targetBlockStore:c,targetInMemoryRecordCache:i,options:l,enableLegacyTransclusionFixing:d,recordLimit:m}=e,v=i??c.inMemoryRecordCache,h={blockId:o.id,allowCopyCollections:!0,requireFullSubtree:!0,skipTransclusionContainerChildren:!l.deepCopyTransclusionContainers,allowCopyExternalObjectInstances:!l.convertExternalObjectInstancesToPlaceholders,includeLegacyTransclusionBlockValues:d,inMemoryRecordCache:v};let k;if(k=(0,_().loadLocalSubtree)(t,h),!k.recordMap&&v===t.defaultRecordCache.inMemoryRecordCache)try{(0,S().JW)({environment:t,type:"performInexactPagePreload",data:{message:"No local subtree found, performing performInexactPagePreload",loadLocalSubtreeArgs:h}}),await(0,y().A$)(t,{table:"block",id:o.id,spaceId:o.spaceId}),k=(0,_().loadLocalSubtree)(t,h)}catch(I){r().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"persistedRecordCachePreloadError",error:(0,s().convertErrorToLog)(I),data:{message:"Failed to preload subtree from persisted record cache"}})}k.recordMap||((0,S().JW)({environment:t,type:"loadLocalSubtreeApi",data:{message:"No local subtree found from previous attempts, attemping API call to loadBlockSubtree",currentLocalSubtreeResponse:k}}),k=await async function(e){const{environment:t,sourceBlockPointer:o,recordLimit:c,targetBlockStore:i,loadLocalSubtreeArgs:l}=e;try{const e=await p().callApi({eventName:"loadBlockSubtree",environment:t,data:{block:{id:o.id,spaceId:o.spaceId},shallow:!1,recordCountLimit:c},headers:(0,a().WS)({spaceId:o.spaceId})});if((0,S().JW)({environment:t,type:"loadBlockSubtreeApiResult",data:{message:"Result from loadBlockSubtree API call",subtreeResult:e,apiArgs:{block:{id:o.id,spaceId:o.spaceId},shallow:!1,recordCountLimit:c}}}),"success"===e.type){const o=n().RecordMapWithRole.create(e.data.subtreeRecordMap);return await u()._O({environment:t,inMemoryRecordCache:l.inMemoryRecordCache,recordMap:o,debugSource:"load_local_subtree_from_server"}),(0,_().loadLocalSubtree)(t,l)}{const t=(0,g().V)(e);r().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"loadBlockSubtreeFailure",data:{message:"Error fetching subtree",miscDataToConvertToString:{error:t,sourceBlockPointer:o,cacheSize:i.inMemoryRecordCache.size,targetBlockPointer:{id:i.id,spaceId:i.getSpaceId(),type:i.getType()}}}})}}catch(I){r().log({level:"error",from:"attemptServerBackedLocalDuplicate",type:"subtreeLoadError",error:(0,s().convertErrorToLog)(I),data:{message:"Error loading subtree",miscDataToConvertToString:{sourceBlockPointer:o,cacheSize:i.inMemoryRecordCache.size,targetBlockPointer:{id:i.id,spaceId:i.getSpaceId(),type:i.getType()}}}})}}({environment:t,sourceBlockPointer:o,recordLimit:m,targetBlockStore:c,loadLocalSubtreeArgs:h}));k&&!k.recordMap&&r().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"subtreeLoadFailure",data:{message:"Failed to load subtree",miscDataToConvertToString:{sourceBlockPointer:o,cacheSize:c.inMemoryRecordCache.size,reason:"error"===k.type?k.reason:void 0,targetBlockPointer:{id:c.id,spaceId:c.getSpaceId(),type:c.getType()},missingRecord:"error"===k.type?k.pointer:void 0}}});return k}({environment:t,sourceBlockPointer:o,targetBlockStore:l,targetInMemoryRecordCache:f,options:h,enableLegacyTransclusionFixing:B,recordLimit:b});if(null==C||C.mark("try_load_local_subtree_finished"),!M||!M.recordMap)return{success:!1,size:void 0,pageStore:l};var T;if(d().Lw({sourceSpaceId:o.spaceId,targetSpaceId:l.getSpaceId(),sourceBlockSubtree:M.recordMap}))return r().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"accessLockingWarning",data:{message:"Unable to perform local duplication",miscDataToConvertToString:{sourceBlockPointer:o,targetBlockPointer:{id:l.id,spaceId:l.getSpaceId(),type:l.getType()}}}}),null==C||C.mark("attempt_server_backed_local_duplicate_failure"),{success:!1,size:null===(T=M.recordMap)||void 0===T?void 0:T.getSize(),pageStore:l};for(const a of M.recordMap.getTables()){var w;if(a===c().yB||a===i().SC)return r().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"invalidRecordType",data:{message:"Local duplication does not support automation tables",miscDataToConvertToString:{sourceBlockPointer:o,targetBlockPointer:{id:l.id,spaceId:l.getSpaceId(),type:l.getType()}}}}),null==C||C.mark("attempt_server_backed_local_duplicate_failure"),{success:!1,size:null===(w=M.recordMap)||void 0===w?void 0:w.getSize(),pageStore:l}}try{var L;(0,S().JW)({environment:t,type:"server_backed_duplicate_start_transaction",data:{message:"Starting transactionActions.createAndCommit for localDuplicate",sourceBlockPointer:o,targetBlockPointer:{id:l.id,spaceId:l.getSpaceId(),type:l.getType()}}});const{serverCommitResult:e}=m().createAndCommit({userAction:"server_backed_local_duplicate",environment:t,canUndo:!0,isTemplateInstantiationTransaction:Boolean(k),perform:e=>(0,I().localDuplicate)({environment:t,sourceBlockId:o.id,targetBlockPointer:l.pointer,sourceBlockSubtree:M.recordMap,targetInMemoryRecordCache:l.inMemoryRecordCache,transaction:e,templateInstallationMetadata:k,stopwatch:C,options:{...h,preventLegacyTransclusions:B}})});return await e,null==C||C.mark("server_backed_local_duplicate_finished"),(0,S().JW)({environment:t,type:"server_duplicate_attempt_server_backed_local_duplicate_success",data:{targetSpaceId:l.getSpaceId(),options:h}}),{success:!0,size:null===(L=M.recordMap)||void 0===L?void 0:L.getSize(),pageStore:l,transactionPromise:e}}catch(R){var P;return r().log({level:"error",from:"attemptServerBackedLocalDuplicate",type:"subtreeLoadError",error:(0,s().convertErrorToLog)(R),data:{message:"Failed to load subtree",miscDataToConvertToString:{sourceBlockPointer:o,targetBlockPointer:{id:l.id,spaceId:l.getSpaceId(),type:l.getType()}}}}),{success:!1,size:null===(P=M.recordMap)||void 0===P?void 0:P.getSize(),pageStore:l}}}},456116:(e,t,o)=>{o.r(t),o.d(t,{fixLegacyTransclusion:()=>b,maybeAutofixLegacyTransclusionProperty:()=>I});o(944114),o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698);var r=()=>o(857639),a=()=>o(179034),n=()=>o(161479),c=()=>o(502800),i=()=>o(568131),s=()=>o(59110),l=()=>o(605605),d=()=>o(594794),p=()=>o(611191),u=()=>o(299545),m=()=>o(589994),g=()=>o(630116),v=()=>o(679156),y=()=>o(722101),h=()=>o(797265),k=()=>o(778417),S=()=>o(751156);const _=new Set(["text","table_row","header","sub_header","sub_sub_header","to_do","bulleted_list","numbered_list","toggle"]);function I(e){const{parentStore:t,transaction:o,store:n,environment:i}=e,u=n.path[1];if(2!==n.path.length||"properties"!==n.path[0]||"string"!=typeof u)return;const h=n.getRecordStoreAtRootPath();if(!(h instanceof g().Bv))return;const k=h.getType();if(!k||!_.has(k))return;const S=function(e){var t;const{environment:o,store:r,parentStore:n,transaction:c}=e;if(r.getSpaceId()!==n.getSpaceId())return;const i=null===(t=n.getModel())||void 0===t?void 0:t.getContentIds();if(null==i||!i.includes(r.id))return;if(m().transactionQueue.isPendingTransactionForRecord(n.pointer)||m().transactionQueue.isPendingTransactionForRecord(r.pointer))return;const u=(0,p().$J)(),g=(0,s().loadLocalSubtree)(o,{blockId:r.id,inMemoryRecordCache:r.inMemoryRecordCache,allowCopyCollections:!1,requireFullSubtree:!0,skipTransclusionContainerChildren:!0,allowCopyExternalObjectInstances:!0,includeLegacyTransclusionBlockValues:u}).recordMap;if(!g)return;const v=(0,l().localDuplicate)({environment:o,sourceBlockId:r.id,targetBlockPointer:(0,d().zP)({environment:o,table:a().ev,spaceId:r.pointer.spaceId}),sourceBlockSubtree:g,targetInMemoryRecordCache:r.inMemoryRecordCache,transaction:c,options:{allowRedundancy:!0,deepCopyTransclusionContainers:!1,resolveTemplateVariables:!1,preventLegacyTransclusions:u}});return y().Br({parentStore:n.getContentStore(),oldChildStore:r,newChildStore:v.targetBlockStore,transaction:c}),v.targetBlockStore}({environment:i,store:h,parentStore:t,transaction:o});if(!S)return;const I=S.getPropertyStore(u);if(I)return o.postSubmitCallbacks.push((e=>{e&&r().log({from:"legacyTransclusionActions",level:"error",type:"maybeAutofixLegacyTransclusionProperty",error:{miscErrorString:(0,c().WS)(e)}}),v().Yr(i,{block_type:k,successful:!e})})),I;r().log({from:"legacyTransclusionActions",level:"error",type:"maybeAutofixLegacyTransclusionProperty",error:{message:"copied transclusion block does not have expected property"}})}function b(e){const{environment:t,store:o}=e,r=o.getRecordStoreUIParent();r&&(0,u().iU)(r)&&S().createAndCommit({userAction:"legacyTransclusionActions.fixLegacyTransclusion",environment:t,canUndo:!0,perform:e=>{const{blockStores:a}=i().duplicateBlock({environment:t,stores:[o],transaction:e,targetSpaceId:(0,n().e)(o.pointer.spaceId),preferDuplicateLocation:"local",options:{addCopyName:!1,allowRedundancy:!0,deepCopyTransclusionContainers:!0,resolveTemplateVariables:!1}}),c=a[0],{childStore:s}=y().WH({parentStore:r,insertStore:c,afterStore:o,transaction:e});h().TF({store:o,transaction:e}),k().td({environment:t,stores:[s]})}})}},568131:(e,t,o)=>{o.r(t),o.d(t,{duplicateBlock:()=>C});o(16280),o(898992),o(823215),o(581454),o(737550);var r=()=>o(179034),a=()=>o(665344),n=()=>o(854150),c=()=>o(466614),i=()=>o(970330),s=()=>o(901389),l=()=>o(863168),d=()=>o(594794),p=()=>o(611191),u=()=>o(972435),m=()=>o(494043),g=()=>o(406792);class v{constructor(e){this.environment=void 0,this.metricName=void 0,this.startMetric=void 0,this.prevLapMetric=void 0,this.extraData=void 0,this.environment=e.environment,this.metricName=e.metricName,this.startMetric=g().default.mark(e.metricName),this.prevLapMetric=g().default.mark(e.metricName),this.extraData=e.extraData??{}}mark(e){g().default.measure(this.prevLapMetric,{environment:this.environment,data:{type:e,...this.extraData},sampleDecision:"default"}),this.prevLapMetric=g().default.mark(this.metricName)}end(){g().default.measure(this.startMetric,{environment:this.environment,data:{type:"total",...this.extraData},sampleDecision:"default"})}}var y=()=>o(765957),h=()=>o(227440),k=()=>o(630116),S=()=>o(261450),_=()=>o(59110),I=()=>o(605605),b=()=>o(53592),f=()=>o(677733);function C(e){const{environment:t,stores:o,transaction:g,targetSpaceId:C,preferDuplicateLocation:B,analyticsFrom:M,options:T,installationImprint:w,shouldAttemptServerBackedLocalDuplication:L,templateInstallationMetadata:P,shouldUseSynchronousDuplicationAPI:R}=e,A=new v({environment:t,metricName:"duplicate_block_stopwatch",extraData:{duplication_type:"local"===B?"local_duplication":L?"server_backed_local_duplication":R?"server_synchronous_duplication":"server_duplication",from:M}});if(0===o.length)throw new Error("Must duplicate at least one block");const D=o[0].getSpaceId();if(!o.every((e=>e.getSpaceId()===D)))throw new Error("All stores must be in the same space");if(o.length>1&&!o.every((e=>e.isTypedCollectionViewBlock())))throw new Error("Multiple source blocks only supported for grouped typed DB duplication");!function(e){const{environment:t,stores:o,analyticsFrom:r}=e;for(const c of o){var a;const e=c.getRecordStoreAtRootPath().getValue();if(!e)continue;const{currentSpaceStore:o}=y().default.getState();let s;o&&e.parent_table===n().yK&&(s=k().h4.createChildStore(o,{table:n().yK,id:e.parent_id})),i().v(t,{from:r??"copy",type:e.type,teamStore:s,is_toggleable:(0,m().Yt)(e.type,e.format),collection_id:c.getAssociatedCollectionId()??(null===(a=c.getCollectionStore())||void 0===a?void 0:a.id),new_page_id:"page"===e.type?c.id:void 0,creating_block_id:c.id,parent_collection_id:c.getParentCollectionIdUpToTwoLevels(),form_id:c.getFirstFormIdInCollectionViewBlock()})}}({environment:t,stores:o,analyticsFrom:M}),A.mark("track_create_blocks"),T.convertExternalObjectInstancesToPlaceholders=D!==C;const x=P&&(0,a().Fe)(P.source)&&P.isListedTemplate;if("local"===B&&1===o.length&&!x){const e=function(e){const{environment:t,store:o,sourceSpaceId:a,targetSpaceId:n,transaction:i,options:s,installationImprint:u,templateInstallationMetadata:m,stopwatch:g}=e,v=(0,p().$J)(),y=(0,_().loadLocalSubtree)(t,{blockId:o.id,inMemoryRecordCache:o.inMemoryRecordCache,allowCopyCollections:!1,requireFullSubtree:!0,skipTransclusionContainerChildren:!s.deepCopyTransclusionContainers,allowCopyExternalObjectInstances:!s.convertExternalObjectInstancesToPlaceholders,includeLegacyTransclusionBlockValues:v}).recordMap;if(null==g||g.mark("load_local_subtree"),!y||c().Lw({sourceSpaceId:a,targetSpaceId:n,sourceBlockSubtree:y}))return;const{targetBlockStore:h}=(0,I().localDuplicate)({environment:t,sourceBlockId:o.id,targetBlockPointer:(0,d().zP)({environment:t,table:r().ev,spaceId:n}),sourceBlockSubtree:y,targetInMemoryRecordCache:o.inMemoryRecordCache,options:{...s,preventLegacyTransclusions:v},transaction:i,installationImprint:u,templateInstallationMetadata:m,stopwatch:g});"ai_block"===h.getType()&&l().EF.setState(h.pointer.id);return{blockStores:[h],onComplete:Promise.resolve({status:"success"})}}({environment:t,store:o[0],options:T,sourceSpaceId:D,targetSpaceId:C,transaction:g,installationImprint:w,templateInstallationMetadata:P,stopwatch:A});if(e)return A.mark("try_local_duplication_success"),A.end(),e;A.mark("try_local_duplication_failure")}const E=t.defaultRecordCache.inMemoryRecordCache;if(o.some((e=>e.inMemoryRecordCache!==E)))throw new Error("Can only server duplicate from the environment.defaultRecordCache.inMemoryRecordCache.");let F;return h().A.state.online||s().f1(u().A.formatMessage(S().V.offlineError)),F=1===o.length&&L?(0,b().serverBackedLocalDuplicate)({environment:t,sourceBlock:{id:o[0].id,spaceId:o[0].getSpaceId()},targetInMemoryRecordCache:E,transaction:g,targetSpaceId:C,installationImprint:w,templateInstallationMetadata:P,stopwatch:A,shouldUseSynchronousDuplicationAPI:R,options:T}):(0,f().serverDuplicate)({environment:t,sourceBlocks:o.map((e=>({id:e.id,spaceId:e.getSpaceId()}))),targetInMemoryRecordCache:E,transaction:g,targetSpaceId:C,installationImprint:w,templateInstallationMetadata:P,stopwatch:A,shouldUseSynchronousDuplicationAPI:R,options:T}),async function(){const{blockStores:e,onComplete:t}=F;if("success"===(await t).status)for(const o of e)if("ai_block"===o.getType())return void l().EF.setState(o.pointer.id)}(),A.mark("duplicate_block_immediate_return"),F.onComplete.then((e=>{A.end()})),F}},735790:(e,t,o)=>{o.d(t,{M:()=>n});o(296540);var r=o(474848);const a={viewBox:"0 0 20 20",fittedViewBox:"2.37 4.25 15.25 11.5",svg:(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("path",{d:"M3 7.375h6.829a2.501 2.501 0 0 0 4.842 0H17a.625.625 0 1 0 0-1.25h-2.329a2.501 2.501 0 0 0-4.842 0H3a.625.625 0 1 0 0 1.25M12.25 5.5a1.25 1.25 0 1 1 0 2.5 1.25 1.25 0 0 1 0-2.5"}),(0,r.jsx)("path",{fillRule:"evenodd",d:"M7.75 15.75a2.5 2.5 0 0 0 2.421-1.875H17a.625.625 0 1 0 0-1.25h-6.829a2.5 2.5 0 0 0-4.842 0H3a.625.625 0 1 0 0 1.25h2.329A2.5 2.5 0 0 0 7.75 15.75m0-1.25a1.25 1.25 0 1 0 0-2.5 1.25 1.25 0 0 0 0 2.5",clipRule:"evenodd"})]})},n=(0,o(340498).wt)("sliders",a)}}]);