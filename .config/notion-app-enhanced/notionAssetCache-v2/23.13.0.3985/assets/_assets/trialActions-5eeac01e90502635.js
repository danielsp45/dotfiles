"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[77970],{66460:(e,t,a)=>{a.d(t,{W:()=>b,e:()=>h});a(16280);var r=()=>a(244641),n=(a(296540),()=>a(857639)),i=()=>a(762433),s=()=>a(323063),o=()=>a(959013),d=()=>a(252105),c=()=>a(901389),l=()=>a(765957),m=()=>a(57605),p=()=>a(224701),u=()=>a(779795),y=()=>a(807778),v=()=>a(134217),g=()=>a(981046),f=a(474848);async function h(e){var t,a;const{environment:h,stripe:b,elements:w,trialData:S,trialDays:_,product:I,sessionId:A,customerAddress:D,vatId:C,isCheckoutAddressFormExperimentEnabled:k}=e;if(!w||!b)return void n().log({level:"error",from:"trialUpsellActions",type:"StripeError",error:{miscDataString:"Stripe elements not initialized when user tried to upgrade"}});const{error:E}=await w.submit();if(E)return void d().$X(h,{error:"could not submit form",error_type:"payment_method"});const M=await b.createPaymentMethod({elements:w});if(M.error)return void d().$X(h,{error:M.error.message,error_type:"payment_method"});if(!M.paymentMethod)return void d().$X(h,{error:"could not create token",error_type:"payment_method"});const L={type:"paymentMethodId",value:M.paymentMethod.id},N=l().default.state.currentSpaceStore;if(!N)return;const T=N.id,x=await u().p_({environment:h,spaceId:T}),F=await m().A.awaitData(h,{spaceId:T});if(!F)throw new Error("Billing data not loaded");const U=(0,i().lQ)(F),z=g().A.state.selectedCurrencyCode??"USD",P=(0,s().vk)(x,{interval:"month",product:I,currency:z}),X=(0,y().Le)(),$=(0,s().vH)(U,{price:P,quantity:1},{isMay13PackagingChangesEnabled:X}),q=r().c9.now().plus({days:_});return await async function(e){const{environment:t,spaceStore:a,paymentData:r,desiredState:n,stripe:i,trialData:s,sessionId:l,customerAddress:u,vatId:y}=e,g=await m().A.awaitData(t,{spaceId:a.id});try{const e=await p().nV({environment:t,sessionId:l,spaceStore:a,desiredState:n,paymentData:r,from:"onboarding",trialData:s,billingEmail:(0,v().cs)(g),customerName:u.name,businessName:u.businessName,addressCity:u.city,addressState:u.state,addressZip:u.zipCode,addressCountry:u.country,addressLine1:u.addressLine1,addressLine2:u.addressLine2,vatId:y}),d=e.paymentIntentClientSecret,m=e.paymentIntentStatus?e.paymentIntentStatus:void 0;if(d&&"requires_action"===m){const{error:e}=await i.handleNextAction({clientSecret:d});e&&(await p().nV({environment:t,spaceStore:a,from:"subscription_upgrade_onboarding_failed_payment",desiredState:{items:[],trialEnd:void 0}}),c().f1((0,f.jsx)(o().sA,{id:"subscription.upgrade.payment_failed",defaultMessage:"Your payment could not be processed. Please provide an alternate payment method or you will lose access to Notion."})))}return"success"}catch{return void d().AF(t)}}({environment:h,spaceStore:N,desiredState:{...$,trialEnd:q},paymentData:L,stripe:b,trialData:S,customerAddress:k?D:{name:D.name,businessName:D.businessName,zipCode:(null===(t=M.paymentMethod.billing_details.address)||void 0===t?void 0:t.postal_code)||"",country:(null===(a=M.paymentMethod.billing_details.address)||void 0===a?void 0:a.country)||""},vatId:k?C:void 0,sessionId:A})}const b=(0,a(496603).sg)(h,1e3,{leading:!0,trailing:!1})},655765:(e,t,a)=>{a.r(t),a.d(t,{handleTrialUpgradeFromOnboarding:()=>c().W,handleTrialUpgradeFromOnboardingImpl:()=>c().e,isEligibleForBlockLimitTimedTrial:()=>d});var r=()=>a(130382),n=()=>a(762433),i=()=>a(57605),s=()=>a(128265),o=()=>a(749356);async function d(e,t){const a=await i().A.awaitData(e,{spaceId:null==t?void 0:t.id});if("free"!==(0,n().AI)(a))return!1;const d=null==t?void 0:t.getSetting("reach_block_limit_time");if(!d||(0,r().Mn)(d)<3)return!1;if(await(0,s().G)(e))return!1;const c=t.getSpaceId();return!!(await(0,o().L6)({environment:e,spaceId:c,offerCampaign:"default"}))}var c=()=>a(66460)}}]);