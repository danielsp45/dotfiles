"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[83884],{614537:(e,t,o)=>{o.d(t,{$K:()=>W,Io:()=>q,Ls:()=>L,Or:()=>$,Pu:()=>K,cA:()=>G,ww:()=>X});o(16280),o(944114),o(898992),o(354520),o(672577),o(803949),o(581454);var r=()=>o(66689),i=()=>o(901610),n=()=>o(921598),a=()=>o(970013),l=()=>o(713998),c=()=>o(617871),p=()=>o(651124),s=()=>o(443881),d=()=>o(388693),u=()=>o(179034),f=()=>o(519831),v=()=>o(869558),m=()=>o(332393),g=()=>o(96689),_=()=>o(854150),y=()=>o(798880),S=()=>o(919709),b=()=>o(496603),w=()=>o(534177),h=()=>o(803074),C=()=>o(896628),k=()=>o(722101),B=()=>o(44729),V=()=>o(246826),P=()=>o(185544),I=()=>o(955930),U=()=>o(272600),M=()=>o(409902),T=()=>o(254497),A=()=>o(312296),E=()=>o(519839),F=()=>o(780054),z=()=>o(586481),R=()=>o(852353),N=()=>o(405417),D=()=>o(53137),O=()=>o(630116),x=()=>o(313892);function X(e){var t,o,a,l,c,s,d,u,f,m,g,_,y,S,h;const{environment:C,collectionStore:B,collectionViewBlockStore:P,dependency:I,blockUriMap:U,transaction:M}=e,T=U[I.uri];if(T){const e=O().pS.createChildStore(P,{table:v().Gy,id:T,spaceId:P.getSpaceId()});return V().zv({store:e,data:{alive:!0,parent_id:P.id,parent_table:P.table},transaction:M}),k().BC({parentStore:P.getCollectionViewsStore(),appendStore:e,transaction:M}),U}const A=B.getPropertyMapping(),E=J(null===(t=I.value.format)||void 0===t?void 0:t.collection_group_by,B),F=J(null===(o=I.value.format)||void 0===o?void 0:o.board_columns_by,B),z=Y(null===(a=I.value.format)||void 0===a?void 0:a.board_columns,B),R=function(e,t){if(!e||"placeholder"===e.type)return;const o=b().mg(e);if("groups_reducer"===o.dataConfig.type){var r;const e=o.dataConfig.groupBy.property;o.dataConfig.groupBy.property=t.getMappedProperty(e);const n=o.dataConfig.aggregationConfig.aggregation.property;n&&(o.dataConfig.aggregationConfig.aggregation.property=t.getMappedProperty(n));const a=(0,i().m)(o)?null===(r=o.dataConfig.aggregationConfig.stackOptions)||void 0===r?void 0:r.groupBy.property:void 0;(0,i().m)(o)&&a&&o.dataConfig.aggregationConfig.stackOptions&&(o.dataConfig.aggregationConfig.stackOptions.groupBy.property=t.getMappedProperty(a))}else{const e=o.dataConfig.nameProperty;o.dataConfig.nameProperty=t.getMappedProperty(e);const r=o.dataConfig.valueProperty;o.dataConfig.valueProperty=t.getMappedProperty(r)}return o}(null===(l=I.value.format)||void 0===l?void 0:l.chart_config,B),D=null==A?void 0:A[r().yx.SubTaskRelation],X=null==A?void 0:A[r().yx.BlockingRelation],q=I.value.type,W=q?(0,p().u9)(q):void 0,H=W?null===(c=I.value.format)||void 0===c?void 0:c[W]:void 0,K=W?{[W]:Y(H,B)}:{},L=Y(null===(s=I.value.format)||void 0===s?void 0:s.board_properties,B),$=Y(null===(d=I.value.format)||void 0===d?void 0:d.table_properties,B);if(D&&!(0,N().qS)(q)&&W){var j;const e=null===(j=K[W])||void 0===j?void 0:j.findIndex((e=>e.property===D)),t=K[W];t&&(!e||e<0?t.push({property:D,visible:!0}):t[e].visible=!0)}const G={...I.value.format,collection_group_by:E,board_columns_by:F,board_columns:z,board_properties:L,table_properties:$,chart_config:R,property_filters:null===(u=I.value.format)||void 0===u||null===(u=u.property_filters)||void 0===u?void 0:u.map((e=>{let{id:t,filter:o}=e;const{filter:r}=o;if("relation_contains"===r.operator){const e=(Array.isArray(r.value)?r.value:[r.value]).map((e=>{const t=e.type;if("relative"===t)return e;if("exact"===t){const t=e.value,o=t&&U[t];return o?{...e,value:o}:e}(0,w().HB)(t)}));return{id:t,filter:Q({property:o.property,filter:{operator:r.operator,value:e}},B)}}return{id:t,filter:Q(o,B)}})),collection_groups:null===(f=I.value.format)||void 0===f||null===(f=f.collection_groups)||void 0===f?void 0:f.map((e=>"relation"===e.value.type&&e.value.value&&!(0,n().zx)(e.value.value)&&U[e.value.value.id]?{...e,value:{type:"relation",value:{id:U[e.value.value.id],table:"block",spaceId:B.getSpaceId()}}}:e)),...K,table_subitem_toggle_column:"title",...X?{timeline_arrows_by:{property:X}}:{}},Z=b().oE(null===(m=I.value.page_sort)||void 0===m?void 0:m.map((e=>U[e]))),ee=null===(g=I.value.query2)||void 0===g||null===(g=g.aggregations)||void 0===g?void 0:g.map((e=>e.property?{...e,property:(null==A?void 0:A[e.property])??e.property}:e)),te=Y(null===(_=I.value.query2)||void 0===_?void 0:_.sort,B),oe=null===(y=I.value.query2)||void 0===y?void 0:y.timeline_by,re=oe?B.getMappedProperty(oe):void 0,ie=null===(S=I.value.query2)||void 0===S?void 0:S.calendar_by,ne=ie?B.getMappedProperty(ie):void 0,ae=null===(h=I.value.query2)||void 0===h?void 0:h.filter,le=ae?(0,x().ne)(ae,A):void 0,ce=V().eC({environment:C,table:v().Gy,inMemoryRecordCache:P.inMemoryRecordCache,value:{...I.value,parent_id:P.id,parent_table:P.table,space_id:P.getSpaceId(),format:{...G,app_config_uri:I.uri,collection_pointer:B.pointer},query2:{...I.value.query2,filter:le,aggregations:ee,sort:te,timeline_by:re,calendar_by:ne},page_sort:Z,alive:!0},transaction:M});U[I.uri]=ce.id;const pe=O().pS.createChildStore(P,ce.pointer);return k().BC({parentStore:P.getCollectionViewsStore(),appendStore:pe,transaction:M}),U}function q(e){var t;const{environment:o,collectionStore:r,dependency:i,allFeatures:n,blockUriMap:l,transaction:p}=e;let d=i.propertySchema;if("relation"===d.type){const e=(0,a().Nv)(d);if(!e)throw new Error("Invalid relation schema.");const t=l[e.id];if(!t)throw new Error("Relation target collection not found");const n=r.getDeletedSchema(),s=n[i.uri],u=s&&(0,a().UU)(s)?(0,a().Nv)(s):void 0;if(i.isConnectedRelation&&i.integrationId===c().ob&&u){const e=E().KA({deletedSchema:n,property:i.uri});if(!e)throw new Error("Deleted property schema was not found");(0,A().F)({environment:o,collectionStore:r,update:e.updateSchema,transaction:p}),(0,T().E)({collectionStore:r,update:e.updateDeletedSchema,transaction:p}),d={...d,collection_pointer:u,collection_id:u.id}}else d={...d,collection_pointer:{id:t,table:f().Vl,spaceId:r.getSpaceId()},collection_id:t}}else if("select"===d.type){const e=r.getSchema()[i.uri];if(e&&"select"===e.type){var u;const t=(0,x().rv)([i.uri],n),o=b().Bq(b().oE(t.map((e=>{var t;if("property"===e.type&&"select"===e.propertySchema.type)return null===(t=e.propertySchema.options)||void 0===t?void 0:t.map((e=>e.id))})))),r=(null===(u=e.options)||void 0===u?void 0:u.filter((e=>!o.includes(e.id))))||[];d={...d,options:[...d.options||[],...r]}}}else if("auto_increment_id"===d.type){const e=r.getSchema(),t=(0,w().WP)(e).find((e=>{var t;const o=e[0],r=null===(t=e[1])||void 0===t?void 0:t.type;return o&&r&&"auto_increment_id"===r}));if(t){var v;const e=t[0];return C().zA({stores:[r],update:{app_uri_map:{...null===(v=r.getFormat())||void 0===v?void 0:v.app_uri_map,[i.uri]:e}},transaction:p}),i.uri}}else if("text"===d.type)d.ai_inference&&d.ai_inference.auto_update_on_edit&&(d.ai_inference.auto_update_on_edit=(0,R().hn)({environment:o,userId:o.currentUser.id,spaceId:r.getSpaceId()}));else if("rollup"===d.type){if(!d.relation_property||!d.target_property)throw new Error("Invalid rollup schema.");const e=r.getSchema()[d.relation_property];if(!e||"relation"!==e.type)throw new Error("Invalid rollup schema.");const t=(0,a().Nv)(e);if(!t)throw new Error("Invalid rollup schema. Missing target collection pointer.");const o=r.getParentStore();if(!o)throw new Error("Undefined parent store.");const i=O().md.createChildStore(o,t);if(!i)throw new Error("Relation target collection not found");const n=i.getMappedProperty(d.target_property);n&&(d.target_property=n)}else if("formula"===d.type&&"v2"===d.version&&d.formula2){const{value:e}=(0,s().RI)({baseUrl:F().A.domainBaseUrl,formula:d.formula2.code,publicDomainName:F().A.publicDomainName,spaceId:r.getSpaceId(),visitors:{visitFormulaContextValue:void 0,visitFormulaPageProperty:e=>{var t;return"collection"in e&&(null===(t=e.collection)||void 0===t?void 0:t.id)===i.collectionUri?{type:"replace",value:{...e,collection:r.pointer}}:{type:"keep"}},visitRecordPointer:void 0}});d.formula2.code=e}(0,A().F)({environment:o,collectionStore:r,update:{[i.uri]:d},transaction:p}),C().zA({stores:[r],update:{app_uri_map:{...null===(t=r.getFormat())||void 0===t?void 0:t.app_uri_map,[i.uri]:i.uri}},transaction:p})}function W(e,t,o,r,i,n,c){const p=[...r.filter((e=>{let{type:t}=e;return"collection_view_block"===t})),...r.filter((e=>{let{type:t}=e;return"collection"===t})),...r.filter((e=>{let{type:t}=e;return"sub_external_collection"===t})),...r.filter((e=>{let{type:t}=e;return"property"===t})),...r.filter((e=>{let{type:t}=e;return"database_template"===t})),...r.filter((e=>{let{type:t}=e;return"block"===t})),...r.filter((e=>{let{type:t}=e;return"collection_view"===t}))],s=o.table===g().NX?o.id:o.getSpaceId(),v=o.table===g().NX?o:o.getSpaceStore();if(s&&v){for(const r of p)if("collection_view_block"===r.type){const n=i[r.uri];if(n){var _;const r=O().Bv.createChildStore(o,{table:u().ev,id:n,spaceId:s});null!==(_=G(t,o,r))&&void 0!==_&&null!==(_=_.getValue())&&void 0!==_&&_.includes(r.id)||L(e,t,o,r,c,"append"),V().zv({store:r,data:{parent_id:o.id,parent_table:o.table,alive:!0},transaction:c})}else{const n=V().Wv({environment:e,inMemoryRecordCache:o.inMemoryRecordCache,type:o.table===u().ev&&"app_container"===o.getFormat().collection_view_sub_type?"collection_view":"collection_view_page",spaceId:s,format:{app_config_uri:r.uri,page_icon:r.icon,page_cover:r.cover},properties:{title:(0,S().x9d)(r.name)},transaction:c});V().zv({store:n,data:{parent_id:o.id,parent_table:o.table,alive:!0},transaction:c}),i[r.uri]=n.id;L(e,t,o,O().Bv.createChildStore(o,n.pointer),c,"append")}}else if("collection"===r.type){const t=$(o,r.collectionViewBlockUri,i);if(!t)throw new Error("SubViewBlockStore not found");const n=t.getOwnedCollectionStores();for(const e of n)(0,M().h)({collectionViewBlockStore:t,collectionStore:e,transaction:c});const a=i[r.uri];if(a){const e=O().md.createChildStore(o,{table:f().Vl,id:a,spaceId:s});(0,U().p)({collectionViewBlockStore:t,collectionPointer:e.pointer,transaction:c}),V().zv({store:e,data:{alive:!0,parent_id:t.id,parent_table:t.table},transaction:c})}else{const o=V().eC({environment:e,table:f().Vl,inMemoryRecordCache:t.inMemoryRecordCache,value:{...r.value,parent_id:t.id,parent_table:t.table,space_id:t.getSpaceId(),format:{app_config_uri:r.uri,app_uri_map:Object.fromEntries(Object.keys(r.value.schema??{}).filter((e=>e.startsWith("notion://"))).map((e=>[e,e]))),...r.value.format},alive:!0},transaction:c});i[r.uri]=o.id;const n=O().md.createChildStore(t,o.pointer);(0,U().p)({collectionViewBlockStore:t,collectionPointer:n.pointer,transaction:c})}}else if("sub_external_collection"===r.type){const t=D().A.getIntegrationsAsRecordMap().getModel({table:m().Li,id:r.integrationId});if(!t||!(0,d().v_)(t))throw new Error("Invalid integration");const n=K(o,r.parentCollectionUri,i);if(!n)throw new Error("Unable to find parent collection store");const l=n.getDeletedSchema()[r.relationUri],p=l&&(0,a().UU)(l)?(0,a().zO)(l):void 0;if(l&&(0,a().UU)(l)&&p){i[r.uri]=p;continue}const s=h().qM({environment:e,pattern:r.pattern,integration:t,parentCollectionStore:n,transaction:c});i[r.uri]=s.id}else if("property"===r.type)H({environment:e,appConfig:n,appParentStore:o,dependency:r,uriMap:i,transaction:c});else if("collection_view"===r.type){const t="block"===o.table&&o.getFormat().app_config_uri===r.collectionViewBlockUri?o:$(o,r.collectionViewBlockUri,i);if(!t)throw new Error("View's home block not found");const n=K(o,r.collectionUri,i);if(!n)throw new Error("View source collection not found");i=X({environment:e,collectionStore:n,collectionViewBlockStore:t,dependency:r,blockUriMap:i,transaction:c})}else if("database_template"===r.type){const t=K(o,r.collectionUri,i);if(!t)throw new Error("Collection not found");const n=t.getTemplatePagesStore(),a=i[r.uri];if(a){const e=O().Bv.createChildStore(t,{table:u().ev,id:a,spaceId:t.getSpaceId()});V().zv({store:e,data:{alive:!0,parent_id:t.id,parent_table:t.table,is_template:!0},transaction:c}),k().BC({parentStore:n,appendStore:e,transaction:c}),r.isDefault&&C().zA({stores:[t],update:{collection_default_template:{template_page_id:e.id}},transaction:c})}else{const a=V().Wv({environment:e,inMemoryRecordCache:o.inMemoryRecordCache,type:r.blockValue.type,spaceId:t.getSpaceId(),properties:r.blockValue.properties,format:{...r.blockValue.format,app_config_uri:r.uri},transaction:c});V().zv({store:a,data:{parent_id:t.id,parent_table:t.table,alive:!0,is_template:!0},transaction:c}),i[r.uri]=a.id,k().BC({parentStore:n,appendStore:a,transaction:c}),r.isDefault&&C().zA({stores:[t],update:{collection_default_template:{template_page_id:a.id}},transaction:c})}}else"block"===r.type?j(e,o,r,i,c):"page_template"===r.type||(0,w().HB)(r);!function(e,t,o,r,i){for(const n of o){const o=$(t,n.uri,r),a=null==o?void 0:o.getParentStore();if(!o||!a||"collection"!==a.table||!n.blockValue.properties)continue;const c={};Object.entries(n.blockValue.properties).forEach((o=>{var i,n;let[p,s]=o;if("relation"===(null===(i=a.getSchema()[p])||void 0===i?void 0:i.type)){const e=(0,l().n)(s),o=b().oE(e.map((e=>{const o=r[e.id];if(o)return{table:u().ev,id:o,spaceId:t.table===g().NX?t.id:t.getSpaceId()}}))),i=(0,l().Ap)(o);c[p]=i}else"person"===(null===(n=a.getSchema()[p])||void 0===n?void 0:n.type)&&e.currentUser.id?c[p]=(0,l().AH)([{table:y().oo,id:e.currentUser.id}]):c[p]=s})),z().L({environment:e,store:o,properties:c,transaction:i})}}(e,o,r.filter((e=>{let{type:t}=e;return"block"===t})),i,c)}}function H(e){const{environment:t,transaction:o,appParentStore:r,dependency:i,uriMap:n,appConfig:a}=e,l=K(r,i.collectionUri,n);if(!l)throw new Error("Collection not found");q({environment:t,collectionStore:l,dependency:i,blockUriMap:n,allFeatures:a.allFeatures,transaction:o})}function K(e,t,o){return o[t]?O().md.createChildStore(e,{table:f().Vl,id:o[t],spaceId:e.table===g().NX?e.id:e.getSpaceId()}):void 0}function L(e,t,o,r,i,n){if(o.table!==u().ev)if(o.table===g().NX){if((null==t?void 0:t.getSpaceId())!==o.id)return;P().yM({environment:e,spaceStore:o,spaceViewStore:t,pageStore:r,isPrivate:!0,transaction:i})}else o.table===_().yK?I().sP({teamStore:o,store:r,transaction:i,location:{type:n}}):(0,w().HB)(o)}function $(e,t,o){return o[t]?O().Bv.createChildStore(e,{table:u().ev,id:o[t],spaceId:e.table===g().NX?e.id:e.getSpaceId()}):void 0}function j(e,t,o,r,i){let n=$(t,o.uri,r);const a="collection"===o.parentType?K(t,o.parentUri,r):$(t,o.parentUri,r);if(!a)return{blockStore:n,parentStore:void 0};if(n)V().zv({store:n,data:{parent_id:a.id,parent_table:a.table,alive:!0},transaction:i});else{const l=t.table===g().NX?t.id:t.getSpaceId(),c=t.table===g().NX?t:t.getSpaceStore();if(!l||!c)return;const p=V().Wv({environment:e,type:o.blockValue.type,spaceId:l,format:{...o.blockValue.format,app_config_uri:o.uri},properties:o.blockValue.properties,inMemoryRecordCache:t.inMemoryRecordCache,transaction:i});V().zv({store:p,data:{parent_id:a.id,parent_table:a.table,alive:!0},transaction:i}),n=O().Bv.createChildStore(a,p.pointer),r[o.uri]=p.pointer.id}return"block"===a.table?B().NI({parentStore:a,childStore:n,transaction:i}):"collection"===a.table?B().X$({parentStore:a,childStore:n,transaction:i}):(0,w().HB)(a),{blockStore:n,parentStore:a}}function G(e,t,o){if(t.table===_().yK)return t.getTeamPagesStore();if(t.table===g().NX){var r,i;if(null!==(r=e.getPrivatePagesStore().getValue())&&void 0!==r&&r.includes(o.id))return e.getPrivatePagesStore();if(null!==(i=e.getSharedPagesStore().getValue())&&void 0!==i&&i.includes(o.id))return e.getSharedPagesStore()}else{if(t.table===u().ev)return t.getContentStore();(0,w().HB)(t)}}function J(e,t){if(e)return Q(e,t)}function Y(e,t){if(e)return e.map((e=>Q(e,t)))}function Q(e,t){const o=t.getMappedProperty(e.property);return o?{...e,property:o}:e}},767435:(e,t,o)=>{o.r(t),o.d(t,{applyPresetFeatures:()=>q,applyTypedFeatures:()=>H,createTypedDBsInTeam:()=>j,initializeApp:()=>x,installAppsInPrivatePages:()=>J,installAppsInTeam:()=>G,markTasksDatabaseTemplateIfNeeded:()=>O,removeTypedDependencies:()=>$});o(16280),o(944114),o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698),o(898992),o(354520),o(672577),o(803949),o(581454),o(737550);var r=()=>o(584262),i=()=>o(66689),n=()=>o(700500),a=()=>o(716016),l=()=>o(970013),c=()=>o(857639),p=()=>o(206267),s=()=>o(869558),d=()=>o(919709),u=()=>o(496603),f=()=>o(502800),v=()=>o(763824),m=()=>o(534177),g=()=>o(160568),_=()=>o(175213),y=()=>o(449506),S=()=>o(84448),b=()=>o(235191),w=()=>o(901389),h=()=>o(896628),C=()=>o(722101),k=()=>o(246826),B=()=>o(857783),V=()=>o(319975),P=()=>o(751156),I=()=>o(2220),U=()=>o(414360),M=()=>o(409902),T=()=>o(609429),A=()=>o(972435),E=()=>o(630116),F=()=>o(617254),z=()=>o(313892),R=()=>o(614537),N=()=>o(925496);const D=(0,o(959013).YK)({initializeAppTemplateError:{id:"appTemplateActions.initializeAppTemplateError.message",defaultMessage:"Duplicate template failed."}});function O(e){e&&e.some((e=>e.getFormat().app_config_uri===i().d0))&&(T().e.locallyMutatedTasksDatabase=!0)}function x(e){const{environment:t,temporaryContainerBlockStore:o,transaction:i,skipNavigation:n}=e,l=q({...e,initializeStore:o,createOrModify:"create"}),c=!["jira_import"].includes(e.from)&&!n;return l&&l.length>0&&c&&B().uK({environment:t,store:l[0],redirect:!0,pageVisitSource:r().y8.Onboarding}),i.postSubmitCallbacks.push((async e=>{e?w().f1(A().A.formatMessage(D.initializeAppTemplateError)):l&&await async function(e){const{environment:t,appCollectionViewBlockStores:o}=e,r=u().oE(o.map((e=>{const t=e.getCollectionStore();if(t){const e=t.getSchema();if((0,a().yP)(e).length>0)return t}})));for(const i of r)await S().c({environment:t,collectionStore:i})}({environment:t,appCollectionViewBlockStores:l})})),l}function X(e){const{appUri:t,parentStore:o,presetUri:r}=e,i=(0,F().appConfigs)().find((e=>e.uri===t));if(!o.isDefined()||!i)return;if(0===i.presets.length)throw new Error(`No presets configuration for specified app: ${t}`);const a=i.presets.find((e=>e.uri===r));if(r&&!a)throw new Error("Couldn't find specified preset");const l=a||i.presets[0],c=(0,z().T6)((0,F().appConfigs)(),l),p=i.presets.filter((e=>!(0,z().i$)(e.uri))),s=function(e){const{environment:t,spaceViewStore:o,appUri:r,parentStore:i,spaceId:a,transaction:l,startingFeatures:c,defaultPreset:p,nonTypedDBPresets:s,foundConfiguration:u}=e;if(!r.startsWith("notion://wiki")&&1===s.length)return H({environment:t,spaceViewStore:o,appParentStore:i,appUri:r,features:c,createOrModify:"create",transaction:l});const f=k().Wv({environment:t,type:n().xd.collectionViewPage,spaceId:a,format:{app_config_uri:r,collection_view_sub_type:"app_container",page_icon:u.logo,app_template_preset:p.uri,app_template_features:c},properties:{title:(0,d().x9d)(r.startsWith("notion://wiki")?u.name:p.shortName)},inMemoryRecordCache:i.inMemoryRecordCache,transaction:l});k().zv({store:f,data:{parent_id:i.id,parent_table:i.table,alive:!0,view_ids:[]},transaction:l});const v=E().Bv.createChildStore(i,f.pointer);return(0,R().Ls)(t,o,i,v,l,"prepend"),[v]}({...e,startingFeatures:c,defaultPreset:l,nonTypedDBPresets:p,foundConfiguration:i});return s}function q(e){const{environment:t,appUri:o,presetUri:r,transaction:i,createOrModify:n,from:a}=e,l=(0,F().appConfigs)().find((e=>e.uri===o)),p=null==l?void 0:l.presets.find((e=>e.uri===r));if(p)return i.postSubmitCallbacks.push((e=>{g()._I(t,{preset_uri:W(r),status:Boolean(e)?"fail":"success",from:a}),e&&c().log({level:"error",from:"appTemplateActions.applyPresetFeatures",type:"transactionFailed",error:(0,f().convertErrorToLog)(e),data:{miscDataToConvertToString:{appUri:o,presetUri:r,createOrModify:n,from:a}}})})),H({...e,features:(0,z().T6)((0,F().appConfigs)(),p)});c().log({level:"error",from:"appTemplateActions.applyPresetFeatures",type:"presetNotFound",error:{name:`Preset not found for appUri ${o} and presetUri ${r}. From: ${a}`}})}function W(e){return(0,i().TS)(e)?e:"other"}function H(e){const{environment:t,spaceViewStore:o,appParentStore:r,appUri:i,features:a,transaction:l,createOrModify:s}=e,f=(0,F().appConfigs)().find((e=>e.uri===i));if(!f||!r.isDefined())return;let v;if("modify"===s){const{appCollectionViewBlockStores:t}=e,o=u().sb(u().oE(t.map((e=>e.getFormat().app_id))));if(o.length>1)throw new Error("App collection view block stores must have the same app id");0===o.length?v=function(e){let{transaction:t,collectionViewBlockStores:o}=e;const r=p().JW();for(const n of o){var i;const e=L(n);if(!e)continue;const o=n.getFormat(),a={app_id:o.app_id??r,...e};k().zv({store:n.getFormatStore(),data:a,transaction:t}),c().log({level:"info",from:"appTemplateActions.backfillAppMetadataOnCollectionViewBlocks",type:"backfillAppMetadata",data:{miscDataToConvertToString:{databaseType:null===(i=n.getCollectionStore())||void 0===i?void 0:i.getDatabaseType(),collectionViewBlockId:n.id,originalFormat:o}}})}return r}({transaction:l,collectionViewBlockStores:t}):(K({transaction:l,collectionViewBlockStores:t}),v=o[0])}const g=(0,z().u6)({featurePointers:a,appConfig:f});if(0===g.length)return;let _={};if("create"===e.createOrModify&&e.initializeStore){const o=g.filter((e=>"collection_view_block"===e.type)),r=o[0];r&&(k().zv({store:e.initializeStore,data:{type:e.initializeStore.isType(n().xd.collectionViewPage)||e.initializeStore.isType(n().xd.collectionView)?e.initializeStore.getType():n().xd.collectionViewPage},transaction:l}),k().zv({store:e.initializeStore.getFormatStore(),data:{app_config_uri:r.uri,page_icon:r.icon,page_cover:r.cover,collection_view_sub_type:null,app_template_features:null},transaction:l}),V().R9({environment:t,store:e.initializeStore.getBlockTitleStore(),value:(0,d().x9d)(r.name),transaction:l}),_[r.uri]=e.initializeStore.id)}else"modify"===e.createOrModify&&(_=Object.assign({},...u().oE(e.appCollectionViewBlockStores.map((e=>{var t;return null===(t=e.getFormat())||void 0===t?void 0:t.app_uri_map})))));const y={..._};(0,R().$K)(t,o,r,g,y,f,l),g.map((e=>{if("collection_view_block"===e.type){const t=(0,R().Or)(r,e.uri,y);t&&function(e,t,o){const r=e.getCollectionViewStores().map((e=>{const o=e.getFormat().app_config_uri;let r=o?null==t?void 0:t.indexOf(o):null==t?void 0:t.length;return void 0!==r&&-1!==r||(r=null==t?void 0:t.length),{viewStore:e,order:r}})),i=u().Ul(r,(e=>e.order)).map((e=>e.viewStore.id));k().zv({store:e,data:{view_ids:i},transaction:o})}(t,e.defaultViewsOrder||[],l)}}));const S=u().oE(u().sb(u().oE(g.map((e=>{if("collection_view_block"===e.type)return e.uri;if("collection"===e.type||"collection_view"===e.type){const t=(0,z().Ts)([e.collectionViewBlockUri],f);if(t&&t.length&&"collection_view_block"===t[0].type)return e.collectionViewBlockUri}}))))),b=u().oE(S.map((e=>(0,R().Or)(r,e,y))));if("create"===s&&e.initializeStore){const t=e.initializeStore.getPermissionItemsStore().getValue();t&&b.forEach((e=>{k().zv({store:e,data:{permissions:t},transaction:l})}))}const w="create"===s?u().oE([e.initializeStore]):e.appCollectionViewBlockStores,B=b.filter((e=>void 0===w.find((t=>t.id===e.id))));if(w.length>0&&B.length>0){const e=w[w.length-1],t=(0,R().cA)(o,r,e);t&&B.forEach(((o,r)=>{C().Yb({parentStore:t,currentStore:o,afterStore:0===r?e:B[r-1],transaction:l})}))}const P=b.map((e=>{var t;return null===(t=e.getCollectionPointer())||void 0===t?void 0:t.id})).filter(m().O9);(0,I().u)({environment:t,event:{eventName:"create_app_templates",eventProperties:{target_page_ids:b.map((e=>e.id)),template_label:f.name,collection_ids:P}}});const U=v||p().JW();return function(e,t,o,r,i){e.forEach((e=>{const n=e.getFormat().app_config_uri;if(n){var a;const l=(0,z().nf)(new Set([n]),t),c={};l.forEach((e=>{o[e.uri]&&(c[e.uri]=o[e.uri])})),c[n]=o[n],h().zA({stores:[e],update:{app_uri_map:{...(null===(a=e.getFormat())||void 0===a?void 0:a.app_uri_map)||{},...c},app_id:r},transaction:i})}}))}(b,g,y,U,l),b}function K(e){let{transaction:t,collectionViewBlockStores:o}=e;for(const i of o){var r;const e=L(i);if(!e)continue;const o=i.getFormat(),n={app_config_uri:o.app_config_uri,app_uri_map:o.app_uri_map};u().n4(n,e)||(k().zv({store:i.getFormatStore(),data:e,transaction:t}),c().log({level:"info",from:"appTemplateActions.maybeUpsertAppUriMetadataOnCollectionViewBlocks",type:"fixAppMetadata",data:{miscDataToConvertToString:{databaseType:null===(r=i.getCollectionStore())||void 0===r?void 0:r.getDatabaseType(),collectionViewBlockId:i.id,originalFormat:o}}}))}}function L(e){const t=e.getCollectionStore();if(!t)return;const o=t.getDatabaseType();if(!o)return;const r=i().Fh[o].blockUri,n={[o]:t.id};r&&(n[r]=e.id);return{app_config_uri:r,app_uri_map:{...e.getFormat().app_uri_map,...n}}}function $(e){const{environment:t,dependencies:o,appCollectionViewBlockStores:r,from:i}=e,n=function(e){return e.filter((t=>{if("collection"===t.type){return Boolean(e.find((e=>"collection_view_block"===e.type&&e.uri===t.collectionViewBlockUri)))}if("property"===t.type||"collection_view"===t.type||"collection_view_block"===t.type||"page_template"===t.type||"block"===t.type||"database_template"===t.type||"sub_external_collection"===t.type)return!0;(0,m().HB)(t)}))}(o);P().createAndCommit({userAction:"appTemplateActions.removeTypedDependencies",environment:t,canUndo:!0,perform:e=>{K({transaction:e,collectionViewBlockStores:r});const o=Object.assign({},...u().oE(r.map((e=>{var t;return null===(t=e.getFormat())||void 0===t?void 0:t.app_uri_map}))));!function(e){const{environment:t,appCollectionViewBlockStores:o,dependenciesToRemove:r,completeUriMap:i,transaction:n}=e,a=[...r.filter((e=>{let{type:t}=e;return"collection_view"===t})),...r.filter((e=>{let{type:t}=e;return"block"===t})),...r.filter((e=>{let{type:t}=e;return"database_template"===t})),...r.filter((e=>{let{type:t}=e;return"page_template"===t})),...r.filter((e=>{let{type:t}=e;return"property"===t})),...r.filter((e=>{let{type:t}=e;return"sub_external_collection"===t})),...r.filter((e=>{let{type:t}=e;return"collection"===t})),...r.filter((e=>{let{type:t}=e;return"collection_view_block"===t}))];for(const c of a)if("collection_view_block"===c.type){const e=o.find((e=>{var t;return(null===(t=e.getFormat())||void 0===t?void 0:t.app_config_uri)===c.uri}));e&&n.postSubmitCallbacks.push((o=>{o||y().callApi({eventName:"deleteBlocks",environment:t,data:{blocks:[{id:e.id,spaceId:e.getSpaceId()}],permanentlyDelete:!0}})}))}else if("collection"===c.type){const e=o.find((e=>{var t;return(null===(t=e.getFormat())||void 0===t?void 0:t.app_config_uri)===c.collectionViewBlockUri}));if(e){const t=(0,R().Pu)(e,c.uri,i);t&&(0,M().h)({collectionViewBlockStore:e,collectionStore:t,transaction:n})}}else if("property"===c.type){const r=o.find((e=>{var t;return(null===(t=e.getCollectionStore())||void 0===t||null===(t=t.getFormat())||void 0===t?void 0:t.app_config_uri)===c.collectionUri}))??o[0],a=(0,R().Pu)(r,c.collectionUri,i);if(a){let o;const p=(0,l().nC)(c.propertySchema)?(0,l().zO)(c.propertySchema):void 0;p&&(o=(0,R().Pu)(r,p,i)),b().BJ({environment:t,collectionStore:a,schema:a.getSchema(),property:c.uri,transaction:n,targetCollectionStore:o}),(0,_().G)(t,{property_type:c.propertySchema.type,from:e.from,property:c.uri,collection_id:a.id})}}else if("collection_view"===c.type){const e=i[c.uri];if(!e)throw new Error("Cannot delete view: id not found in map.");const t=o.find((e=>{var t;return(null===(t=e.getFormat())||void 0===t?void 0:t.app_config_uri)===c.collectionViewBlockUri}));if(t){const o=E().pS.createChildStore(t,{table:s().Gy,id:e,spaceId:t.getSpaceId()});(0,U().T)({collectionViewBlockStore:t,collectionViewStore:o,transaction:n})}}else"page_template"===c.type||"block"===c.type||"database_template"===c.type||"sub_external_collection"===c.type||(0,m().HB)(c)}({environment:t,appCollectionViewBlockStores:r,dependenciesToRemove:n,completeUriMap:o,transaction:e,from:i})}})}function j(e){const{presetUri:t,environment:o,spaceViewStore:r,teamStore:i,from:n}=e,a=Date.now(),{serverCommitResult:l,performResult:c}=P().createAndCommit({userAction:`teamActions.createTypedDBsInTeam.${F().presetUriToHumanReadableName[t]}`,environment:o,canUndo:!0,perform:e=>{const a=(0,z().BL)((0,F().appConfigs)(),t);if(!a)return;const l=q({environment:o,spaceViewStore:r,appParentStore:i,appUri:a.uri,createOrModify:"create",transaction:e,presetUri:t,from:n});return N().createSprintPage({environment:o,spaceViewStore:r,appParentStore:i,transaction:e,blockStores:l,creationEntryPoint:{type:"preset",presetUri:t}}),l&&g().Xq(o,{created_block_stores:l,preset_uri:t,destination_team_id:i.id,from:n}),l}});return l.then((()=>{g().pM(o,{from:n,preset_uri:t,time:Date.now()-a})})),c??[]}async function G(e){const{environment:t,presets:o,spaceStore:r,spaceViewStore:i,teamStore:n}=e,a=o.slice().reverse().map((e=>{const{serverCommitResult:o,performResult:a}=P().createAndCommit({environment:t,userAction:"AppsSetup.onContinueWithAppsMultiTransaction",canUndo:!0,skipUpdatingEditedMetadata:!0,perform:o=>{var a;const l=null===(a=(0,z().BL)((0,F().appConfigs)(),e))||void 0===a?void 0:a.uri;if(!l)return;return X({environment:t,spaceViewStore:i,appUri:l,parentStore:n,spaceId:r.id,transaction:o,presetUri:e})}});return{serverCommitResult:o,performResult:a}}));await Promise.all(a.map((e=>e.serverCommitResult)));return u().oE(u().Bq(a.map((e=>e.performResult)).reverse()))}async function J(e){const{environment:t,presets:o,spaceStore:r,spaceViewStore:i}=e,n=o.slice().reverse().map((e=>{const{serverCommitResult:o,performResult:n}=P().createAndCommit({environment:t,userAction:"AppsSetup.onContinueWithAppsMultiTransaction",canUndo:!0,skipUpdatingEditedMetadata:!0,perform:o=>{var n;const a=null===(n=(0,z().BL)((0,F().appConfigs)(),e))||void 0===n?void 0:n.uri;if(!a)return;return X({environment:t,spaceViewStore:i,appUri:a,parentStore:r,spaceId:r.id,transaction:o,presetUri:e})}});return{serverCommitResult:o,performResult:n}}));await v().lX(n,10,(e=>e.serverCommitResult));return u().oE(u().Bq(n.map((e=>e.performResult)).reverse()))}},806638:(e,t,o)=>{o.d(t,{P:()=>n});var r=()=>o(427704),i=()=>o(435009);function n(e){const{environment:t}=e;i().oo({environment:t,url:r().JZ.marketplace,redirect:!1})}},925496:(e,t,o)=>{o.r(t),o.d(t,{createSprintPage:()=>b});o(898992),o(672577),o(803949);var r=()=>o(66689),i=()=>o(700500),n=()=>o(416845),a=()=>o(179034),l=()=>o(869558),c=()=>o(96689),p=()=>o(854150),s=()=>o(534177),d=()=>o(722101),u=()=>o(246826),f=()=>o(185544),v=()=>o(955930),m=()=>o(414360),g=()=>o(972435),_=()=>o(778708),y=()=>o(630116);const S=(0,o(959013).YK)({sprintBoard_0:{id:"appTemplatesSprintBoardActions.sprintBoard_0",defaultMessage:"Sprint board"}});function b(e){const{environment:t,spaceViewStore:o,appParentStore:b,transaction:w,blockStores:h,creationEntryPoint:C}=e;if("preset"===C.type&&C.presetUri!==r().I0)return;if(!h)return;const k=h.find((e=>e.getFormat().app_config_uri===r().d0)),B=h.find((e=>e.getFormat().app_config_uri===r().IE));if(!k||!B)return;_()._R({environment:t,transaction:w,sprintsBlockStore:B,tasksBlockStore:k});return function(e){const{environment:t,spaceViewStore:o,appParentStore:_,transaction:b,tasksBlockStore:w,location:h}=e,C=_.table===c().NX?_.id:_.getSpaceId(),k=_.table===c().NX?_:_.getSpaceStore();if(!C||!k)return;const B=function(e){const{environment:t,appParentStore:o,tasksBlockStore:a,transaction:p,spaceId:s}=e,f=function(e){const{environment:t,appParentStore:o,transaction:r,spaceId:a}=e,l=o.table===c().NX?o:o.getSpaceStore();if(!l)throw new(n().yI4)("No space store found");const p=u().Wv({environment:t,type:i().xd.collectionViewPage,spaceId:a,format:{page_icon:"/icons/run_lightgray.svg",special_page_for_pm_launch:"sprint_board"},properties:{title:[[g().A.formatMessage(S.sprintBoard_0)]]},inMemoryRecordCache:o.inMemoryRecordCache,transaction:r});u().zv({store:p,data:{parent_id:o.id,parent_table:o.table,alive:!0},transaction:r});const s=y().Bv.createChildStore(o,p.pointer);return s}({environment:t,appParentStore:o,transaction:p,spaceId:s});return[r().Lu,r().JS,r().vQ].forEach((e=>{!function(e){var t;const{collectionViewBlock:o,tasksBlockStore:r,viewUri:i,spaceId:n,transaction:a}=e,c=r.getCollectionPointer(),p=null===(t=r.getFormat())||void 0===t||null===(t=t.app_uri_map)||void 0===t?void 0:t[i];if(!p)return;const s=y().pS.createChildStore(o,{table:l().Gy,id:p,spaceId:n});c&&s&&function(e){const{viewStore:t,transaction:o,tasksCollectionPointer:r,viewBlockStore:i}=e,n=t.getName(),a=t.getPageSort(),l=t.getFormat(),c=t.getKeyStore("query2").getValue(),p=t.clone(),s=t.getType();u().zv({store:p,data:{name:n,type:s,page_sort:a,format:{...l,collection_pointer:r},query2:c,alive:!0,parent_id:i.id,parent_table:i.table},transaction:o}),d().BC({parentStore:i.getCollectionViewsStore(),appendStore:p,transaction:o})}({viewStore:s,transaction:a,tasksCollectionPointer:c,viewBlockStore:o});(0,m().T)({collectionViewBlockStore:r,collectionViewStore:s,transaction:a})}({collectionViewBlock:f,tasksBlockStore:a,viewUri:e,spaceId:s,transaction:p})})),f}({environment:t,appParentStore:_,tasksBlockStore:w,transaction:b,spaceId:C});return function(e,t,o,r,i,n){if(o.table===a().ev)"prepend"===n.type&&d().Hs({parentStore:o.getContentStore(),prependStore:r,before:n.before,transaction:i});else if(o.table===c().NX){if(t.getSpaceId()!==o.id)return;f().yM({environment:e,spaceStore:o,spaceViewStore:t,pageStore:r,isPrivate:!0,transaction:i,location:n})}else o.table===p().yK?v().sP({teamStore:o,store:r,transaction:i,location:n}):(0,s().HB)(o)}(t,o,_,B,b,h),B}({environment:t,spaceViewStore:o,appParentStore:b,transaction:w,tasksBlockStore:k,location:{type:"prepend",before:B.id}})}}}]);