"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[24587],{53592:(e,t,o)=>{o.r(t),o.d(t,{attemptServerBackedLocalDuplicate:()=>b,serverBackedLocalDuplicate:()=>I});o(944114),o(581454);var a=()=>o(857639),r=()=>o(386164),n=()=>o(388821),i=()=>o(912720),c=()=>o(199378),s=()=>o(502800),l=()=>o(763824),d=()=>o(466614),u=()=>o(449506),p=()=>o(666144),m=()=>o(751156),g=()=>o(974233),v=()=>o(611191),f=()=>o(603815),y=()=>o(261450),S=()=>o(503388),_=()=>o(966152),h=()=>o(59110),M=()=>o(605605),k=()=>o(677733);function I(e){const{environment:t,sourceBlock:o,targetInMemoryRecordCache:a,transaction:r,options:i,targetSpaceId:c,installationImprint:s,templateInstallationMetadata:d={},shouldUseSynchronousDuplicationAPI:u,stopwatch:p}=e,m=performance.now();null==p||p.mark("server_duplicate_start");const g=e.copyIndicators??(0,S().U8)({environment:t,sourceBlocks:[o],targetRecordCache:a,transaction:r,spaceId:c});null==p||p.mark("create_copy_indicators");const v=l().yX();return r.postSubmitCallbacks.push((async e=>{if(null==p||p.mark("transaction_post_submit_callback"),e)return(0,_().P0)({environment:t,type:"server_duplicate_transaction_post_submit_callback_error",data:{copyIndicatorIds:g.map((e=>e.id)),error:e,targetSpaceId:c,options:i}}),void(0,S().Jc)(e,v);(0,S().Yj)(g),null==p||p.mark("initialize_copy_indicators_progress_state");const{success:a,size:l}=await b({environment:t,sourceBlockPointer:o,targetBlockStore:g[0],options:i,templateInstallationMetadata:d,stopwatch:p});if(a)return(0,y().E)({environment:t,success:!0,time:performance.now()-m,user_action:r.getUserActionForAnalyticsPurposesOnly(),is_duplication_local:!0,duplication_size:l,method:"server_backed_local_duplication"}),null==p||p.mark("server_backed_local_duplicate_success"),(0,S().dH)(g),void v.resolve({status:"success"});const f=await(0,k().performServerDuplicate)({environment:t,copyIndicators:g,sourceBlocks:[o],targetSpaceId:c,options:i,templateInstallationMetadata:d,installationImprint:s,shouldUseSynchronousDuplicationAPI:u,stopwatch:p});if((0,S().dH)(g),!f.success)return(0,S().uC)({environment:t,copyIndicators:g}),(0,_().P0)({environment:t,type:"server_duplicate_iterator_error",data:{errorMessage:f.errorMessage}}),void v.resolve({status:"error",errorMessage:f.errorMessage,error:f.error});(0,y().E)({environment:t,success:!0,time:performance.now()-m,user_action:r.getUserActionForAnalyticsPurposesOnly(),is_duplication_local:!0,duplication_size:f.size,method:"sbld_fallback_server_duplication"}),null==p||p.mark("server_duplicate_success"),v.resolve({status:"success",recordIdMap:f.recordIdMapJson?n().RecordMapPolymorphic.create(f.recordIdMapJson):void 0})})),{blockStores:g,onComplete:v.promise}}async function b(e){const{environment:t,sourceBlockPointer:o,targetBlockStore:l,options:y,templateInstallationMetadata:S,recordLimit:k=500,targetInMemoryRecordCache:I,stopwatch:b}=e;null==b||b.mark("attempt_server_backed_local_duplicate_start"),(0,_().JW)({environment:t,type:"server_duplicate_attempt_server_backed_local_duplicate",data:{sourceBlockPointer:o,targetBlockStore:l,targetSpaceId:l.getSpaceId(),options:y}});const C=(0,v().$J)(),T=await async function(e){const{environment:t,sourceBlockPointer:o,targetBlockStore:i,targetInMemoryRecordCache:c,options:l,enableLegacyTransclusionFixing:d,recordLimit:m}=e,v=c??i.inMemoryRecordCache,y={blockId:o.id,allowCopyCollections:!0,requireFullSubtree:!0,skipTransclusionContainerChildren:!l.deepCopyTransclusionContainers,allowCopyExternalObjectInstances:!l.convertExternalObjectInstancesToPlaceholders,includeLegacyTransclusionBlockValues:d,inMemoryRecordCache:v};let S;if(S=(0,h().loadLocalSubtree)(t,y),!S.recordMap&&v===t.defaultRecordCache.inMemoryRecordCache)try{(0,_().JW)({environment:t,type:"performInexactPagePreload",data:{message:"No local subtree found, performing performInexactPagePreload",loadLocalSubtreeArgs:y}}),await(0,f().A$)(t,{table:"block",id:o.id,spaceId:o.spaceId}),S=(0,h().loadLocalSubtree)(t,y)}catch(M){a().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"persistedRecordCachePreloadError",error:(0,s().convertErrorToLog)(M),data:{message:"Failed to preload subtree from persisted record cache"}})}S.recordMap||((0,_().JW)({environment:t,type:"loadLocalSubtreeApi",data:{message:"No local subtree found from previous attempts, attemping API call to loadBlockSubtree",currentLocalSubtreeResponse:S}}),S=await async function(e){const{environment:t,sourceBlockPointer:o,recordLimit:i,targetBlockStore:c,loadLocalSubtreeArgs:l}=e;try{const e=await u().callApi({eventName:"loadBlockSubtree",environment:t,data:{block:{id:o.id,spaceId:o.spaceId},shallow:!1,recordCountLimit:i},headers:(0,r().WS)({spaceId:o.spaceId})});if((0,_().JW)({environment:t,type:"loadBlockSubtreeApiResult",data:{message:"Result from loadBlockSubtree API call",subtreeResult:e,apiArgs:{block:{id:o.id,spaceId:o.spaceId},shallow:!1,recordCountLimit:i}}}),"success"===e.type){const o=n().RecordMapWithRole.create(e.data.subtreeRecordMap);return await p()._O({environment:t,inMemoryRecordCache:l.inMemoryRecordCache,recordMap:o,debugSource:"load_local_subtree_from_server"}),(0,h().loadLocalSubtree)(t,l)}{const t=(0,g().V)(e);a().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"loadBlockSubtreeFailure",data:{message:"Error fetching subtree",miscDataToConvertToString:{error:t,sourceBlockPointer:o,cacheSize:c.inMemoryRecordCache.size,targetBlockPointer:{id:c.id,spaceId:c.getSpaceId(),type:c.getType()}}}})}}catch(M){a().log({level:"error",from:"attemptServerBackedLocalDuplicate",type:"subtreeLoadError",error:(0,s().convertErrorToLog)(M),data:{message:"Error loading subtree",miscDataToConvertToString:{sourceBlockPointer:o,cacheSize:c.inMemoryRecordCache.size,targetBlockPointer:{id:c.id,spaceId:c.getSpaceId(),type:c.getType()}}}})}}({environment:t,sourceBlockPointer:o,recordLimit:m,targetBlockStore:i,loadLocalSubtreeArgs:y}));S&&!S.recordMap&&a().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"subtreeLoadFailure",data:{message:"Failed to load subtree",miscDataToConvertToString:{sourceBlockPointer:o,cacheSize:i.inMemoryRecordCache.size,reason:"error"===S.type?S.reason:void 0,targetBlockPointer:{id:i.id,spaceId:i.getSpaceId(),type:i.getType()},missingRecord:"error"===S.type?S.pointer:void 0}}});return S}({environment:t,sourceBlockPointer:o,targetBlockStore:l,targetInMemoryRecordCache:I,options:y,enableLegacyTransclusionFixing:C,recordLimit:k});if(null==b||b.mark("try_load_local_subtree_finished"),!T||!T.recordMap)return{success:!1,size:void 0,pageStore:l};var A;if(d().Lw({sourceSpaceId:o.spaceId,targetSpaceId:l.getSpaceId(),sourceBlockSubtree:T.recordMap}))return a().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"accessLockingWarning",data:{message:"Unable to perform local duplication",miscDataToConvertToString:{sourceBlockPointer:o,targetBlockPointer:{id:l.id,spaceId:l.getSpaceId(),type:l.getType()}}}}),null==b||b.mark("attempt_server_backed_local_duplicate_failure"),{success:!1,size:null===(A=T.recordMap)||void 0===A?void 0:A.getSize(),pageStore:l};for(const r of T.recordMap.getTables()){var B;if(r===i().yB||r===c().SC)return a().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"invalidRecordType",data:{message:"Local duplication does not support automation tables",miscDataToConvertToString:{sourceBlockPointer:o,targetBlockPointer:{id:l.id,spaceId:l.getSpaceId(),type:l.getType()}}}}),null==b||b.mark("attempt_server_backed_local_duplicate_failure"),{success:!1,size:null===(B=T.recordMap)||void 0===B?void 0:B.getSize(),pageStore:l}}try{var R;(0,_().JW)({environment:t,type:"server_backed_duplicate_start_transaction",data:{message:"Starting transactionActions.createAndCommit for localDuplicate",sourceBlockPointer:o,targetBlockPointer:{id:l.id,spaceId:l.getSpaceId(),type:l.getType()}}});const{serverCommitResult:e}=m().createAndCommit({userAction:"server_backed_local_duplicate",environment:t,canUndo:!0,isTemplateInstantiationTransaction:Boolean(S),perform:e=>(0,M().localDuplicate)({environment:t,sourceBlockId:o.id,targetBlockPointer:l.pointer,sourceBlockSubtree:T.recordMap,targetInMemoryRecordCache:l.inMemoryRecordCache,transaction:e,templateInstallationMetadata:S,stopwatch:b,options:{...y,preventLegacyTransclusions:C}})});return await e,null==b||b.mark("server_backed_local_duplicate_finished"),(0,_().JW)({environment:t,type:"server_duplicate_attempt_server_backed_local_duplicate_success",data:{targetSpaceId:l.getSpaceId(),options:y}}),{success:!0,size:null===(R=T.recordMap)||void 0===R?void 0:R.getSize(),pageStore:l,transactionPromise:e}}catch(P){var w;return a().log({level:"error",from:"attemptServerBackedLocalDuplicate",type:"subtreeLoadError",error:(0,s().convertErrorToLog)(P),data:{message:"Failed to load subtree",miscDataToConvertToString:{sourceBlockPointer:o,targetBlockPointer:{id:l.id,spaceId:l.getSpaceId(),type:l.getType()}}}}),{success:!1,size:null===(w=T.recordMap)||void 0===w?void 0:w.getSize(),pageStore:l}}}},252463:(e,t,o)=>{o.d(t,{zc:()=>u,CM:()=>m,UB:()=>p});o(898992),o(354520),o(581454);var a=()=>o(890409),r=()=>o(973647),n=()=>o(534177),i=()=>o(679924);const c={};var s=()=>o(862292),l=()=>o(909470),d=()=>o(546461);function u(e){const{automationActionStore:t,automationStore:o,formulaAnalyticsModule:i,formulasModule:c,simpleFormulasModule:s}=e,u=t.getModel(),p=o??t.getParentStore();if(!u||!p)return;const m=p.getActionStores().map((e=>e.getModel())).filter(n().O9),g=(0,d().To)(p);let v=[];return g&&r().Q.isSuccess(g)&&(v=g.value.valueTypes),(0,a()._f)({automationActionModel:u,automationActionModels:m,formulaAnalyticsModule:i,formulasModule:c,simpleFormulasModule:s,formulaTypecheckContextValues:v,getRecordModel:t.getRecordModel,featureGates:(0,l().i)()})}function p(e,t){const{automationStore:o,automationActionStore:a}=t;o.isTriggerType("event")||m(((t,r,n)=>{const s=u({automationActionStore:a,automationStore:o,formulaAnalyticsModule:r,formulasModule:t,simpleFormulasModule:n});s&&function(e,t,o,a,r,n){const s=c[o];s&&(clearTimeout(s),delete c[o]),c[o]=setTimeout((()=>{delete c[o],(0,i().v)(e,t,r,n)}),1e3*a)}(e,"automation_action_update",a.id,1,{automation_action:s,automation_action_id:a.id,automation_id:o.id})}))}function m(e){return Promise.all([s().T.formulas.load(),s().T.formulaAnalytics.load(),s().T.simpleFormulas.load()]).then((t=>{let[o,a,r]=t;e(o,a,r)})).catch((e=>{console.error("Error sending analytics for automations",e)}))}},324587:(e,t,o)=>{o.r(t),o.d(t,{addAutomationAction:()=>W,clearInvalidVariables:()=>j,createAutomation:()=>V,deleteAutomation:()=>X,disableAutomation:()=>Y,duplicateAutomation:()=>Q,duplicateAutomationAction:()=>J,enableAutomation:()=>H,insertEmptyTextInDuplicateBlockAction:()=>G,messages:()=>N,removeAutomationAction:()=>$,reorderAutomationActions:()=>K,restartAutomation:()=>U});o(16280),o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698),o(898992),o(354520),o(672577),o(803949),o(581454);var a=o.n(o(794148)),r=()=>o(244641),n=()=>o(908006),i=()=>o(422540),c=()=>o(890409),s=()=>o(192845),l=()=>o(390527),d=()=>o(522328),u=()=>o(433519),p=()=>o(247331),m=()=>o(134025),g=()=>o(696706),v=()=>o(912720),f=()=>o(199378),y=()=>o(161479),S=()=>o(919709),_=()=>o(496603),h=()=>o(183558),M=()=>o(973647),k=()=>o(534177),I=()=>o(722101),b=()=>o(44729),C=()=>o(246826),T=()=>o(725614),A=()=>o(751156),B=()=>o(479788),R=()=>o(2220),w=()=>o(780054),P=()=>o(568131),L=()=>o(909470),D=()=>o(594794),x=()=>o(695625),E=()=>o(546461),F=()=>o(252463),z=()=>o(770586),O=()=>o(190019);const N=(0,o(959013).YK)({genericErrorMessage:{id:"automations.buttonTrigger.genericErrorMessage",defaultMessage:"Button failed to execute"},open:{defaultMessage:"Open",id:"automations.buttonTrigger.open"},undo:{defaultMessage:"Undo",id:"automations.buttonTrigger.undo"},defaultConfirmationWorkflowText:{defaultMessage:"Are you sure you want to continue?",id:"automations.buttonTrigger.defaultConfirmationWorkflowText"},defaultContinueWorkflowMessage:{defaultMessage:"Continue",id:"automations.buttonTrigger.defaultContinueWorkflowMessage"},defaultStopWorkflowMessage:{defaultMessage:"Cancel",id:"automations.buttonTrigger.defaultStopWorkflowMessage"},errorQueryCollectionTooManyPages:{defaultMessage:"Button impacts too many pages",id:"automations.buttonTrigger.errorQueryCollectionTooManyPages"},errorRecordInTrash:{id:"automations.buttonTrigger.errorRecordInTrash",defaultMessage:"Button is editing a page in trash"}});function V(e){const{actionIds:t,automationId:o,automationName:r,environment:n,inMemoryRecordCache:i,parentPointer:c,transaction:s,trigger:l}=e,d=o??(0,D().Z1)({environment:n,table:v().yB,spaceId:c.spaceId}),u=C().eC({environment:n,inMemoryRecordCache:i??n.defaultRecordCache.inMemoryRecordCache,table:v().yB,transaction:s,value:{action_ids:t,alive:!0,id:d,parent_id:c.id,parent_table:c.table,properties:{name:r},space_id:c.spaceId,status:"active",trigger:l}});return a()(u.isTriggerType(l.type),"Trigger type mismatch"),u}function W(e){const{actionId:t,environment:o,intl:r,automationStore:i,actionType:s,transaction:l,insertionPoint:d,config:u,createDuplicateBlocksContainer:p=!0,builderType:m="sidebar"}=e,y=i.getSpaceId();if(!y)return;let _;if("duplicate_blocks"===s&&p){_=C().Wv({environment:o,inMemoryRecordCache:i.inMemoryRecordCache,transaction:l,type:"text"});const e=G({environment:o,contentStore:_.getContentStore(),transaction:l});n().default.afterNextFlush((()=>{const t=x().T.find((t=>g().L3.isEqual(t.props.store.pointer,e.pointer)));t&&T().setSelectionAtStart({store:t.props.store.getBlockTitleStore()})}))}const M=u??function(e){const{actionType:t,automationStore:o,intl:a}=e;if("modal_confirmation"===t)return{continue_button:{text:a.formatMessage(N.defaultContinueWorkflowMessage)},cancel_button:{text:a.formatMessage(N.defaultStopWorkflowMessage)},text:{type:"simple",value:(0,S().x9d)(a.formatMessage(N.defaultConfirmationWorkflowText))}};if("define_variables"===t){const e=(0,h().Ay)();return{values:{[e]:{name:(0,z().v)(o.getActionStores(),a.formatMessage(f().xC)),value:{type:"simple",value:[[""]]}}},variableIds:[e]}}}({actionType:s,automationStore:i,intl:r})??{},b=C().eC({environment:o,inMemoryRecordCache:i.inMemoryRecordCache,table:f().SC,transaction:l,value:{id:t,type:s,parent_id:i.id,parent_table:v().yB,alive:!0,space_id:y,config:M,blocks:_?[_.id]:[]}});return _&&I().BC({transaction:l,parentStore:b.getKeyStore("blocks"),appendStore:_}),!d||"afterActionId"in d?I().BC({transaction:l,parentStore:i.getActionIdsStore(),appendStore:b,after:null==d?void 0:d.afterActionId}):"beforeActionId"in d?I().Hs({transaction:l,parentStore:i.getActionIdsStore(),prependStore:b,before:d.beforeActionId}):(0,k().HB)(d),Z({transaction:l,automationStore:i}),(0,F().CM)(((e,t,a)=>{const r=(0,B().Q)(o),n=(0,F().zc)({automationActionStore:b,formulaAnalyticsModule:t,formulasModule:e,simpleFormulasModule:a});(0,k().O9)(n)&&(0,c().dW)(r,{automation_action:n,automation_action_id:b.id,automation_id:b.getParentId(),builder_type:m}),b.isDefined()&&(0,c().c_)(r,{automation_action_id:b.id,automation_action_type:b.getType(),automation_id:i.id,builder_type:m})})),a()(b.isType(s),"Action type mismatch"),b}function U(e){var t,o;const{automationStore:a,transaction:n}=e,i=a.getRecurrence();if(!i)return;const c=r().c9.now().plus({day:1}).startOf("day"),s={...i,start_date:c.toMillis(),end_condition:"date"===(null===(t=i.end_condition)||void 0===t?void 0:t.type)?{type:"date",end_at:(0,l().getNewEndTimestamp)(c,i.start_date,null===(o=i.end_condition)||void 0===o?void 0:o.end_at).toMillis()}:i.end_condition};C().zv({store:a,transaction:n,data:{status:"active"}}),C().zv({store:a.getKeyStore("trigger"),transaction:n,data:{recurrence:(0,l().convertFromUnpersistedRecurrenceConfig)(s)}})}function Q(e){const{actorPointer:t,environment:o,includeParenting:a,sourceAutomationStore:r,targetAutomationId:n,transaction:i}=e,c=r.getParentStore();if(!c||!c.isReady())throw new Error("Automation parent store not ready");const s=r.getValue(),l=r.getSpaceId();if(!(0,k().O9)(s)||!(0,k().O9)(l))throw new Error("Undefined automation value or space id");const d={},p={...(0,_().mg)(s),id:n??(0,D().Z1)({environment:o,table:v().yB,spaceId:(0,y().e)(l)})};d[r.id]=p.id,(0,k().O9)(p.action_ids)&&(0,k().EI)(p.action_ids)&&p.action_ids.forEach((e=>d[e]=(0,D().Z1)({environment:o,table:f().SC,spaceId:(0,y().e)(l)})));const m=e=>{let{requested:t}=e;const o=d[t.id];return(0,k().O9)(o)?{...t,id:o}:t};(0,u().i)({actor:t,duplicateRecord:p,options:{},mapper:m,originalRecord:s});const g=C().eC({environment:o,inMemoryRecordCache:r.inMemoryRecordCache,table:v().yB,transaction:i,value:p});a&&b().NI({childStore:g,parentStore:c,transaction:i});const S=r.getActionStores(),h=Promise.all(S.map((e=>{const t=d[e.id],{automationActionStore:a,onComplete:r}=J({environment:o,includeParenting:!1,mapper:m,sourceActionStore:e,targetAutomationActionId:t,transaction:i});return b().NI({childStore:a,parentStore:g,transaction:i}),r}))),M=h.then((e=>e.flat()));return{automationStore:g,onComplete:M}}function J(e){const{environment:t,includeParenting:o,insertionPoint:a,mapper:r,sourceActionStore:n,targetAutomationActionId:i,transaction:s}=e,l=n.getParentStore();if(!l||!l.isReady())throw new Error("Automation store is not ready");const u=n.getValue(),p=n.getSpaceId();if(!(0,k().O9)(u)||!(0,k().O9)(p))throw new Error("Undefined action value or space id");const m={...(0,_().mg)(u),id:i??(0,D().Z1)({environment:t,table:f().SC,spaceId:(0,y().e)(p)})},g=t.currentUser.id,v=n.inMemoryRecordCache.makeGetRecordRoleFn(g);(0,d().I)({duplicateRecord:m,getRecordRole:v,originalRecord:u,mapper:e=>(null==r?void 0:r(e))??e.requested,options:{},originOptions:{baseUrl:w().A.domainBaseUrl,publicDomainName:w().A.publicDomainName},duplicateBlocks:!1});const S=C().eC({environment:t,inMemoryRecordCache:n.inMemoryRecordCache,table:f().SC,transaction:s,value:m});o&&(!a||"afterActionId"in a?b().NI({after:null==a?void 0:a.afterActionId,childStore:S,parentStore:l,transaction:s}):"beforeActionId"in a?b().Ti({before:null==a?void 0:a.beforeActionId,childStore:S,parentStore:l,transaction:s}):(0,k().HB)(a),Z({transaction:s,automationStore:l}));const h=Promise.all(n.getBlockStores().map((e=>{const{blockStores:o,onComplete:a}=P().duplicateBlock({environment:t,preferDuplicateLocation:"local",stores:[e],targetSpaceId:(0,y().e)(e.pointer.spaceId),transaction:s,options:{addCopyName:!1,allowRedundancy:!0,deepCopyTransclusionContainers:!1,resolveTemplateVariables:!1}}),r=o[0];return b().NI({childStore:r,parentStore:S,transaction:s}),a}))),M=S.getModel();return(0,k().O9)(M)&&(0,F().CM)(((e,o,a)=>{const r=(0,B().Q)(t),n=(0,F().zc)({automationActionStore:S,formulaAnalyticsModule:o,formulasModule:e,simpleFormulasModule:a});(0,k().O9)(n)&&(0,c().dW)(r,{automation_action:n,automation_action_id:M.id,automation_id:M.parent_id,from:"duplicate"}),(0,c().c_)(r,{automation_action_id:M.id,automation_action_type:M.type,automation_id:l.id,from:"duplicate"})})),{automationActionStore:S,onComplete:h}}function K(e){const{automationStore:t,automationTypecheckModule:o,contextType:a,environment:r,formulasModule:n,from:i,intl:c,isSubscribed:s,movedActionId:l,newActionIds:d,transaction:u,pageStore:p}=e;C().zv({store:t,transaction:u,data:{action_ids:d}}),Z({automationStore:t,transaction:u});q({automationStore:t,transaction:u,typecheckResult:(0,O().Z)({environment:r,automationStore:t,automationTypecheckModule:o,contextType:a,formulasModule:n,intl:c,isSubscribed:s,pageStore:p})}),(0,R().u)({environment:r,event:{eventName:"automation_action_move",eventProperties:{automation_id:t.id,automation_action_id:l,from:i}}})}function $(e){const{actionStore:t,automationStore:o,automationTypecheckModule:a,contextType:r,environment:n,formulasModule:i,intl:s,isSubscribed:l,transaction:d,pageStore:u}=e,p=(0,O().Z)({environment:n,automationStore:o,automationTypecheckModule:a,contextType:r,formulasModule:i,intl:s,isSubscribed:l,pageStore:u});!function(e){const{automationActionStore:t,automationStore:o,environment:a,transaction:r,hasError:n=!1}=e;let i=t.getParentStore();if((0,k().O9)(o)){const e=t.getParentPointer();if(!(0,k().O9)(e))throw new Error("Automation action does not have a parent pointer");if(!g().L3.isEqual(e,o.pointer))throw new Error(`Automation action parent pointer does not match argument: ${g().L3.toKey(e)}, ${g().L3.toKey(o.pointer)}`);i=o}else if(!(0,k().O9)(i))throw new Error("Automation store is undefined");b().zz({childStore:t,parentStore:i,transaction:r});const s=t.getModel();(0,k().O9)(s)&&(0,F().CM)(((e,o,r)=>{const l=(0,B().Q)(a),d=(0,F().zc)({automationActionStore:t,formulaAnalyticsModule:o,formulasModule:e,simpleFormulasModule:r});(0,k().O9)(d)&&(0,c().YO)(l,{automation_action:d,automation_action_id:s.id,automation_id:s.parent_id,has_error:n}),(0,c().gW)(l,{automation_action_id:s.id,automation_action_type:s.type,automation_id:i.id,has_error:n})}))}({automationActionStore:t,environment:n,transaction:d,hasError:(M().Q.isSuccess(p)&&p.value.actionValidationFailures[t.id]||[]).length>0}),q({automationStore:o,transaction:d,typecheckResult:p})}function j(e){const{environment:t,automationStore:o,automationTypecheckModule:a,contextType:r,formulasModule:n,intl:i,isSubscribed:c,transaction:s,pageStore:l}=e;q({automationStore:o,transaction:s,typecheckResult:(0,O().Z)({environment:t,automationStore:o,automationTypecheckModule:a,contextType:r,formulasModule:n,intl:i,isSubscribed:c,pageStore:l})})}function Z(e){const{automationStore:t,transaction:o}=e;t.getSpaceId()&&t.getActionStores().forEach(((e,t)=>{var a;if(!e.isDefined())return;const r=e.getModel();r.isType("open_page")&&"url"===(null===(a=r.getConfig())||void 0===a||null===(a=a.target)||void 0===a?void 0:a.type)&&!(0,i().cQ)(t)&&C().zv({store:e.getConfigStore(),transaction:o,data:{target:null}})}))}function q(e){const{automationStore:t,transaction:o,typecheckResult:a}=e,r=t.getSpaceId(),n=t.getModel();if(r&&n&&!M().Q.isFail(a))for(const i of n.getActionIds()){const e=t.getRecordStore(t,{table:f().SC,id:i,spaceId:r});if(!e.isDefined())continue;const n=e.getModel(),c=new Set(a.value.actionInputValueTypes[i].map((e=>{if(e.kind===p().FormulaContextValueKind.Binding||e.kind===p().FormulaContextValueKind.ContextValue)return e.id;e.kind!==p().FormulaContextValueKind.ThisRow&&(0,k().HB)(e)})).filter(k().O9)),{value:l}=(0,s().G)({automationActionModel:n,baseUrl:w().A.domainBaseUrl,preventClearingConfig:!0,publicDomainName:w().A.publicDomainName,sourceSpaceId:r,visitors:{visitCollectionProperty:void 0,visitCollectionPropertyPointer:void 0,visitFormulaContextValue:e=>c.has(e)?{type:"keep"}:{type:"replace",value:void 0},visitFormulaPageProperty:void 0,visitRecordPointer:void 0}}),d=m().op.update({pointer:e.pointer,path:["config"],args:l.getConfig()??{}});A().applyOperation({store:e,operation:d,transaction:o})}}function G(e){const{environment:t,contentStore:o,transaction:a}=e,r=C().Wv({environment:t,type:"text",inMemoryRecordCache:o.inMemoryRecordCache,transaction:a,spaceId:o.pointer.spaceId});return I().BC({parentStore:o,appendStore:r,transaction:a}).childStore}function H(e){const{automationStore:t,environment:o,transaction:a}=e;C().zv({store:t,data:{status:"active"},transaction:a});const r=t.getModel();(0,k().O9)(r)&&(0,F().CM)(((e,a,n)=>{const i=(0,E().To)(t);let s=[];i&&M().Q.isSuccess(i)&&(s=i.value.valueTypes);const l=(0,B().Q)(o),d=(0,c().sp)({automationModel:r,formulaAnalyticsModule:a,formulasModule:e,formulaTypecheckContextValues:s,getRecordModel:t.getRecordModel,featureGates:(0,L().i)(),simpleFormulasModule:n});(0,c().Ah)(l,d)}))}function Y(e){const{automationStore:t,environment:o,status:a,transaction:r}=e,n=a??"disabled";C().zv({store:t,data:{status:n},transaction:r}),t.isTriggerType("recurrence")&&C().zv({store:t,data:{run_at:void 0},transaction:r});const i=t.getModel();(0,k().O9)(i)&&(0,F().CM)(((e,a,r)=>{const n=(0,E().To)(t);let s=[];n&&M().Q.isSuccess(n)&&(s=n.value.valueTypes);const l=(0,B().Q)(o),d=(0,c().sp)({automationModel:i,formulaAnalyticsModule:a,formulasModule:e,formulaTypecheckContextValues:s,getRecordModel:t.getRecordModel,featureGates:(0,L().i)(),simpleFormulasModule:r});(0,c().vN)(l,d)}))}function X(e){const{automationStore:t,environment:o,transaction:a}=e;C().zv({store:t,data:{alive:!1},transaction:a});const r=t.getModel();(0,k().O9)(r)&&(0,F().CM)(((e,a,n)=>{const i=(0,E().To)(t);let s=[];i&&M().Q.isSuccess(i)&&(s=i.value.valueTypes);const l=(0,B().Q)(o),d=(0,c().sp)({automationModel:r,formulaAnalyticsModule:a,formulasModule:e,formulaTypecheckContextValues:s,getRecordModel:t.getRecordModel,featureGates:(0,L().i)(),simpleFormulasModule:n});(0,c().Iv)(l,d)}))}},568131:(e,t,o)=>{o.r(t),o.d(t,{duplicateBlock:()=>b});o(16280),o(898992),o(823215),o(581454),o(737550);var a=()=>o(179034),r=()=>o(665344),n=()=>o(854150),i=()=>o(466614),c=()=>o(970330),s=()=>o(901389),l=()=>o(863168),d=()=>o(594794),u=()=>o(611191),p=()=>o(972435),m=()=>o(494043),g=()=>o(406792);class v{constructor(e){this.environment=void 0,this.metricName=void 0,this.startMetric=void 0,this.prevLapMetric=void 0,this.extraData=void 0,this.environment=e.environment,this.metricName=e.metricName,this.startMetric=g().default.mark(e.metricName),this.prevLapMetric=g().default.mark(e.metricName),this.extraData=e.extraData??{}}mark(e){g().default.measure(this.prevLapMetric,{environment:this.environment,data:{type:e,...this.extraData},sampleDecision:"default"}),this.prevLapMetric=g().default.mark(this.metricName)}end(){g().default.measure(this.startMetric,{environment:this.environment,data:{type:"total",...this.extraData},sampleDecision:"default"})}}var f=()=>o(765957),y=()=>o(227440),S=()=>o(630116),_=()=>o(261450),h=()=>o(59110),M=()=>o(605605),k=()=>o(53592),I=()=>o(677733);function b(e){const{environment:t,stores:o,transaction:g,targetSpaceId:b,preferDuplicateLocation:C,analyticsFrom:T,options:A,installationImprint:B,shouldAttemptServerBackedLocalDuplication:R,templateInstallationMetadata:w,shouldUseSynchronousDuplicationAPI:P}=e,L=new v({environment:t,metricName:"duplicate_block_stopwatch",extraData:{duplication_type:"local"===C?"local_duplication":R?"server_backed_local_duplication":P?"server_synchronous_duplication":"server_duplication",from:T}});if(0===o.length)throw new Error("Must duplicate at least one block");const D=o[0].getSpaceId();if(!o.every((e=>e.getSpaceId()===D)))throw new Error("All stores must be in the same space");if(o.length>1&&!o.every((e=>e.isTypedCollectionViewBlock())))throw new Error("Multiple source blocks only supported for grouped typed DB duplication");!function(e){const{environment:t,stores:o,analyticsFrom:a}=e;for(const i of o){var r;const e=i.getRecordStoreAtRootPath().getValue();if(!e)continue;const{currentSpaceStore:o}=f().default.getState();let s;o&&e.parent_table===n().yK&&(s=S().h4.createChildStore(o,{table:n().yK,id:e.parent_id})),c().v(t,{from:a??"copy",type:e.type,teamStore:s,is_toggleable:(0,m().Yt)(e.type,e.format),collection_id:i.getAssociatedCollectionId()??(null===(r=i.getCollectionStore())||void 0===r?void 0:r.id),new_page_id:"page"===e.type?i.id:void 0,creating_block_id:i.id,parent_collection_id:i.getParentCollectionIdUpToTwoLevels(),form_id:i.getFirstFormIdInCollectionViewBlock()})}}({environment:t,stores:o,analyticsFrom:T}),L.mark("track_create_blocks"),A.convertExternalObjectInstancesToPlaceholders=D!==b;const x=w&&(0,r().Fe)(w.source)&&w.isListedTemplate;if("local"===C&&1===o.length&&!x){const e=function(e){const{environment:t,store:o,sourceSpaceId:r,targetSpaceId:n,transaction:c,options:s,installationImprint:p,templateInstallationMetadata:m,stopwatch:g}=e,v=(0,u().$J)(),f=(0,h().loadLocalSubtree)(t,{blockId:o.id,inMemoryRecordCache:o.inMemoryRecordCache,allowCopyCollections:!1,requireFullSubtree:!0,skipTransclusionContainerChildren:!s.deepCopyTransclusionContainers,allowCopyExternalObjectInstances:!s.convertExternalObjectInstancesToPlaceholders,includeLegacyTransclusionBlockValues:v}).recordMap;if(null==g||g.mark("load_local_subtree"),!f||i().Lw({sourceSpaceId:r,targetSpaceId:n,sourceBlockSubtree:f}))return;const{targetBlockStore:y}=(0,M().localDuplicate)({environment:t,sourceBlockId:o.id,targetBlockPointer:(0,d().zP)({environment:t,table:a().ev,spaceId:n}),sourceBlockSubtree:f,targetInMemoryRecordCache:o.inMemoryRecordCache,options:{...s,preventLegacyTransclusions:v},transaction:c,installationImprint:p,templateInstallationMetadata:m,stopwatch:g});"ai_block"===y.getType()&&l().EF.setState(y.pointer.id);return{blockStores:[y],onComplete:Promise.resolve({status:"success"})}}({environment:t,store:o[0],options:A,sourceSpaceId:D,targetSpaceId:b,transaction:g,installationImprint:B,templateInstallationMetadata:w,stopwatch:L});if(e)return L.mark("try_local_duplication_success"),L.end(),e;L.mark("try_local_duplication_failure")}const E=t.defaultRecordCache.inMemoryRecordCache;if(o.some((e=>e.inMemoryRecordCache!==E)))throw new Error("Can only server duplicate from the environment.defaultRecordCache.inMemoryRecordCache.");let F;return y().A.state.online||s().f1(p().A.formatMessage(_().V.offlineError)),F=1===o.length&&R?(0,k().serverBackedLocalDuplicate)({environment:t,sourceBlock:{id:o[0].id,spaceId:o[0].getSpaceId()},targetInMemoryRecordCache:E,transaction:g,targetSpaceId:b,installationImprint:B,templateInstallationMetadata:w,stopwatch:L,shouldUseSynchronousDuplicationAPI:P,options:A}):(0,I().serverDuplicate)({environment:t,sourceBlocks:o.map((e=>({id:e.id,spaceId:e.getSpaceId()}))),targetInMemoryRecordCache:E,transaction:g,targetSpaceId:b,installationImprint:B,templateInstallationMetadata:w,stopwatch:L,shouldUseSynchronousDuplicationAPI:P,options:A}),async function(){const{blockStores:e,onComplete:t}=F;if("success"===(await t).status)for(const o of e)if("ai_block"===o.getType())return void l().EF.setState(o.pointer.id)}(),L.mark("duplicate_block_immediate_return"),F.onComplete.then((e=>{L.end()})),F}},770586:(e,t,o)=>{o.d(t,{v:()=>a});o(517642),o(658004),o(733853),o(845876),o(432475),o(515024),o(731698),o(898992),o(908872);function a(e,t){const o=e.reduce(((e,t)=>{if(t.isType("define_variables")){var o;const a=null===(o=t.getModel())||void 0===o?void 0:o.getVariables();if(a)for(const t of Object.values(a))e.add(t.name)}return e}),new Set),a=t.replace(/\s*\d+$/,"");let r=1,n=`${a} ${r}`;for(;o.has(n);)n=`${a} ${r}`,r++;return n}}}]);