(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[44425],{140290:(e,t,n)=>{const o=()=>n(194755),r=";",i=">",c="<";function s(e){let t="";e>0&&(t+=r);const n=e.toString();return n.length>1&&(t+=s(n.length)),t+=n,t}function a(e,t){if(!e)throw new Error(`Input is not a valid ELEN-encoded number: ${t}.`)}e.exports={encode:function(e){if("number"!=typeof e)throw new Error(`Value is not of type number: ${e}.`);const{sign:t,exponent:n,mantissa:r}=o().deconstruct(e);let a="";return a+=1===t?c:i,a+=s(1===t?o().MAX_EXPONENT-n:n),a+=s(1===t?o().MAX_MANTISSA-r:r),a},decode:function(e){if("string"!=typeof e)throw new Error(`Value is not of type string: ${e}.`);const{signLength:t,sign:n}=function(e,t){if(a(t<e.length,e),e[t]===i)return{signLength:1,sign:0};if(e[t]===c)return{signLength:1,sign:1};a(!1,e)}(e,0),{exponentLength:s,exponent:d}=function(e,t,n){if(a(n<e.length,e),"0"===e[n])return{exponentLength:1,exponent:0===t?0:o().MAX_EXPONENT};let i,c,s=n,d=0;for(;e[s]===r;)d+=1,s+=1;a(0!==d,e),c=1;for(;d>0;)i=c,c=Number.parseInt(e.substr(s,c)),a(c>0,e),s+=i,d-=1;return{exponentLength:s-n,exponent:0===t?c:o().MAX_EXPONENT-c}}(e,n,t),{mantissaLength:l,mantissa:u}=function(e,t,n){if(a(n<e.length,e),"0"===e[n])return{mantissaLength:1,mantissa:0===t?0:o().MAX_MANTISSA};let i,c,s=n,d=0;for(;e[s]===r;)d+=1,s+=1;a(0!==d,e),c=1;for(;d>0;)i=c,c=Number.parseInt(e.substr(s,c)),a(c>0,e),s+=i,d-=1;return{mantissaLength:s-n,mantissa:0===t?c:o().MAX_MANTISSA-c}}(e,n,t+s);return a(e.length===t+s+l,e),o().construct({sign:n,exponent:d,mantissa:u})}}},194755:e=>{const t=0xfffffffffffff;function n(e){return c(e[7],7)}function o(e){let t=0;return t+=i(127&e[7],4),t+=c(e[6],4),t}function r(e){let t=0;return t+=i(15&e[6],48),t+=i(e[5],40),t+=i(e[4],32),t+=i(e[3],24),t+=i(e[2],16),t+=i(e[1],8),t+=e[0],t}function i(e,t){return e*Math.pow(2,t)}function c(e,t){return Math.floor(e/Math.pow(2,t))}e.exports={MAX_EXPONENT:2047,MAX_MANTISSA:t,construct:function({sign:e,exponent:n,mantissa:o}){if(0!==e&&1!==e)throw new Error(`Invalid value for sign: ${e}.`);if("number"!=typeof n||n<0||2047<n)throw new Error(`Invalid value for exponent: ${n}.`);if("number"!=typeof o||o<0||t<o)throw new Error(`Invalid value for mantissa: ${o}.`);const r=new ArrayBuffer(8),s=new Float64Array(r),a=new Uint8Array(r);return function(e,t){t[7]|=i(e,7)}(e,a),function(e,t){t[7]|=c(e,4),t[6]|=i(15&e,4)}(n,a),function(e,t){t[6]|=255&c(e,48),t[5]|=255&c(e,40),t[4]|=255&c(e,32),t[3]|=255&c(e,24),t[2]|=255&c(e,16),t[1]|=255&c(e,8),t[0]|=255&e}(o,a),s[0]},deconstruct:function(e){if("number"!=typeof e)throw new Error(`Value is not of type number: ${e}.`);const t=new ArrayBuffer(8),i=new Float64Array(t),c=new Uint8Array(t);return i[0]=e,{sign:n(c),exponent:o(c),mantissa:r(c)}}}},352733:(e,t,n)=>{"use strict";n.d(t,{j:()=>i,n:()=>c});var o=()=>n(671593),r=()=>n(416845);function i(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const i=(0,o().tf)(e,t,n);if(i)throw new(r().yI4)(i.message)}function c(e,t){const n=(0,o().tf)(e,t);if(void 0!==n)throw new(r().yI4)(n.message);return t}},408863:function(e,t,n){"use strict";var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,r)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.jsonCodec=t.Codec=t.MaxEncoding=t.MinEncoding=t.MAX=t.MIN=t.ObjectLegacyEncoding=t.ObjectEncoding=t.ArrayEncoding=t.NumberEncoding=t.StringEncoding=t.BooleanEncoding=t.NullEncoding=void 0;const c=i(n(140290)),s=()=>n(881270);t.NullEncoding={match:e=>null===e,encode:()=>"",decode:()=>null,compare:()=>0},t.BooleanEncoding={match:e=>!0===e||!1===e,encode:e=>JSON.stringify(e),decode:e=>JSON.parse(e),compare:s().compare},t.StringEncoding={match:e=>"string"==typeof e,encode:e=>e,decode:e=>e,compare:s().compare},t.NumberEncoding={match:e=>"number"==typeof e,encode:e=>c.encode(e),decode:e=>c.decode(e),compare:s().compare},t.ArrayEncoding={match:e=>Array.isArray(e),encode:(e,t)=>e.map(((e,n)=>t(e).replace(/\x01/g,"").replace(/\x00/g,"\0")+"\0")).join(""),decode:(e,t)=>{if(""===e)return[];const n=/(\x01(\x01|\x00)|\x00)/g,o=[];let r=0;for(;;){const i=n.exec(e);if(null===i)return o;if(""===i[0][0])continue;const c=i.index,s=t(e.slice(r,c).replace(/\x01\x01/g,"").replace(/\x01\x00/g,"\0"));o.push(s),r=c+1}},compare:(e,t,n)=>{const o=Math.min(e.length,t.length);for(let r=0;r<o;r++){const o=n(e[r],t[r]);if(0!==o)return o}return(0,s().compare)(e.length,t.length)}},t.ObjectEncoding={match:e=>"object"==typeof e&&null!==e&&Object.getPrototypeOf(e)===Object.prototype,encode:(e,n)=>{const o=function(e){const t=[];for(const n of e)for(const e of n)t.push(e);return t}(Object.entries(e).sort((([e],[t])=>(0,s().compare)(e,t))));return t.ArrayEncoding.encode(o,n)},decode:(e,n)=>{const o=function(e,t){const n=[];for(let o=0;o<e.length;o+=t){const r=e.slice(o,o+t);n.push(r)}return n}(t.ArrayEncoding.decode(e,n),2),r={};for(const[t,i]of o)r[t]=i;return r},compare:(e,t,n)=>{const o=Object.entries(e).sort((([e],[t])=>(0,s().compare)(e,t))),r=Object.entries(t).sort((([e],[t])=>(0,s().compare)(e,t))),i=Math.min(o.length,r.length);for(let c=0;c<i;c++){const[e,t]=o[c],[i,a]=r[c],d=(0,s().compare)(e,i);if(0!==d)return d;const l=n(t,a);if(0!==l)return l}return(0,s().compare)(o.length,r.length)}},t.ObjectLegacyEncoding={match:e=>"object"==typeof e&&null!==e&&Object.getPrototypeOf(e)===Object.prototype,encode:(e,n)=>{const o=Object.entries(e).sort((([e],[t])=>(0,s().compare)(e,t)));return t.ArrayEncoding.encode(o,n)},decode:(e,n)=>{const o=t.ArrayEncoding.decode(e,n),r={};for(const[t,i]of o)r[t]=i;return r},compare:t.ObjectEncoding.compare},t.MIN=Symbol("min"),t.MAX=Symbol("max"),t.MinEncoding={match:e=>e===t.MIN,encode:()=>"",decode:()=>t.MIN,compare:()=>0},t.MaxEncoding={match:e=>e===t.MAX,encode:()=>"",decode:()=>t.MAX,compare:()=>0};class a{constructor(e){this.encodings=e,this.encode=e=>{for(const[t,n]of Object.entries(this.encodings))if(n.match(e))return t+n.encode(e,this.encode);throw new Error(`Missing encoding for value: ${e}`)},this.decode=e=>{const t=e[0],n=e.slice(1);for(const[o,r]of Object.entries(this.encodings))if(o===t)return r.decode(n,this.decode);throw new Error(`Missing encoding for value: ${e}`)},this.compare=(e,t)=>{if(e===t)return 0;let n,o;for(const[r,i]of Object.entries(this.encodings))if(!n&&i.match(e)&&(n=[r,i]),!o&&i.match(t)&&(o=[r,i]),n&&o)break;if(!n)throw new Error(`Missing encoding for value: ${e}`);if(!o)throw new Error(`Missing encoding for value: ${t}`);return n[0]!==o[0]?(0,s().compare)(n[0],o[0]):n[1].compare(e,t,this.compare)};for(const t in e)if(1!==t.length)throw new Error(`Encoding prefix is not 1 byte: ${t}`)}}t.Codec=a,t.jsonCodec=new a({"\0":t.MinEncoding,b:t.NullEncoding,c:t.ObjectEncoding,d:t.ArrayEncoding,e:t.NumberEncoding,f:t.StringEncoding,g:t.BooleanEncoding,"Ã¿":t.MaxEncoding})},430837:function(e,t,n){"use strict";var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,r)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||o(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),r(n(408863),t)},722146:(e,t,n)=>{"use strict";n.r(t),n.d(t,{cacheSidebarImagesDebounced:()=>W,loadRemotePageAndImagesBatched:()=>F});n(16280),n(944114),n(517642),n(658004),n(733853),n(845876),n(432475),n(515024),n(731698),n(898992),n(354520),n(581454);var o=()=>n(386164),r=()=>n(388821),i=()=>n(179034),c=()=>n(430837),s=()=>n(534177),a=()=>n(638681),d=()=>n(604341);const l=a().lazy((()=>a().union([a().tuple([a().instanceOf(b),a().instanceOf(Date),a().instanceOf(b),a().instanceOf(b),a().string()]),a().tuple([a().instanceOf(b),a().instanceOf(Date),a().instanceOf(b),a().isNull(),a().isNull()])]))),u=Symbol("SyncCursor");let f;const g=-2n,p={BEFORE_ALL_OFFSETS:g,atStart:()=>({type:1,timestamp:-1,offset:g}),atTimestamp:e=>({type:1,timestamp:e,offset:g}),encode:function(e){let t;if(e.pointer){const o="number"==typeof e.pointer.table?e.pointer.table:(0,n(628536).vi)(e.pointer.table);t=[new b(e.type,16),new Date(e.timestamp),new b(e.offset,64),new b(o,16),e.pointer.id]}else t=[new b(e.type,16),new Date(e.timestamp),new b(e.offset,64),null,null];return(0,s().GV)(w.encode(t),u)},decode:function(e){try{const t=w.decode(e);(0,n(352733).j)(l,t);const[o,r,i,c,s]=t,a=o.toFloat64(),d=1;if(a!==d)throw new Error(`decoded type from payload[0]: is \`${a}\`, should be \`${d}\``);const u={type:a,timestamp:r.getTime(),offset:i.value};return c&&null!==s&&(u.pointer={table:c.toFloat64(),id:s}),u}catch(t){const e=(0,n(319625).A)(t);throw e.message=`SyncCursor decode error: ${e.message}`,e}},encodedStartCursor:()=>f??=p.encode(p.atStart())};function m(e,t){return e<t?-1:e>t?1:0}class h{constructor(e){this.prefix="i",this.match=e=>Boolean(e&&e instanceof b&&e.bits===this.bits),this.compare=(e,t)=>m(e.value,t.value),this.encode=e=>this.encodeBigint(e.value),this.decode=e=>new b(this.decodeBigint(e),this.bits),this.encodeBigint=e=>{this.assertFitsBits(e);const t=e<0n?"-":"",n=e<0n?2n**BigInt(this.bits)+e:e;if(n<0n)throw new Error(`Expected abs value twos compliment >0, instead was: ${n}`);const o=n.toString(16).padStart(this.bits/4,"0");return`${t}${this.prefix}${o}`},this.decodeBigint=e=>{const t="-"===e[0]?e.slice(1+this.prefix.length):e.slice(this.prefix.length),n=BigInt("0x"+t);return BigInt.asIntN(this.bits,n)},this.assertFitsBits=e=>{const t=BigInt.asIntN(this.bits,e);if(t!==e)throw new Error(`IntN bigint out of range for IntN<${this.bits}>: truncated to ${t}, expected ${e}`)},this.bits=e}}class b{constructor(e,t){this.value=void 0,this.bits=t,this.value=BigInt(e)}toFloat64(){if(this.value>BigInt(Number.MAX_SAFE_INTEGER)||this.value<BigInt(Number.MIN_SAFE_INTEGER))throw new Error(`IntN value ${this.value} out of range ${Number.MIN_SAFE_INTEGER}-${Number.MAX_SAFE_INTEGER} for Float64`);return Number(this.value)}toString(){return`IntN<${this.bits}>(${this.value})`}}const v={match:e=>Boolean(e&&e instanceof Date),compare:(e,t)=>m(e,t),encode:e=>e.toISOString(),decode:e=>new Date(e)},w=new(c().Codec)({"\0":c().MinEncoding,'"':c().StringEncoding,"#":c().NumberEncoding,"%":v,2:new h(16),4:new h(32),8:new h(64),"?":c().BooleanEncoding,"[":c().ArrayEncoding,"{":c().ObjectEncoding,"Ã¾":c().NullEncoding,"Ã¿":c().MaxEncoding});(0,d().exposeDebugValue)("SyncCursor",p),(0,d().exposeDebugValue)("SyncCursorCodec",w);var y=()=>n(449412),I=()=>n(763824),M=()=>n(449506),E=()=>n(974233),R=()=>n(494043),S=()=>n(796621),C=()=>n(217429),P=()=>n(700500),_=()=>n(142748);function A(e,t,n){return n.getModelsByTable(i().ev).filter((e=>((e,n)=>{if(e.getType()!==P().xd.collectionView)return!1;const o=(0,_().MR)(e.pointer,n);for(const r of o.slice(1))if(r.id===t)return!0;return!1})(e,n))).map((e=>e.id))}function O(e){const{pageId:t,cellId:n}=e;return[t,n||"NoCellId","EmptyStack"].join("|")}function x(e){const{cursorItem:t,pageId:n,cellId:o}=e,{id:r,table:i,index:c}=t;return[n,o||"NoCellId",r,i,c].join("|")}n(964979);var N=()=>n(825237),T=()=>n(651124),j=()=>n(837420),B=()=>n(919709),k=()=>n(92400),$=()=>n(179266);function D(e){var t;let{icon:n,permissionRecord:o,recordMap:r,environment:i}=e;const c=(0,T().WO)(n);switch(c.type){case"custom_emoji":const e=(null==r?void 0:r.getModel(c.emoji.pointer))??i.defaultRecordCache.inMemoryRecordCache.getRecordModel({pointer:c.emoji.pointer,userId:i.currentUser.id});if(!e)return;const a=null===(t=e.getIconIfAlive())||void 0===t?void 0:t.icon;if(!a)return;return{url:a,permissionRecord:c.emoji.pointer};case"url":return{url:n,permissionRecord:o};case"unicode_emoji":case"notion_icon":case"app_package_asset":return;default:(0,s().HB)(c)}}async function q(e){let{urlAndPermissionRecords:t,environment:n,abortSignal:o}=e;await(0,I().lX)(t,5,(async e=>{let{url:t,permissionRecord:r}=e;const i=await(0,$().L)({url:t,isAuthenticated:!0,permissionRecord:r},n),c=N().MU(i);if(c)try{await fetch(c,{signal:o})}catch(s){throw s instanceof DOMException&&"AbortError"===s.name?new(k().f):s}}))}const V=100;async function F(e){var t;const{request:n,environment:o,abortSignal:r,skipBatching:c}=e,a=performance.now();let d=0;const l=X();if(l<1)return{imageCount:0,downloadedVersion:void 0,downloadedRecordChangeTimestamp:void 0,collectionViewBlockIds:[],pageDownloadTime:0,imagesDownloadTime:0,loadPageChunkV2ForOfflineCount:0};const u=c?1:l;let f;switch(n.type){case"syncOfflinePages":f=await U.getInstance().syncPage({batchSize:u,request:n,environment:o,abortSignal:r});break;case"syncPageRecordSinceTimestamp":f=await z.getInstance().syncPage({batchSize:u,request:n,environment:o,abortSignal:r});break;default:(0,s().HB)(n)}r.throwIfAborted();const g=performance.now(),p=f.recordMap.getModel({table:i().ev,id:n.page.id});if(p){const e=function(e){let{blockModel:t,environment:n,recordMap:o}=e;const r=[],i=[t.pointer,...t.getRenderableContentPointers()];if(t.getType()===P().xd.page){const e=t.getFormatValue("page_cover");e&&r.push({url:e,permissionRecord:t.pointer})}for(;i.length;){const e=i.shift();if(!e)continue;const t=(null==o?void 0:o.getModel(e))??n.defaultRecordCache.inMemoryRecordCache.getRecordModel({pointer:e,userId:n.currentUser.id});if(t){if(t.getType()===P().xd.image){const e=t.getFormatValue("display_source");e&&r.push({url:e,permissionRecord:t.pointer})}else if(t.getType()===P().xd.page||t.getType()===P().xd.callout){const e=t.getFormatValue("page_icon");if(e){const i=D({icon:e,permissionRecord:t.pointer,recordMap:o,environment:n});i&&r.push(i)}}else if(t.getType()===P().xd.collectionView){const e=t.getCollectionPointer();if(e){const i=(null==o?void 0:o.getModel(e))??n.defaultRecordCache.inMemoryRecordCache.getRecordModel({pointer:e,userId:n.currentUser.id});if(i){const e=i.getRawIcon();if(e){const i=D({icon:e,permissionRecord:t.pointer,recordMap:o,environment:n});i&&r.push(i)}}}}else if((0,P().Db)(t.getType(),t.getFormat())){const e=t.getProperties().title,i=B().air(e,{spaceId:void 0,inlinePageLink:void 0}).filter((e=>e.table===j().e));for(const t of i){const e=(null==o?void 0:o.getModel(t))??n.defaultRecordCache.inMemoryRecordCache.getRecordModel({pointer:t,userId:n.currentUser.id});if(e){var c;const n=null===(c=e.getIconIfAlive())||void 0===c?void 0:c.icon;n&&r.push({url:n,permissionRecord:t})}}}if(!t.isNavigableBlock())if(t.getType()===P().xd.transclusionReference){const e=t.getTransclusionReferenceTargetPointer();if(!e)continue;const r=(null==o?void 0:o.getModel(e))??n.defaultRecordCache.inMemoryRecordCache.getRecordModel({pointer:e,userId:n.currentUser.id});if(!r)continue;i.push(...r.getRenderableContentPointers())}else i.push(...t.getRenderableContentPointers())}}return r}({blockModel:p,environment:o,recordMap:f.recordMap});r.throwIfAborted(),d=e.length,await q({urlAndPermissionRecords:e,environment:o,abortSignal:r})}r.throwIfAborted();const m=g-a,h=performance.now()-g;return{imageCount:d,downloadedVersion:f.serverPageVersionsByPageId[n.page.id],downloadedRecordChangeTimestamp:null===(t=f.serverPageRecordChangeTimestampsByPageId)||void 0===t?void 0:t[n.page.id],collectionViewBlockIds:A(0,n.page.id,f.recordMap),pageDownloadTime:m,imagesDownloadTime:h,loadPageChunkV2ForOfflineCount:f.syncOfflinePagesCount}}function X(){return C().default.getConfigKey("offline_mode_settings","download_batch_size")}class L{constructor(e){this.queueBySize=new(n(99895).G)((e=>this.createQueue(e))),this.performRequests=e}async enqueue(e,t){if(e<=1){const[e]=await this.performRequests([t]);return e}return this.queueBySize.get(e).enqueue(t)}createQueue(e){return new(n(56322).A)({performRequests:this.performRequests,batchSize:e,maxWorkers:1,requestDelayMs:100})}}class U{constructor(){this.queue=new L((async e=>{const t=await async function(e){const{requestBatch:t,environment:n,abortSignal:c}=e,s=C().default.checkGate({gateName:"offline_batched_sync_traverse_toggle_blocks_on_server"}),{trackRequests:a,filterNextRequests:d}=function(){const e=new Set([]),t=new Set([]);return{trackRequests:function(n){for(const{page:o,cellId:r,cursor:i}of n){0===i.stack.length&&e.add(O({pageId:o.id,cellId:r}));for(const e of i.stack)for(const n of e)t.add(x({cursorItem:n,pageId:o.id,cellId:r}))}},filterNextRequests:function(n){const o=[];for(const r of n){const{cellId:n,page:i}=r,c=[];0===r.cursor.stack.length&&(e.has(O({pageId:i.id,cellId:n}))||o.push(r));for(const e of r.cursor.stack){const o=[];for(const r of e){const e=x({cursorItem:r,pageId:i.id,cellId:n});t.has(e)||o.push(r)}o.length>0&&c.push(o)}const s=n?{stack:c,cellId:n}:{stack:c};c.length>0&&o.push({...r,cursor:s})}return o}}}(),l=[],u={};let f=0,g=t.map((e=>{let{page:t,offlinePageMetadata:n}=e;return{page:t,lastDownloadedVersion:null==n?void 0:n.lastDownloadedVersion,cursor:{stack:[]}}}));for(;g.length>0&&f<V;){a(g);const e=g.map((e=>({...e,headers:(0,o().WS)({recordId:e.page.id,spaceId:e.page.spaceId,cellId:e.cellId})}))),t=(0,o().E5)(e),p=await I().lX(t.entries(),10,(async e=>{let[t,o]=e;const r=X();return await I().vA(o,r,(async e=>{const o=await M().callApi({eventName:"syncOfflinePages",environment:n,data:{requests:e.map((e=>{let{cellId:t,...n}=e;return n})),verticalColumns:n.device.isMobile,shouldTraverseToggles:s},headers:t,inMemoryRecordCache:S().o,abortSignal:c});return f++,o}))})),m=[];for(const o of p.flat()){if("failed"===o.type)throw new Error(`Batch download failed: ${(0,E().V)(o)}`);const e=r().RecordMapWithRole.create(o.data.recordMap);l.push(e);for(const[t,n]of Object.entries(o.data.serverPageVersionsByPageId))u[t]=n;for(const t of o.data.nextChunks)for(const e of t.cursors){const{cellId:n}=e;m.push({page:t.page,lastDownloadedVersion:void 0,cursor:e,cellId:n})}if(!s){const t=e.getModelsByTable(i().ev).filter((e=>R().Yt(e.getType(),e.getFormat())));m.push(...t.map((e=>({page:{id:e.id,spaceId:e.getSpaceId()},cursor:{stack:[]},lastDownloadedVersion:void 0}))))}for(const t of o.data.pagesToDelete){const{currentUser:{id:e},defaultRecordCache:{persistedRecordCache:o}}=n;e&&o&&(null==o||o.deleteOfflineActionsAndCleanUp({userId:e,originPageId:void 0,impactedPageIds:[t]}))}}g=d(m)}f>=V&&y().O8(new Error("syncOfflinePages was called too many times in one batch."),{from:"loadRemotePages",type:"infiniteFetchPrevented",data:{}});return{recordMap:r().RecordMapWithRole.merge(l),serverPageVersionsByPageId:u,serverPageRecordChangeTimestampsByPageId:void 0,syncOfflinePagesCount:f}}({environment:e[0].environment,requestBatch:e.map((e=>e.request)),abortSignal:AbortSignal.any(e.map((e=>e.abortSignal)))});return e.map((()=>t))}))}static getInstance(){return U.instance??=new U}syncPage(e){return this.queue.enqueue(e.batchSize,e)}}U.instance=void 0;class z{constructor(){this.queue=new L((e=>this.performSyncPageRecordSinceTimestampRequests(e)))}static getInstance(){return z.instance??=new z}syncPage(e){return this.queue.enqueue(e.batchSize,e)}async performSyncPageRecordSinceTimestampRequests(e){if(0===e.length)return[];const{environment:t,abortSignal:n}=e[0],c=r().RecordMapWithRole.create(),s=new Map;let a=0;for(const r of e){const{page:e,offlinePageMetadata:t}=r.request;if(s.has(e.id))continue;const n=null!=t&&t.lastDownloadedRecordChangeTimestamp?p.encode(p.atTimestamp(null==t?void 0:t.lastDownloadedRecordChangeTimestamp)):p.encodedStartCursor();s.set(e.id,{page:e,shouldDelete:!1,nextCursor:n,done:!1,initialCursor:n,downloadedRecordChangeTimestamp:void 0,headers:(0,o().WS)({recordId:e.id,spaceId:e.spaceId,cellId:void 0})})}const d=new Set(s.keys()),l=async e=>{const r=(0,o().E5)(e.map((e=>{const t=s.get(e);if(!t)throw new Error("Page state not found");return t})).filter((e=>e.nextCursor)));return await I().lX(r.entries(),10,(async e=>{let[o,r]=e;const i=X();return await I().vA(r,i,(async e=>{const r=await M().callApi({eventName:"syncPageRecordSinceTimestamp",environment:t,data:{requests:e.map((e=>{let{page:t,nextCursor:n}=e;if(!n)throw new Error(`Internal sync error: page ${t.id} has no next cursor`);return{page:t,cursor:n}}))},headers:o,inMemoryRecordCache:S().o,abortSignal:n});return a++,r}))}))};for(;d.size>0&&a<V;){const e=await l(Array.from(d));for(const n of e.flat()){if("failed"===n.type)throw new Error(`Batch download failed: ${(0,E().V)(n)}`);const e=r().RecordMapWithRole.create(n.data.recordMap);c.assign(e);const o=[];for(const[t,r]of Object.entries(n.data.results)){const e=s.get(t);if(!e)throw new Error(`Server returned unexpected page id: ${t}`);e.shouldDelete=e.shouldDelete||r.shouldDelete,e.nextCursor=r.nextCursor,e.done=!r.nextCursor||r.shouldDelete,e.downloadedRecordChangeTimestamp=r.lastCursor?p.decode(r.lastCursor).timestamp:void 0,e.done&&d.delete(t),e.shouldDelete&&o.push(t)}for(const n of o){const{currentUser:{id:e},defaultRecordCache:{persistedRecordCache:o}}=t;e&&o&&(null==o||o.deleteOfflineActionsAndCleanUp({userId:e,originPageId:void 0,impactedPageIds:[n]}))}}}a>=V&&y().O8(new Error("syncPageRecordSinceTimestamp was called too many times in one batch."),{from:"loadRemotePages",type:"infiniteFetchPrevented",data:{}});const u={},f={};for(const[o,r]of s.entries()){void 0!==r.downloadedRecordChangeTimestamp&&(f[o]=r.downloadedRecordChangeTimestamp);const e=c.getModel({table:i().ev,id:o});e&&(u[o]=e.getVersion())}const g={recordMap:c,serverPageVersionsByPageId:u,serverPageRecordChangeTimestampsByPageId:f,syncOfflinePagesCount:a};return e.map((()=>g))}}z.instance=void 0;const W=(0,n(496603).sg)((async function(e){let{pageStores:t,environment:o,currentUserId:r,currentSpaceStore:i,abortSignal:c}=e;r&&i&&(c.aborted||await navigator.locks.request(`sidebar_images_${r}_${i.id}`,{ifAvailable:!0},(async e=>{var s;if(!e)return;const a=[],d=null===(s=(0,n(640653).c2)(o,i))||void 0===s?void 0:s.icon;if(d){const e=D({icon:d,permissionRecord:i.pointer,recordMap:void 0,environment:o});e&&a.push(e)}for(const n of t){var l;const e=null===(l=n.getIcon())||void 0===l?void 0:l.icon;if(e){const t=D({icon:e,permissionRecord:n.pointer,recordMap:void 0,environment:o});t&&a.push(t)}const t=n.getTitleValue(),i=B().air(t,{spaceId:void 0,inlinePageLink:void 0}).filter((e=>e.table===j().e));for(const n of i){const e=o.defaultRecordCache.inMemoryRecordCache.getRecordModel({pointer:n,userId:r});if(e){var u;const t=null===(u=e.getIconIfAlive())||void 0===u?void 0:u.icon;t&&a.push({url:t,permissionRecord:n})}}c.throwIfAborted()}await q({urlAndPermissionRecords:a,environment:o,abortSignal:c}),(0,n(2220).u)({environment:o,event:{eventName:"offline_cache_sidebar_images",eventProperties:{number_of_images_fetched:a.length}}})})))}),1e4)},881270:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.compare=void 0,t.compare=function(e,t){return e>t?1:e<t?-1:0}}}]);