"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[84084],{954220:(e,a,s)=>{s.r(a),s.d(a,{computeSimilarUserRecentPagesState:()=>g,fetchUserSignals:()=>v,initializeAndLoadAllUserSignals:()=>m,refreshAndBroadcastSimilarUserSignals:()=>I,setUserSignals:()=>p});s(944114),s(898992),s(803949),s(581454);var t=()=>s(386164),i=()=>s(496603),n=()=>s(449506),r=()=>s(187778),d=()=>s(217429),l=()=>s(20199),o=()=>s(314648);const c=5*s(720665).Xb;function u(e){const a=d().default.getEligibleGroup({experimentId:e,parameter:"editedPagesLookbackDays",defaultGroup:"control"});return void 0===a||"control"===a?"1":a}function g(e){const a={};return e.forEach((e=>{let{userId:s,recentPages:t,similarity:n}=e;if(!t.length)return;const r=i().$z(t,(e=>{let{pageId:a}=e;return a}));Object.entries(r).forEach((e=>{let[t,i]=e;const r=i.map((e=>{let{visitedAt:a}=e;return a})).sort(((e,a)=>a-e));a[t]||(a[t]={pageId:t,sortedSimilarUserSignals:[]}),a[t].sortedSimilarUserSignals.push({userId:s,similarity:n,visitedAt:r})}))})),Object.values(a).forEach((e=>{e.sortedSimilarUserSignals.sort(((e,a)=>a.similarity-e.similarity))})),a}async function I(e){var a;const{spaceId:s,userId:t,environment:i}=e,n=await v({spaceId:s,environment:i,signalsOverride:[{name:"similarUserRecentPages",includeRecords:!0},{name:"similarUsersEditedPages",includeRecords:!0,lookbackDays:1}]});void 0!==n&&(p({spaceId:s,userId:t,environment:i,newSignals:n,initialize:!1}),await(null===(a=l().A.state.broadcastChannel)||void 0===a?void 0:a.postMessage({type:"userSignals",data:n})))}async function m(e){const{spaceId:a,userId:s,environment:t,refreshTimer:i=c}=e,n=await v({spaceId:a,environment:t});if(void 0===n)return;p({spaceId:a,userId:s,environment:t,newSignals:n,initialize:!0});var r;"on"===d().default.getEligibleGroup({experimentId:"search_refresh_user_signals",defaultGroup:"control"})?(await o().default.waitUntil((()=>Boolean(o().default.getUserSignals({spaceId:a,userId:s})))),null===(r=l().A.state.broadcastChannel)||void 0===r||r.addEventListener("message",(e=>{"userSignals"===e.type&&p({spaceId:a,userId:s,environment:t,newSignals:e.data,initialize:!1})})),await l().A.waitUntil((()=>Boolean(l().A.state.elector))),l().A.state.elector.awaitLeadership().then((()=>{o().default.update((e=>{e.refreshIntervalId&&window.clearInterval(e.refreshIntervalId);const n=window.setInterval((async()=>{await I({spaceId:a,userId:s,environment:t})}),i);return{...e,refreshIntervalId:n}}))}))):o().default.update((e=>{e.refreshIntervalId&&window.clearTimeout(e.refreshIntervalId);const n=window.setTimeout((async()=>{const e=await v({spaceId:a,environment:t});void 0!==e&&p({spaceId:a,userId:s,environment:t,newSignals:e,initialize:!1})}),i);return{...e,refreshIntervalId:n}}))}function p(e){const{spaceId:a,userId:s,environment:t,newSignals:i,initialize:n}=e;i&&(o().default.setUserSignals({spaceId:a,userId:s,userSignals:i,initialize:n}),r().G(t,n?"userSignalsInitialization":"userSignalsReload"))}async function v(e){const{spaceId:a,environment:s,signalsOverride:r}=e,d=u("search-local-edited-pages-max"),l=u("search-local-sim-users-edited-pages-max"),c=parseInt(l),I=parseInt(d),m=await n().callApi({eventName:"getUserSignals",environment:s,data:{spaceId:a,signals:r??[{name:"similarUserRecentPages",includeRecords:!0},{name:"topPages7dPageView",includeRecords:!0},{name:"editedPages",includeRecords:!0,lookbackDays:I},{name:"similarUsersEditedPages",includeRecords:!0,lookbackDays:c}]},headers:(0,t().WS)({cellId:void 0,recordId:void 0,spaceId:a})});if("success"!==m.type)return;const p=r?i().Up((0,o().getInitialUserSignalsState)(),r.map((e=>e.name))):(0,o().getInitialUserSignalsState)();return m.data.signals.forEach((e=>{if("error"===e.status)return;const a=e.name;switch(a){case"similarUserRecentPages":p.similarUserRecentPages=g(e.data);break;case"recentPages":p.recentPages=e.data;break;case"topPages7dPageView":p.topPages7dPageView=e.data;break;case"similarUsersEditedPages":p.similarUsersEditedPages=e.data;break;case"editedPages":p.editedPages=e.data}})),p}}}]);