"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[2411,5834,34208,59388,90871],{53592:(e,t,o)=>{o.r(t),o.d(t,{attemptServerBackedLocalDuplicate:()=>M,serverBackedLocalDuplicate:()=>f});o(944114),o(581454);var a=()=>o(857639),r=()=>o(386164),c=()=>o(388821),n=()=>o(912720),i=()=>o(199378),s=()=>o(502800),l=()=>o(763824),d=()=>o(466614),p=()=>o(449506),u=()=>o(666144),m=()=>o(751156),g=()=>o(974233),v=()=>o(611191),_=()=>o(603815),k=()=>o(261450),y=()=>o(503388),h=()=>o(966152),I=()=>o(59110),S=()=>o(605605),b=()=>o(677733);function f(e){const{environment:t,sourceBlock:o,targetInMemoryRecordCache:a,transaction:r,options:n,targetSpaceId:i,installationImprint:s,templateInstallationMetadata:d={},shouldUseSynchronousDuplicationAPI:p,stopwatch:u}=e,m=performance.now();null==u||u.mark("server_duplicate_start");const g=e.copyIndicators??(0,y().U8)({environment:t,sourceBlocks:[o],targetRecordCache:a,transaction:r,spaceId:i});null==u||u.mark("create_copy_indicators");const v=l().yX();return r.postSubmitCallbacks.push((async e=>{if(null==u||u.mark("transaction_post_submit_callback"),e)return(0,h().P0)({environment:t,type:"server_duplicate_transaction_post_submit_callback_error",data:{copyIndicatorIds:g.map((e=>e.id)),error:e,targetSpaceId:i,options:n}}),void(0,y().Jc)(e,v);(0,y().Yj)(g),null==u||u.mark("initialize_copy_indicators_progress_state");const{success:a,size:l}=await M({environment:t,sourceBlockPointer:o,targetBlockStore:g[0],options:n,templateInstallationMetadata:d,stopwatch:u});if(a)return(0,k().E)({environment:t,success:!0,time:performance.now()-m,user_action:r.getUserActionForAnalyticsPurposesOnly(),is_duplication_local:!0,duplication_size:l,method:"server_backed_local_duplication"}),null==u||u.mark("server_backed_local_duplicate_success"),(0,y().dH)(g),void v.resolve({status:"success"});const _=await(0,b().performServerDuplicate)({environment:t,copyIndicators:g,sourceBlocks:[o],targetSpaceId:i,options:n,templateInstallationMetadata:d,installationImprint:s,shouldUseSynchronousDuplicationAPI:p,stopwatch:u});if((0,y().dH)(g),!_.success)return(0,y().uC)({environment:t,copyIndicators:g}),(0,h().P0)({environment:t,type:"server_duplicate_iterator_error",data:{errorMessage:_.errorMessage}}),void v.resolve({status:"error",errorMessage:_.errorMessage,error:_.error});(0,k().E)({environment:t,success:!0,time:performance.now()-m,user_action:r.getUserActionForAnalyticsPurposesOnly(),is_duplication_local:!0,duplication_size:_.size,method:"sbld_fallback_server_duplication"}),null==u||u.mark("server_duplicate_success"),v.resolve({status:"success",recordIdMap:_.recordIdMapJson?c().RecordMapPolymorphic.create(_.recordIdMapJson):void 0})})),{blockStores:g,onComplete:v.promise}}async function M(e){const{environment:t,sourceBlockPointer:o,targetBlockStore:l,options:k,templateInstallationMetadata:y,recordLimit:b=500,targetInMemoryRecordCache:f,stopwatch:M}=e;null==M||M.mark("attempt_server_backed_local_duplicate_start"),(0,h().JW)({environment:t,type:"server_duplicate_attempt_server_backed_local_duplicate",data:{sourceBlockPointer:o,targetBlockStore:l,targetSpaceId:l.getSpaceId(),options:k}});const C=(0,v().$J)(),B=await async function(e){const{environment:t,sourceBlockPointer:o,targetBlockStore:n,targetInMemoryRecordCache:i,options:l,enableLegacyTransclusionFixing:d,recordLimit:m}=e,v=i??n.inMemoryRecordCache,k={blockId:o.id,allowCopyCollections:!0,requireFullSubtree:!0,skipTransclusionContainerChildren:!l.deepCopyTransclusionContainers,allowCopyExternalObjectInstances:!l.convertExternalObjectInstancesToPlaceholders,includeLegacyTransclusionBlockValues:d,inMemoryRecordCache:v};let y;if(y=(0,I().loadLocalSubtree)(t,k),!y.recordMap&&v===t.defaultRecordCache.inMemoryRecordCache)try{(0,h().JW)({environment:t,type:"performInexactPagePreload",data:{message:"No local subtree found, performing performInexactPagePreload",loadLocalSubtreeArgs:k}}),await(0,_().A$)(t,{table:"block",id:o.id,spaceId:o.spaceId}),y=(0,I().loadLocalSubtree)(t,k)}catch(S){a().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"persistedRecordCachePreloadError",error:(0,s().convertErrorToLog)(S),data:{message:"Failed to preload subtree from persisted record cache"}})}y.recordMap||((0,h().JW)({environment:t,type:"loadLocalSubtreeApi",data:{message:"No local subtree found from previous attempts, attemping API call to loadBlockSubtree",currentLocalSubtreeResponse:y}}),y=await async function(e){const{environment:t,sourceBlockPointer:o,recordLimit:n,targetBlockStore:i,loadLocalSubtreeArgs:l}=e;try{const e=await p().callApi({eventName:"loadBlockSubtree",environment:t,data:{block:{id:o.id,spaceId:o.spaceId},shallow:!1,recordCountLimit:n},headers:(0,r().WS)({spaceId:o.spaceId})});if((0,h().JW)({environment:t,type:"loadBlockSubtreeApiResult",data:{message:"Result from loadBlockSubtree API call",subtreeResult:e,apiArgs:{block:{id:o.id,spaceId:o.spaceId},shallow:!1,recordCountLimit:n}}}),"success"===e.type){const o=c().RecordMapWithRole.create(e.data.subtreeRecordMap);return await u()._O({environment:t,inMemoryRecordCache:l.inMemoryRecordCache,recordMap:o,debugSource:"load_local_subtree_from_server"}),(0,I().loadLocalSubtree)(t,l)}{const t=(0,g().V)(e);a().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"loadBlockSubtreeFailure",data:{message:"Error fetching subtree",miscDataToConvertToString:{error:t,sourceBlockPointer:o,cacheSize:i.inMemoryRecordCache.size,targetBlockPointer:{id:i.id,spaceId:i.getSpaceId(),type:i.getType()}}}})}}catch(S){a().log({level:"error",from:"attemptServerBackedLocalDuplicate",type:"subtreeLoadError",error:(0,s().convertErrorToLog)(S),data:{message:"Error loading subtree",miscDataToConvertToString:{sourceBlockPointer:o,cacheSize:i.inMemoryRecordCache.size,targetBlockPointer:{id:i.id,spaceId:i.getSpaceId(),type:i.getType()}}}})}}({environment:t,sourceBlockPointer:o,recordLimit:m,targetBlockStore:n,loadLocalSubtreeArgs:k}));y&&!y.recordMap&&a().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"subtreeLoadFailure",data:{message:"Failed to load subtree",miscDataToConvertToString:{sourceBlockPointer:o,cacheSize:n.inMemoryRecordCache.size,reason:"error"===y.type?y.reason:void 0,targetBlockPointer:{id:n.id,spaceId:n.getSpaceId(),type:n.getType()},missingRecord:"error"===y.type?y.pointer:void 0}}});return y}({environment:t,sourceBlockPointer:o,targetBlockStore:l,targetInMemoryRecordCache:f,options:k,enableLegacyTransclusionFixing:C,recordLimit:b});if(null==M||M.mark("try_load_local_subtree_finished"),!B||!B.recordMap)return{success:!1,size:void 0,pageStore:l};var w;if(d().Lw({sourceSpaceId:o.spaceId,targetSpaceId:l.getSpaceId(),sourceBlockSubtree:B.recordMap}))return a().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"accessLockingWarning",data:{message:"Unable to perform local duplication",miscDataToConvertToString:{sourceBlockPointer:o,targetBlockPointer:{id:l.id,spaceId:l.getSpaceId(),type:l.getType()}}}}),null==M||M.mark("attempt_server_backed_local_duplicate_failure"),{success:!1,size:null===(w=B.recordMap)||void 0===w?void 0:w.getSize(),pageStore:l};for(const r of B.recordMap.getTables()){var L;if(r===n().yB||r===i().SC)return a().log({level:"warning",from:"attemptServerBackedLocalDuplicate",type:"invalidRecordType",data:{message:"Local duplication does not support automation tables",miscDataToConvertToString:{sourceBlockPointer:o,targetBlockPointer:{id:l.id,spaceId:l.getSpaceId(),type:l.getType()}}}}),null==M||M.mark("attempt_server_backed_local_duplicate_failure"),{success:!1,size:null===(L=B.recordMap)||void 0===L?void 0:L.getSize(),pageStore:l}}try{var P;(0,h().JW)({environment:t,type:"server_backed_duplicate_start_transaction",data:{message:"Starting transactionActions.createAndCommit for localDuplicate",sourceBlockPointer:o,targetBlockPointer:{id:l.id,spaceId:l.getSpaceId(),type:l.getType()}}});const{serverCommitResult:e}=m().createAndCommit({userAction:"server_backed_local_duplicate",environment:t,canUndo:!0,isTemplateInstantiationTransaction:Boolean(y),perform:e=>(0,S().localDuplicate)({environment:t,sourceBlockId:o.id,targetBlockPointer:l.pointer,sourceBlockSubtree:B.recordMap,targetInMemoryRecordCache:l.inMemoryRecordCache,transaction:e,templateInstallationMetadata:y,stopwatch:M,options:{...k,preventLegacyTransclusions:C}})});return await e,null==M||M.mark("server_backed_local_duplicate_finished"),(0,h().JW)({environment:t,type:"server_duplicate_attempt_server_backed_local_duplicate_success",data:{targetSpaceId:l.getSpaceId(),options:k}}),{success:!0,size:null===(P=B.recordMap)||void 0===P?void 0:P.getSize(),pageStore:l,transactionPromise:e}}catch(R){var T;return a().log({level:"error",from:"attemptServerBackedLocalDuplicate",type:"subtreeLoadError",error:(0,s().convertErrorToLog)(R),data:{message:"Failed to load subtree",miscDataToConvertToString:{sourceBlockPointer:o,targetBlockPointer:{id:l.id,spaceId:l.getSpaceId(),type:l.getType()}}}}),{success:!1,size:null===(T=B.recordMap)||void 0===T?void 0:T.getSize(),pageStore:l}}}},568131:(e,t,o)=>{o.r(t),o.d(t,{duplicateBlock:()=>M});o(16280),o(898992),o(823215),o(581454),o(737550);var a=()=>o(179034),r=()=>o(665344),c=()=>o(854150),n=()=>o(466614),i=()=>o(970330),s=()=>o(901389),l=()=>o(863168),d=()=>o(594794),p=()=>o(611191),u=()=>o(972435),m=()=>o(494043),g=()=>o(406792);class v{constructor(e){this.environment=void 0,this.metricName=void 0,this.startMetric=void 0,this.prevLapMetric=void 0,this.extraData=void 0,this.environment=e.environment,this.metricName=e.metricName,this.startMetric=g().default.mark(e.metricName),this.prevLapMetric=g().default.mark(e.metricName),this.extraData=e.extraData??{}}mark(e){g().default.measure(this.prevLapMetric,{environment:this.environment,data:{type:e,...this.extraData},sampleDecision:"default"}),this.prevLapMetric=g().default.mark(this.metricName)}end(){g().default.measure(this.startMetric,{environment:this.environment,data:{type:"total",...this.extraData},sampleDecision:"default"})}}var _=()=>o(765957),k=()=>o(227440),y=()=>o(630116),h=()=>o(261450),I=()=>o(59110),S=()=>o(605605),b=()=>o(53592),f=()=>o(677733);function M(e){const{environment:t,stores:o,transaction:g,targetSpaceId:M,preferDuplicateLocation:C,analyticsFrom:B,options:w,installationImprint:L,shouldAttemptServerBackedLocalDuplication:P,templateInstallationMetadata:T,shouldUseSynchronousDuplicationAPI:R}=e,D=new v({environment:t,metricName:"duplicate_block_stopwatch",extraData:{duplication_type:"local"===C?"local_duplication":P?"server_backed_local_duplication":R?"server_synchronous_duplication":"server_duplication",from:B}});if(0===o.length)throw new Error("Must duplicate at least one block");const A=o[0].getSpaceId();if(!o.every((e=>e.getSpaceId()===A)))throw new Error("All stores must be in the same space");if(o.length>1&&!o.every((e=>e.isTypedCollectionViewBlock())))throw new Error("Multiple source blocks only supported for grouped typed DB duplication");!function(e){const{environment:t,stores:o,analyticsFrom:a}=e;for(const n of o){var r;const e=n.getRecordStoreAtRootPath().getValue();if(!e)continue;const{currentSpaceStore:o}=_().default.getState();let s;o&&e.parent_table===c().yK&&(s=y().h4.createChildStore(o,{table:c().yK,id:e.parent_id})),i().v(t,{from:a??"copy",type:e.type,teamStore:s,is_toggleable:(0,m().Yt)(e.type,e.format),collection_id:n.getAssociatedCollectionId()??(null===(r=n.getCollectionStore())||void 0===r?void 0:r.id),new_page_id:"page"===e.type?n.id:void 0,creating_block_id:n.id,parent_collection_id:n.getParentCollectionIdUpToTwoLevels(),form_id:n.getFirstFormIdInCollectionViewBlock()})}}({environment:t,stores:o,analyticsFrom:B}),D.mark("track_create_blocks"),w.convertExternalObjectInstancesToPlaceholders=A!==M;const x=T&&(0,r().Fe)(T.source)&&T.isListedTemplate;if("local"===C&&1===o.length&&!x){const e=function(e){const{environment:t,store:o,sourceSpaceId:r,targetSpaceId:c,transaction:i,options:s,installationImprint:u,templateInstallationMetadata:m,stopwatch:g}=e,v=(0,p().$J)(),_=(0,I().loadLocalSubtree)(t,{blockId:o.id,inMemoryRecordCache:o.inMemoryRecordCache,allowCopyCollections:!1,requireFullSubtree:!0,skipTransclusionContainerChildren:!s.deepCopyTransclusionContainers,allowCopyExternalObjectInstances:!s.convertExternalObjectInstancesToPlaceholders,includeLegacyTransclusionBlockValues:v}).recordMap;if(null==g||g.mark("load_local_subtree"),!_||n().Lw({sourceSpaceId:r,targetSpaceId:c,sourceBlockSubtree:_}))return;const{targetBlockStore:k}=(0,S().localDuplicate)({environment:t,sourceBlockId:o.id,targetBlockPointer:(0,d().zP)({environment:t,table:a().ev,spaceId:c}),sourceBlockSubtree:_,targetInMemoryRecordCache:o.inMemoryRecordCache,options:{...s,preventLegacyTransclusions:v},transaction:i,installationImprint:u,templateInstallationMetadata:m,stopwatch:g});"ai_block"===k.getType()&&l().EF.setState(k.pointer.id);return{blockStores:[k],onComplete:Promise.resolve({status:"success"})}}({environment:t,store:o[0],options:w,sourceSpaceId:A,targetSpaceId:M,transaction:g,installationImprint:L,templateInstallationMetadata:T,stopwatch:D});if(e)return D.mark("try_local_duplication_success"),D.end(),e;D.mark("try_local_duplication_failure")}const E=t.defaultRecordCache.inMemoryRecordCache;if(o.some((e=>e.inMemoryRecordCache!==E)))throw new Error("Can only server duplicate from the environment.defaultRecordCache.inMemoryRecordCache.");let z;return k().A.state.online||s().f1(u().A.formatMessage(h().V.offlineError)),z=1===o.length&&P?(0,b().serverBackedLocalDuplicate)({environment:t,sourceBlock:{id:o[0].id,spaceId:o[0].getSpaceId()},targetInMemoryRecordCache:E,transaction:g,targetSpaceId:M,installationImprint:L,templateInstallationMetadata:T,stopwatch:D,shouldUseSynchronousDuplicationAPI:R,options:w}):(0,f().serverDuplicate)({environment:t,sourceBlocks:o.map((e=>({id:e.id,spaceId:e.getSpaceId()}))),targetInMemoryRecordCache:E,transaction:g,targetSpaceId:M,installationImprint:L,templateInstallationMetadata:T,stopwatch:D,shouldUseSynchronousDuplicationAPI:R,options:w}),async function(){const{blockStores:e,onComplete:t}=z;if("success"===(await t).status)for(const o of e)if("ai_block"===o.getType())return void l().EF.setState(o.pointer.id)}(),D.mark("duplicate_block_immediate_return"),z.onComplete.then((e=>{D.end()})),z}},735790:(e,t,o)=>{o.d(t,{M:()=>c});o(296540);var a=o(474848);const r={viewBox:"0 0 20 20",fittedViewBox:"2.37 4.25 15.25 11.5",svg:(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("path",{d:"M3 7.375h6.829a2.501 2.501 0 0 0 4.842 0H17a.625.625 0 1 0 0-1.25h-2.329a2.501 2.501 0 0 0-4.842 0H3a.625.625 0 1 0 0 1.25M12.25 5.5a1.25 1.25 0 1 1 0 2.5 1.25 1.25 0 0 1 0-2.5"}),(0,a.jsx)("path",{fillRule:"evenodd",d:"M7.75 15.75a2.5 2.5 0 0 0 2.421-1.875H17a.625.625 0 1 0 0-1.25h-6.829a2.5 2.5 0 0 0-4.842 0H3a.625.625 0 1 0 0 1.25h2.329A2.5 2.5 0 0 0 7.75 15.75m0-1.25a1.25 1.25 0 1 0 0-2.5 1.25 1.25 0 0 0 0 2.5",clipRule:"evenodd"})]})},c=(0,o(340498).wt)("sliders",r)}}]);