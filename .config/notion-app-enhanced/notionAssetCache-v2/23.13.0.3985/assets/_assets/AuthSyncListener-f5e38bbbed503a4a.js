"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[21088],{171510:(e,t,n)=>{n.r(t),n.d(t,{AuthSyncListener:()=>w});n(898992),n(354520);var s=n(296540),o=()=>n(484714),a=()=>n(56366);const i="initial_handshake";var r=()=>n(798880),u=()=>n(959013),c=()=>n(496603),l=()=>n(763824),d=()=>n(498212),m=()=>n(780054),v=()=>n(630116),g=()=>n(179534),p=()=>n(214006),f=n(474848);const U=1;function w(){const e=(0,o().v3)(),t=(0,u().tz)(),n=`${m().A.identity.domainBaseUrl}/authSync`,w=e.currentUser.isLoggedIn(),[y,h]=(0,s.useState)(null),[C,E]=(0,s.useState)({value:!1,count:0}),I=(0,a().K8)((()=>g().A.getTotalUnreadMentionsCount()),[]),S=(0,a().K8)((()=>p().A.getAllSpaceViewStores(e)),[e]);(0,s.useEffect)((()=>{const e=t=>{const n=m().A.identity.domainBaseUrl;t.origin===n&&t.ports&&t.ports[0]&&(h(t.ports[0]),window.removeEventListener("message",e))};return window.addEventListener("message",e),()=>{window.removeEventListener("message",e)}}),[]),(0,s.useEffect)((()=>{w&&(C.value||0===C.count||null==y||y.postMessage({version:U,name:"unreadCount",source:"notion",unreadCount:I}))}),[w,C.count,C.value,y,I]);const k=(0,s.useCallback)((async()=>{const e=c().hS(S,"userId"),n=await(0,l().lX)(e,10,(async e=>{if(!e.userId)return;const n=v().LU.createChildStore(e,{table:r().oo,id:e.userId});await n.load();const s=n.getEmail()??"",o=n.getDisplayName(t)??"";return{id:e.userId,displayName:o,emailAddress:s}}));null==y||y.postMessage({version:U,name:"accountSwitcher",source:"notion",accounts:n.filter((e=>void 0!==e)),persistCookie:!0})}),[t,y,S]);(0,s.useEffect)((()=>{w&&y&&(C.value||0===C.count)&&k()}),[w,k,C.count,C.value,y]),(0,s.useEffect)((()=>{e.currentUser.id&&!(0,d().uj)(e.currentUser.id)||null==y||y.postMessage({version:U,name:"setNotionUserID",source:"notion",notionUserID:e.currentUser.id?e.currentUser.id:"",type:"mutation"})}),[e.currentUser.id,y]),(0,s.useEffect)((()=>{w||(null==y||y.postMessage({version:U,name:"setNotionUserID",source:"notion",notionUserID:"",type:"mutation"}),null==y||y.postMessage({version:U,name:"accountSwitcher",source:"notion",accounts:[],persistCookie:!0}))}),[w,y]);const A=(0,s.useCallback)((e=>{if(e.data.version!==U)return;const{source:t}=e.data;if("notion"!==t&&"mailLoaded"===e.data.name)E((e=>({value:!0,count:e.count+1})))}),[]);return(0,s.useEffect)((()=>(h((e=>(e&&(e.onmessage=A),e))),()=>{h((e=>(e&&(e.onmessage=null),e)))})),[A,y]),(0,f.jsx)("iframe",{src:n,style:{display:"none"},onLoad:e=>function(e){const t=e.currentTarget;setTimeout((()=>{var e;null===(e=t.contentWindow)||void 0===e||e.postMessage(i,m().A.identity.domainBaseUrl)}),50)}(e),title:"Notion Identity"})}}}]);