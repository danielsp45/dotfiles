"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[34442],{1295:(t,e,n)=>{n.d(e,{i:()=>I});n(16280),n(944114),n(898992),n(354520),n(430670),n(581454);var o=()=>n(183558),r=()=>n(534177),i=()=>n(997769),c=()=>n(792071),s=()=>n(861017),a=()=>n(179034),l=()=>n(919709),d=()=>n(265282),p=()=>n(939689),u=()=>n(492736);function h(t){const e=[];if(t.bold&&e.push(["b"]),t.italic&&e.push(["i"]),t.strikethrough&&e.push(["s"]),t.underline&&e.push(["_"]),t.code&&e.push(["c"]),t.color){const n=(0,d().Ah)(t.color);n&&e.push(["h",n])}return t.href&&e.push(["a",t.href]),e}function f(t,e){const n=[],o=(0,i().I)(t);if(0===o.length)return n.push((0,l().Ey_)(t,[])),n;let r=0;for(const i of o){if(i.start>r){const e=t.slice(r,i.start);e&&n.push((0,l().Ey_)(e,[]))}try{const t=(0,s().parseRoute)({url:i.href,baseUrl:e.baseUrl,publicDomainName:e.publicDomainName,isMobile:!1,protocol:void 0,currentUrl:void 0});if("page"===t.name&&t.blockId){const e=(0,l().ld4)(t.blockId,void 0);n.push((0,l().wmz)(e,[]))}else{const t=["a",i.href];n.push((0,l().Ey_)(i.value,[t]))}}catch{const t=["a",i.href];n.push((0,l().Ey_)(i.value,[t]))}r=i.end}if(r<t.length){const e=t.slice(r);e&&n.push((0,l().Ey_)(e,[]))}return n}function m(t){const{text:e,uriContext:n,citationFormat:o="citation",citationCounter:r}=t,i=[];for(const c of e)if("string"==typeof c){const t=f(c,n);i.push(...t)}else{const t=c.annotations?h(c.annotations):[];if("annotated"===c.type){const e=f(c.text,n);for(const n of e){const[e,o]=n,r=[...o??[],...t];i.push((0,l().Ey_)(e,r))}}else if("mention"===c.type){if("user"===c.mention.type){const e=(0,p().Mg)(c.mention.url,n);if("user"===e.type){const n=(0,l().P4h)(e.userId);i.push((0,l().wmz)(n,t))}}else if("page"===c.mention.type){const e=(0,p().Mg)(c.mention.url,n);if("pageOrCollectionViewBlock"===e.type){const n=(0,l().ld4)(e.id,void 0);i.push((0,l().wmz)(n,t))}}else if("date"===c.mention.type){const e=c.mention.end?{type:"daterange",start_date:c.mention.start,end_date:c.mention.end,date_format:"relative"}:{type:"date",start_date:c.mention.start,date_format:"relative"},n=(0,l().Ww9)(e);i.push((0,l().wmz)(n,t))}}else if("equation"===c.type){const e=(0,l().Ycj)(c.equation);i.push((0,l().Ey_)(l().Yl$,[e,...t]))}else if("citation"===c.type)if("citation"===o){const e=(0,l().X$)({href:c.href,type:"url"});i.push((0,l().wmz)(e,t))}else if("link"===o){r&&(r.current+=1);const e=(null==r?void 0:r.current)??1,n=["a",c.href];i.push((0,l().Ey_)(`[${e}]`,[n,...t]))}}return i}function g(t,e){const{pageOrBlockId:n,blockId:o}=(0,p().OR)(t,e);return o||n}function b(t){const{blockId:e,spaceId:n,recordMap:o}=t,r=o.getModel({table:a().ev,id:e,spaceId:n});if(!r)throw new Error(`Block not found in record map: ${e}`);return r}function y(t){const{parentPointer:e,children:n,idCreator:o,useCrdt:r,actorPointer:i,context:c,recordMap:s,uriContext:a,getNow:l}=t,d=[],p=[];for(const u of n){const{blockId:t,operations:n}=_({parentPointer:e,block:u,idCreator:o,useCrdt:r,actorPointer:i,context:c,recordMap:s,uriContext:a,getNow:l});d.push(t),p.push(...n)}return p.push({command:"set",path:["content"],pointer:e,args:d}),p}function x(t){const{parentPointer:e,sectionChildren:n,idCreator:o,useCrdt:r,actorPointer:i,context:s,recordMap:l,uriContext:d,getNow:p}=t,u=o.idInSavedSpace(a().ev),{model:h,operations:f}=c().zgg.create({id:u,type:"text",parentPointer:e,alive:!0,created_time:p(),createdBy:i,space_id:e.spaceId},{useCrdt:r}),m=[...f];if(n&&n.length>0){const t=y({parentPointer:{table:a().ev,id:h.id,spaceId:e.spaceId},children:n,idCreator:o,useCrdt:r,actorPointer:i,context:s,recordMap:l,uriContext:d,getNow:p});m.push(...t)}return{sectionId:h.id,operations:m}}function _(t){const{parentPointer:e,block:n,idCreator:i,useCrdt:s,actorPointer:h,context:f,recordMap:k,uriContext:I,getNow:v}=t,C=[];if("page"===n.type||"database"===n.type||"unknown"===n.type){const t=g(n.url,I),o=b({blockId:t,spaceId:e.spaceId,recordMap:k});if(e.id===o.parent_id)return{blockId:t,operations:C};o.parent_table===a().ev&&C.push({command:"listRemove",path:["content"],pointer:{table:o.parent_table,id:o.parent_id,spaceId:e.spaceId},args:{id:t}});const r={table:a().ev,id:t,spaceId:e.spaceId};return C.push({command:"update",path:[],pointer:r,args:{parent_table:a().ev,parent_id:e.id,alive:!0}}),{blockId:t,operations:C}}if("synced_block_reference"===n.type){const{pageOrBlockId:t,blockId:o}=(0,p().OR)(n.originalUrl,I),r=o||t;if(!r)throw new Error("synced_block_reference must include a valid originalUrl");const l=i.idInSavedSpace(a().ev),{model:d,operations:u}=c().zgg.create({id:l,type:"transclusion_reference",parentPointer:e,alive:!0,created_time:v(),createdBy:h,space_id:e.spaceId,format:{transclusion_reference_pointer:{id:r,spaceId:e.spaceId,table:"block"}}},{useCrdt:s});if(C.push(...u),n.children&&n.children.length>0){const t={table:a().ev,id:r,spaceId:e.spaceId},o=[];for(const e of n.children){const{blockId:n,operations:r}=_({parentPointer:t,block:e,idCreator:i,useCrdt:s,actorPointer:h,context:f,recordMap:k,uriContext:I,getNow:v});o.push(n),C.push(...r)}const c=(b({blockId:r,spaceId:e.spaceId,recordMap:k}).getContentIds()||[]).filter((t=>!o.includes(t)));for(const n of c)C.push({command:"set",path:["alive"],pointer:{table:a().ev,id:n,spaceId:e.spaceId},args:!1});C.push({command:"set",path:["content"],pointer:t,args:o})}return{blockId:d.id,operations:C}}if("transcription"===n.type){const t=i.idInSavedSpace(a().ev),{model:o,operations:r}=c().zgg.create({id:t,type:"transcription",parentPointer:e,alive:!0,created_time:v(),createdBy:h,space_id:e.spaceId,properties:{...n.text?{title:m({text:n.text,uriContext:I,citationFormat:f.citationFormat,citationCounter:f.citationCounter})}:{}}},{useCrdt:s});C.push(...r);const l={table:a().ev,id:o.id,spaceId:e.spaceId},{sectionId:d,operations:p}=x({parentPointer:l,sectionChildren:n.summary,idCreator:i,useCrdt:s,actorPointer:h,context:f,recordMap:k,uriContext:I,getNow:v});C.push(...p);const{sectionId:u,operations:g}=x({parentPointer:l,sectionChildren:n.notes,idCreator:i,useCrdt:s,actorPointer:h,context:f,recordMap:k,uriContext:I,getNow:v});C.push(...g);const{sectionId:b,operations:y}=x({parentPointer:l,sectionChildren:n.transcript,idCreator:i,useCrdt:s,actorPointer:h,context:f,recordMap:k,uriContext:I,getNow:v});C.push(...y);const _={transcription_state:{state:"idle"},transcription_summary_id:d,transcription_notes_id:u,transcription_transcript_id:b};return C.push({command:"update",path:["format"],pointer:l,args:_}),C.push({command:"set",path:["content"],pointer:l,args:[d,u,b]}),{blockId:o.id,operations:C}}const w=i.idInSavedSpace(a().ev),{type:P,format:$,properties:M}=function(t){const{blockId:e,parentId:n,agentBlock:i,context:c,spaceId:s,uriContext:a}=t;if("unknown"===i.type)throw new Error(`Unsupported block type: ${i.type}`);const l=(0,u().CU)(i),d={},h={};if("callout"===i.type)(0,r().O9)(i.icon)&&(d.page_icon=i.icon),d.callout_version=2;else if("to_do"===i.type)(0,r().O9)(i.checked)&&(h.checked=i.checked?[["Yes"]]:[["No"]]);else if("code"===i.type)(0,r().O9)(i.language)&&(h.language=[[i.language]]);else if("numbered_list"===i.type)(0,r().O9)(i.list_format)&&(d.list_format=i.list_format);else if("h1"===i.type||"h2"===i.type||"h3"===i.type)d.toggleable=i.toggleable??!1;else if("table"===i.type){var f,g;const t=null===(f=i.rows)||void 0===f?void 0:f[0],n=(null==t||null===(g=t.columns)||void 0===g?void 0:g.length)||0,r=Array.from({length:n},((t,n)=>(0,o()._g)(`${e}-${n}`)));d.table_block_column_order=r,c.setTableColumns(e,r)}else if("table_row"===i.type){if((0,r().O9)(i.columns)){const t=c.getTableColumns(n);for(let e=0;e<t.length;e++){const n=t[e],o=e<i.columns.length?i.columns[e]:[];n&&(h[n]=m({text:o,uriContext:a,citationFormat:c.citationFormat,citationCounter:c.citationCounter}))}}}else if("synced_block_reference"===i.type){const{pageOrBlockId:t,blockId:e}=(0,p().OR)(i.originalUrl,a),n=e||t;n&&(d.transclusion_reference_pointer={id:n,spaceId:s,table:"block"})}return{type:l,format:d,properties:h}}({blockId:w,parentId:e.id,agentBlock:n,context:f,uriContext:I,spaceId:e.spaceId}),O={id:w,type:P,parentPointer:e,alive:!0,created_time:v(),createdBy:h,space_id:e.spaceId,properties:{..."text"in n&&n.text?{title:m({text:n.text,uriContext:I,citationFormat:f.citationFormat,citationCounter:f.citationCounter})}:{},..."source"in n&&n.source&&(0,u().FS)(n.source)?{source:[(0,l().Ey_)(n.source,[])]}:{},...M},format:{..."color"in n&&n.color?{block_color:(0,d().Ah)(n.color)}:{},...$}},{model:B,operations:U}=c().zgg.create(O,{useCrdt:s});C.push(...U);const E={table:a().ev,id:B.id,spaceId:e.spaceId};if("children"in n&&n.children&&n.children.length>0){const t=y({parentPointer:E,children:n.children,idCreator:i,useCrdt:s,actorPointer:h,context:f,recordMap:k,uriContext:I,getNow:v});C.push(...t)}else if("table"===n.type&&n.rows&&n.rows.length>0){const t=y({parentPointer:E,children:n.rows,idCreator:i,useCrdt:s,actorPointer:h,context:f,recordMap:k,uriContext:I,getNow:v});C.push(...t)}return{blockId:B.id,operations:C}}function k(t){const{parentPointer:e,blockIds:n,beforeBlockUrl:o,afterBlockUrl:r,uriContext:i}=t,c=o?g(o,i):void 0,s=r?g(r,i):void 0;return c?{command:"insertChildrenBefore",path:["content"],pointer:e,args:{ids:n,before:c}}:{command:"insertChildrenAfter",path:["content"],pointer:e,args:{ids:n,after:s}}}function I(t){const{recordMap:e,updates:n,spaceId:o,useCrdt:i,actorPointer:c,idCreator:s,pageId:l,uriContext:d,options:p}=t,u={citationFormat:(null==p?void 0:p.citationFormat)??"link"},h=[],f=t.getNow??Date.now,m={},y={setTableColumns:(t,e)=>{m[t]=e},getTableColumns:t=>{var n;if(m[t])return m[t];const r=b({blockId:t,spaceId:o,recordMap:e});if("table"!==r.type)throw new Error(`Try to get column definition for a non-table block: ${t}`);return(null===(n=r.getFormat())||void 0===n?void 0:n.table_block_column_order)||[]},citationFormat:u.citationFormat,citationCounter:{current:0}};for(const I of n)if("delete"===I.action){const t=g(I.blockUrl,d),n=b({blockId:t,spaceId:o,recordMap:e});h.push({command:"set",path:["alive"],pointer:{table:a().ev,id:t,spaceId:o},args:!1}),h.push({command:"listRemove",path:["content"],pointer:{table:a().ev,id:n.parent_id,spaceId:o},args:{id:t}})}else if("replace"===I.action){const t=g(I.blockUrl,d),n=b({blockId:t,spaceId:o,recordMap:e});if("transclusion_container"===n.type&&1===I.blocks.length&&"synced_block"===I.blocks[0].type){var x;const r={table:a().ev,id:t,spaceId:o},l=I.blocks[0].children&&I.blocks[0].children.length>0?C(I.blocks[0].children):[],p=[];for(const t of l){const{blockId:n,operations:o}=_({parentPointer:r,block:t,idCreator:s,useCrdt:i,actorPointer:c,context:y,recordMap:e,uriContext:d,getNow:f});p.push(n),h.push(...o)}const u=((null===(x=n.getContentIds)||void 0===x?void 0:x.call(n))??[]).filter((t=>!p.includes(t)));for(const t of u)h.push({command:"set",path:["alive"],pointer:{table:a().ev,id:t,spaceId:o},args:!1});h.push({command:"set",path:["content"],pointer:r,args:p});continue}if(("collection_view"===n.type||"collection_view_page"===n.type)&&1===I.blocks.length&&"database"===I.blocks[0].type){const e=I.blocks[0];if("inline"in e&&void 0!==e.inline){h.push({command:"update",path:[],pointer:{table:a().ev,id:t,spaceId:o},args:{type:e.inline?"collection_view":"collection_view_page"}});continue}}const r={table:a().ev,id:n.parent_id,spaceId:o},l=C(I.blocks),p=[];let u=!1;for(const o of l){const{blockId:t,operations:n}=_({parentPointer:r,block:o,idCreator:s,useCrdt:i,actorPointer:c,context:y,recordMap:e,uriContext:d,getNow:f});h.push(...n),n.length>0&&(u=!0,p.push(t))}p.length>0&&h.push(k({parentPointer:r,blockIds:p,afterBlockUrl:I.blockUrl,uriContext:d})),0!==l.length&&!u||p.includes(t)||(h.push({command:"set",path:["alive"],pointer:{table:a().ev,id:t,spaceId:o},args:!1}),h.push({command:"listRemove",path:["content"],pointer:{table:a().ev,id:n.parent_id,spaceId:o},args:{id:t}}))}else if("insert"===I.action){const t=v({pageId:l,beforeBlockUrl:I.beforeBlockUrl,afterBlockUrl:I.afterBlockUrl,insideBlockUrl:I.insideBlockUrl,spaceId:o,recordMap:e,uriContext:d}),n=C(I.blocks).map((n=>{const{blockId:o,operations:r}=_({parentPointer:t,block:n,idCreator:s,useCrdt:i,actorPointer:c,context:y,recordMap:e,uriContext:d,getNow:f});return h.push(...r),o}));h.push(k({parentPointer:t,blockIds:n,beforeBlockUrl:I.beforeBlockUrl,afterBlockUrl:I.afterBlockUrl,uriContext:d}))}else(0,r().HB)(I);return h}function v(t){const{pageId:e,beforeBlockUrl:n,afterBlockUrl:o,insideBlockUrl:r,spaceId:i,recordMap:c,uriContext:s}=t;if(n){const t=b({blockId:g(n,s),spaceId:i,recordMap:c});return{table:a().ev,id:t.parent_id,spaceId:i}}if(o){const t=b({blockId:g(o,s),spaceId:i,recordMap:c});return{table:a().ev,id:t.parent_id,spaceId:i}}return r?{table:a().ev,id:g(r,s),spaceId:i}:{table:a().ev,id:e,spaceId:i}}function C(t){return t.flatMap((t=>("h1"===t.type||"h2"===t.type||"h3"===t.type)&&!t.toggleable&&t.children&&t.children.length>0?[{...t,children:void 0},...C(t.children)]:"children"in t&&t.children&&t.children.length>0?[{...t,children:C(t.children)}]:[t]))}},663760:(t,e,n)=>{n.d(e,{h:()=>u});n(16280),n(944114),n(898992),n(823215),n(803949),n(581454);const o="[A-Za-z][\\w-]*",r=/\{color="([^"]+)"}?/,i=" \t            　";function c(t){const e=t.match(r);return e?{text:t.replace(r,"").trim(),color:e[1]}:{text:t.trim()}}function s(t){let e=0;for(;e<t.length&&(n=t[e],i.includes(n));)e++;var n;return e}function a(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";const e={},n=/([A-Za-z_]+)="(.*?)"/g;let o;for(;o=n.exec(t);)e[o[1]]=o[2];return e}function l(t){for(const e of Object.keys(t))void 0===t[e]&&delete t[e];return t}function d(t,e){return[l(t),e]}function p(t){let e=1/0;for(const n of t)n.trim()&&(e=Math.min(e,s(n)));return isFinite(e)||(e=0),t.map((t=>t.slice(e))).join("\n")}function u(t){const e=t.split(/\r?\n/);e.length&&""===e[e.length-1]&&e.pop();const[n]=h(e,0,0);return n}function h(t,e,n){const o=[];let r=e;for(;r<t.length;){const e=t[r],i=s(e),c=e.trim();if(!c){let e=r;for(;e<t.length&&""===t[e].trim();)e++;const n=e-r,i=o.length>0&&e<t.length?Math.floor(n/2):Math.ceil(n/2);for(let t=0;t<i;t++)o.push({type:"text"});r=e;continue}if(c.startsWith("</")||i<n)break;const[a,l]=f(t,r);o.push(a),r=l}return[o,r]}function f(t,e){const n=t[e],r=s(n),i=n.trim();{const n=i.match(/^▶(#{1,3})\s+(.*)$/);if(n){const o=n[1].length,i=c(n[2]),[s,a]=m(t,e+1,r),l={text:y(i.text),color:i.color,toggleable:!0,children:s};return d(1===o?{type:"h1",...l}:2===o?{type:"h2",...l}:{type:"h3",...l},a)}}{const n=i.match(/^▶(?:\s+(.*))?$/);if(n){const o=c(n[1]??""),[i,s]=m(t,e+1,r);return d({type:"toggle",text:o.text?y(o.text):void 0,color:o.color,children:i},s)}}{const t=i.match(new RegExp(`^<(${o})([^>]*)/>$`));if(t){const n=t[1],o=a(t[2]);switch(n){case"table_of_contents":return d({type:"table_of_contents",color:o.color},e+1);case"unknown":return d({type:"unknown",url:o.url??"",alt:o.alt},e+1)}}}{const t=i.match(new RegExp(`^<(${o})([^>]*)>([\\s\\S]*?)<\\/\\1>$`));if(t){const n=t[1],o=a(t[2]),r=c(t[3]),i=r.text||"callout"===n?y(r.text):void 0,s=o.color??r.color;switch(n){case"page":return d({type:"page",url:o.url??"",text:i,color:s},e+1);case"database":return d({type:"database",url:o.url??"",inline:"true"===o.inline,text:i,color:s},e+1);case"audio":case"image":case"video":case"file":case"pdf":return d({type:n,source:o.source||void 0,text:i,color:s},e+1)}}}{const n=i.match(new RegExp(`^<(${o})([^>]*)>$`));if(n){const o=n[1],i=a(n[2]),c=i.color,s=i.icon;let l=e+1;for(;l<t.length&&!t[l].trim().startsWith(`</${o}`);)l++;const p=t.slice(e+1,l),[u]=h(p,0,r),f=u.length?u:void 0;switch(o){case"callout":return d({type:"callout",icon:s,color:c,children:f},l+1);case"columns":return d({type:"column_list",children:f},l+1);case"column":return d({type:"column",children:f},l+1);case"synced_block":return d({type:"synced_block",url:i.url,children:f},l+1);case"synced_block_reference":if(!i.url)throw new Error("Synced block reference must include a valid url");return d({type:"synced_block_reference",originalUrl:i.url,children:f},l+1);case"transcription":const n={type:"transcription"};let o=e+1;const a=[];for(;o<l;){const e=t[o].trim();if("<summary>"===e||"<notes>"===e||"<transcript>"===e)break;a.push(t[o]),o++}if(a.length>0){const t=a.join("\n");n.text=y(t.trim())}for(;o<l;){const e=t[o].trim();if("<summary>"!==e)if("<notes>"!==e)if("<transcript>"!==e)o++;else{let e=o+1;for(;e<l&&!t[e].trim().startsWith("</transcript>");)e++;const i=t.slice(o+1,e),[c]=h(i,0,r+1);c.length&&(n.transcript=c),o=e+1}else{let e=o+1;for(;e<l&&!t[e].trim().startsWith("</notes>");)e++;const i=t.slice(o+1,e),[c]=h(i,0,r+1);c.length&&(n.notes=c),o=e+1}else{let e=o+1;for(;e<l&&!t[e].trim().startsWith("</summary>");)e++;const i=t.slice(o+1,e),[c]=h(i,0,r+1);c.length&&(n.summary=c),o=e+1}}return d(n,l+1)}}}if(i.startsWith("```")){const n=i.slice(3).trim()||void 0;let o=e+1;const r=[];for(;o<t.length&&!t[o].trim().startsWith("```");)r.push(t[o]),o++;return d({type:"code",language:n,text:[p(r)]},o+1)}if("$$"===i){let n=e+1;const o=[];for(;n<t.length&&"$$"!==t[n].trim();)o.push(t[n]),n++;return d({type:"equation",text:[p(o)]},n+1)}if(i.startsWith("|")){const n=[];let o=e;for(;o<t.length&&t[o].trim().startsWith("|");)n.push({type:"table_row",columns:b(t[o])}),o++;return n.length>=2&&n[1].columns.every((t=>"string"==typeof t[0]&&/^-+$/.test(t[0])))&&n.splice(1,1),d({type:"table",rows:n},o)}if(/^(?:-{3,}|\*{3,}|_{3,})$/.test(i))return d({type:"divider"},e+1);{const t=i.match(/^!\[(.*?)\]\((\S+)(?:\s+"[^"]*")?\)$/);if(t){const n=t[1];return d({type:"image",source:t[2],text:n?y(c(n).text):void 0},e+1)}}{const t=i.match(/^(#{1,6})\s+(.*)$/);if(t){const n=t[1].length,o=Math.min(n,3),r=c(t[2]);return d(1===o?{type:"h1",text:y(r.text),color:r.color}:2===o?{type:"h2",text:y(r.text),color:r.color}:{type:"h3",text:y(r.text),color:r.color},e+1)}}{const n=i.match(/^>\s*(.*)$/);if(n){const o=c(n[1]??""),[i,s]=h(t,e+1,r+1);return d({type:"quote",text:o.text?y(o.text):void 0,children:i.length?i:void 0,color:o.color},s)}}{const n=i.match(/^(- \[( |x|X)\])(?:\s+(.*))?$/);if(n){const o="x"===n[2].toLowerCase(),s=n[1].length,a=r+s,l=c(i.slice(s)),[p,u]=g(t,e,a,r);return d({type:"to_do",checked:o,text:p.text,children:p.children,color:l.color},u)}}{const n=i.match(/^([-–—+*•])(?:\s+(.*))?$/);if(n){const o=n[1].length,s=r+o,a=c(i.slice(o)),[l,p]=g(t,e,s,r);return d({type:"bulleted_list",text:l.text,children:l.children,color:a.color},p)}}{const n=i.match(/^(\d+\.)(?:\s+(.*))?$/);if(n){const o=n[1].length,s=r+o,a=c(i.slice(o)),[l,p]=g(t,e,s,r);return d({type:"numbered_list",text:l.text,children:l.children,color:a.color},p)}}const l=c(i);return d({type:"text",text:y(l.text),color:l.color},e+1)}function m(t,e,n){if(e>=t.length)return[void 0,e];if(s(t[e])<=n)return[void 0,e];const[o,r]=h(t,e,n+1);return[o.length?o:void 0,r]}function g(t,e,n,o){const r=t[e].slice(n),i=[`${"\t".repeat(o)}${r}`,...t.slice(e+1)],[c,s]=m(i,0,o),a=0===s?e+1:e+s;if(c&&c.length>0&&"text"===c[0].type){const t=c.slice(1);return[{text:c[0].text,children:t.length>0?t:void 0},a]}return[{children:c&&c.length>0?c:void 0},a]}function b(t){return t.trim().replace(/^\|/,"").replace(/\|$/,"").split("|").map((t=>t.trim())).map((t=>y(t)))}function y(t){const e=t.replace(/<br\s*\/?>/gi,"\n"),n=[];let o="";const r=()=>{o&&(n.push(o),o="")},i=t=>{r(),n.push(t)};let c=0;for(;c<e.length;)if("\\"===e[c]&&c+1<e.length)o+=e[c+1],c+=2;else if(e.startsWith("<span",c)){const t=e.indexOf(">",c);if(-1===t){o+=e[c++];continue}const n=a(e.slice(c+5,t)),r=e.indexOf("</span>",t);if(-1===r){o+=e[c++];continue}const s=y(e.slice(t+1,r)),l=n.color,d="true"===n.underline;s.forEach((t=>{"string"==typeof t?i(l||d?{type:"annotated",text:t,annotations:{...l&&{color:l},...d&&{underline:!0}}}:t):"annotated"===t.type?i({...t,annotations:{...t.annotations??{},...l&&{color:l},...d&&{underline:!0}}}):"mention"===t.type?i({...t,annotations:{...l&&{color:l},...d&&{underline:!0}}}):i(t)})),c=r+7}else{if(e.startsWith("<mention-date",c)){const t=e.substring(c).match(/^<mention-date\s+([^>]+?)\/>/);if(t){const e=a(t[1]);i({type:"mention",mention:{type:"date",start:e.start,end:e.end}}),c+=t[0].length;continue}}if(e.startsWith("<mention-page",c)){const t=e.substring(c).match(/^<mention-page\s+([^>]+?)\/>/);if(t){const e=a(t[1]);i({type:"mention",mention:{type:"page",url:e.url??""}}),c+=t[0].length;continue}}if(e.startsWith("<mention-user",c)){const t=e.substring(c).match(/^<mention-user\s+([^>]+?)\/>/);if(t){const e=a(t[1]);i({type:"mention",mention:{type:"user",url:e.url??""}}),c+=t[0].length;continue}}if(e.startsWith("<mention-",c)){const t=e.substring(c).match(/^<mention-(user|page|database)\s+([^>]+?)>/);if(t){const n=t[1],o=a(t[2]),r=t[0].length,s=`</mention-${n}>`,l=e.indexOf(s,c+r);if(-1!==l){const t=e.slice(c+r,l);let a;"user"===n?(a={type:"user",url:o.url??""},t.trim()&&(a.name=t)):"page"===n?(a={type:"page",url:o.url??""},t.trim()&&(a.title=t)):(a={type:"database",url:o.url??""},t.trim()&&(a.title=t)),i({type:"mention",mention:a}),c=l+s.length;continue}}}if("["===e[c]){const t=e.indexOf("]",c),n=e.indexOf("(",t),o=e.indexOf(")",n);if(-1!==t&&n===t+1&&-1!==o){const r=e.slice(c+1,t),s=e.slice(n+1,o);i({type:"annotated",text:r,annotations:{href:s}}),c=o+1;continue}}if(e.startsWith("[^",c)){const t=e.indexOf("]",c);if(-1!==t){const n=e.slice(c+2,t);i({type:"citation",href:n}),c=t+1;continue}}if(e.startsWith("***",c)){const t=e.indexOf("***",c+3);if(-1!==t){y(e.slice(c+3,t)).forEach((t=>s(t,{bold:!0,italic:!0}))),c=t+3;continue}}if(e.startsWith("___",c)){const t=e.indexOf("___",c+3);if(-1!==t){y(e.slice(c+3,t)).forEach((t=>s(t,{bold:!0,italic:!0}))),c=t+3;continue}}if(e.startsWith("__",c)){const t=e.indexOf("__",c+2);if(-1!==t){y(e.slice(c+2,t)).forEach((t=>s(t,{bold:!0}))),c=t+2;continue}}if(e.startsWith("**",c)){const t=e.indexOf("**",c+2);if(-1!==t){y(e.slice(c+2,t)).forEach((t=>s(t,{bold:!0}))),c=t+2;continue}}if("_"===e[c]){const t=e.indexOf("_",c+1);if(-1!==t){y(e.slice(c+1,t)).forEach((t=>s(t,{italic:!0}))),c=t+1;continue}}if("*"===e[c]){const t=e.indexOf("*",c+1);if(-1!==t){y(e.slice(c+1,t)).forEach((t=>s(t,{italic:!0}))),c=t+1;continue}}if(e.startsWith("~~",c)){const t=e.indexOf("~~",c+2);if(-1!==t){y(e.slice(c+2,t)).forEach((t=>s(t,{strikethrough:!0}))),c=t+2;continue}}if("`"===e[c]){const t=e.indexOf("`",c+1);if(-1!==t){i({type:"annotated",text:e.slice(c+1,t),annotations:{code:!0}}),c=t+1;continue}}if("$"!==e[c])o+=e[c++];else{if("`"===e[c+1]){const t=e.indexOf("`$",c+2),n=0===c?" ":e[c-1],o=-1===t||t+2>=e.length?" ":e[t+2];if(-1!==t&&/\s/.test(n)&&/\s/.test(o)&&!/\s/.test(e[t-1])){i({type:"equation",equation:e.slice(c+2,t)}),c=t+2;continue}}const t=e.indexOf("$",c+1),n=0===c?" ":e[c-1],r=-1===t||t+1>=e.length?" ":e[t+1];if(-1!==t&&/\s/.test(n)&&/\s/.test(r)&&!/\s/.test(e[c+1])&&!/\s/.test(e[t-1])){i({type:"equation",equation:e.slice(c+1,t)}),c=t+1;continue}o+=e[c++]}}return r(),n.reduce(((t,e)=>("string"==typeof e&&t.length&&"string"==typeof t[t.length-1]?t[t.length-1]=t[t.length-1]+e:t.push(e),t)),[]);function s(t,e){"string"==typeof t?i({type:"annotated",text:t,annotations:e}):"annotated"===t.type||"mention"===t.type?i({...t,annotations:{...t.annotations??{},...e}}):i(t)}}}}]);