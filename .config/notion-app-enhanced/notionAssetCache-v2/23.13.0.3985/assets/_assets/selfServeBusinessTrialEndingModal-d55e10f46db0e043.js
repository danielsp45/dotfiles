"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[31388],{560802:(e,t,n)=>{n.r(t),n.d(t,{SelfServeBusinessTrialEndingModal:()=>Be});n(581454);var s=()=>n(624119),r=n(296540),a=()=>n(484714),i=()=>n(852507),o=()=>n(56366),l=()=>n(401497),d=()=>n(206267),c=()=>n(762433),u=()=>n(461946),m=()=>n(959013),p=()=>n(496603),g=()=>n(755199),v=()=>n(2220),y=()=>n(604018),h=()=>n(107683),S=()=>n(876853),f=()=>n(249847),b=()=>n(6208),I=()=>n(299487),x=()=>n(287351),C=()=>n(922442),B=()=>n(324561),_=()=>n(243670),M=()=>n(112527),P=()=>n(985315),E=()=>n(86089),w=()=>n(449506);var D=()=>n(281303),j=()=>n(624199),k=()=>n(610710),A=()=>n(125521),T=()=>n(404588),U=()=>n(106756),L=()=>n(818149),z=(n(898992),n(354520),n(672577),()=>n(244641)),N=()=>n(323063),F=()=>n(643819),$=()=>n(534177),X=()=>n(240865),K=()=>n(601203),V=()=>n(815418),q=()=>n(651390),O=()=>n(931783),Y=()=>n(981046);function R(e){var t,n;let{billingData:s,environment:a,spaceId:i,selectedBillingInterval:o,prices:l}=e;const d=(0,c().Ry)(s)??"USD",u=(0,X().V)()??1,m=o??(0,c().q8)(s)??"month",p=(0,r.useMemo)((()=>[{price:(0,N().vk)(l,{product:"business",interval:m,currency:d}),quantity:u}]),[l,m,d,u]),g=(0,r.useMemo)((()=>(0,V().Dd)(d,{items:p,trialEnd:void 0})),[d,p]),v=(0,r.useMemo)((()=>p.map((e=>(0,K().Kz)(e))).filter($().O9)),[p]),{tax:y,isLoading:h}=(0,V().Fy)({environment:a,currencyCode:d,address:null==s?void 0:s.address,lineItems:v,taxableAmount:g,billingData:s}),S="admin"===(null==s?void 0:s.type)&&Boolean(s.paymentMethod),f=null==s||null===(t=s.accountBalances)||void 0===t?void 0:t.find((e=>e.currencyCode===d)),b=new(F().W)(d,(null==f?void 0:f.amount)??0),I={subtotal:g,tax:y,isLoading:h},x={subtotal:g,tax:y,isLoading:h},C="business",B={month:(0,q().H)({billingInterval:"month",priceStore:Y().A,products:[C]}),year:(0,q().H)({billingInterval:"year",priceStore:Y().A,products:[C]})},_=(0,O()._)({asyncPrice:B.month[C]}),M=(0,O()._)({asyncPrice:B.year[C]}),P=(null==s||null===(n=s.subscription)||void 0===n?void 0:n.currentPeriodEnd)??z().c9.now().plus({months:1});return{currencyCode:d,subtotal:g,lineItems:v,tax:y,isTaxLoading:h,hasPaymentMethod:S,accountBalance:b,immediate:I,recurring:x,nextBillingDate:P,subscriptionItems:p,monthlyUnitPrice:_,yearlyUnitPrice:M}}var Z=()=>n(857639),W=()=>n(252105),H=()=>n(436572),J=()=>n(613240),G=()=>n(596513),Q=()=>n(411341);var ee=()=>n(187174),te=()=>n(798880),ne=()=>n(763824),se=()=>n(21735),re=()=>n(630116),ae=()=>n(134217),ie=()=>n(749240),oe=()=>n(192287);var le=()=>n(130604),de=()=>n(84817),ce=()=>n(828634),ue=()=>n(437821),me=()=>n(137826),pe=()=>n(997929),ge=n(474848);function ve(e){const{billingData:t,spaceStore:n,prices:s,selectedBillingInterval:i,onSelectedBillingIntervalChange:o}=e,[d,c]=(0,r.useState)(!1),u=(0,a().v3)(),{hasPaymentMethod:m,accountBalance:p,immediate:g,recurring:v,nextBillingDate:y,subscriptionItems:h,monthlyUnitPrice:S,yearlyUnitPrice:f}=R({billingData:t,environment:u,spaceId:n.id,selectedBillingInterval:i,prices:s}),[b,I]=(0,r.useState)(!1),[x,C]=r.useState(0),[B,_]=r.useState(0),M=T().XX-x;(0,r.useEffect)((()=>{x&&I(x>200)}),[x,B,M]);const P=(0,l().IS)((e=>({billingIntervalContainer:{width:"100%"},billingDetailsContainer:{display:"flex",paddingBottom:`${b?T().ej:0}px`,flexDirection:"column",gap:24},footerContainer:{display:"flex",width:"100%",flexDirection:"column",justifyContent:"flex-end",alignItems:"flex-start",position:"absolute",bottom:0,background:e.surface.elevated,...b?{borderTop:`1px solid ${e.stroke.primary}`,paddingTop:16,paddingBottom:16}:{paddingBottom:20}},stepContainer:{display:"flex",flexDirection:"column",gap:24,height:300}})),[b]);return(0,ge.jsxs)("div",{style:{flex:1,position:"relative",...P.stepContainer},children:[(0,ge.jsx)(ce().EE,{onSizeChange:e=>{let{height:t}=e;return _(t)},children:(0,ge.jsx)("div",{style:P.billingDetailsContainer,children:m?(0,ge.jsx)(me().I,{billingData:t}):(0,ge.jsx)(de().Y1,{gap:24,direction:"horizontal",children:(0,ge.jsx)("div",{style:P.billingIntervalContainer,children:(0,ge.jsx)(ue().T,{selectedBillingInterval:i,onChange:o,monthlyUnitPrice:S,yearlyUnitPrice:f})})})})}),(0,ge.jsx)(ce().EE,{onSizeChange:e=>{let{height:t}=e;return C(t)},children:(0,ge.jsx)("div",{style:P.footerContainer,children:(0,ge.jsx)(pe().J,{immediate:g,recurring:v,accountBalance:p,items:h,nextBillingDate:y,chargeType:{chargeType:"immediate"},modalId:"trial_ending_modal",isExpanded:d,setIsExpanded:c,removeContainerPadding:!0})})})]})}var ye=()=>n(554509),he=()=>n(81465),Se=()=>n(807778),fe=()=>n(704073);function be(e){const{sessionId:t,customerAddress:n,vatId:s,onChange:r,validationErrors:a,error:i}=e,o=(0,Se().aD)(),d=(0,l().IS)((e=>({paymentFieldsContainer:{height:480,width:480,position:"relative",border:`1px solid ${e.stroke.secondary}`,borderRadius:10,display:"flex",padding:20,overflow:"auto"}})),[]);return(0,ge.jsx)(fe().P,{style:{padding:4},disabled:!o,children:(0,ge.jsx)(he().z,{customerAddress:n,validationErrors:a,vatId:s,onChange:r,sessionId:t,style:d.paymentFieldsContainer,children:(0,ge.jsx)("div",{style:{paddingTop:24},children:i?(0,ge.jsx)(ye().D,{styleName:"Caption-12px/Regular",colorName:"uiRedPrimary",children:i}):null})})})}var Ie=()=>n(572268);const xe=4,Ce=[];function Be(e){let{spaceStore:t,spaceViewStore:n,userSettingsStore:r}=e;const a=(0,M().useElementsOptions)({type:"setup",currency:"USD"}),i=(0,E().o)();return i.length?(0,ge.jsx)(s().Elements,{stripe:(0,M().getStripe)(),options:a,children:(0,ge.jsx)(_e,{spaceStore:t,spaceViewStore:n,userSettingsStore:r,prices:i})}):null}function _e(e){let{spaceStore:t,spaceViewStore:n,prices:M}=e;const E=(0,a().v3)(),z=d().JW(),N=(0,b().L)(),F=(0,m().tz)(),[$,X]=(0,r.useState)({}),K=(0,B()._3)({spaceId:t.id}),[V,q]=(0,r.useState)({name:N??"",businessName:"",addressLine1:"",addressLine2:"",city:"",state:"",zipCode:"",country:"US"}),[O,Y]=(0,r.useState)(void 0),[de,ce]=(0,r.useState)((0,c().q8)(K)??"month"),[ue,me]=(0,r.useState)(),pe=r.useCallback((()=>{const e={};return(0,S().r)(V.name)||(e.customerAddress=F.formatMessage({id:"selfServeBusinessTrialEndingModal.name.required.error",defaultMessage:"Please enter a valid name."})),X((t=>({...t,...e}))),e}),[V.name,F]),ye=(0,f().T)(),he=(0,l().IS)((e=>({rightPanel:{padding:20,flex:1,position:"relative"},iconBackground:{backgroundColor:"dark"===e.mode?"#1A2027":e.marketplaceEditorial.border.blue}})),[]),{open:Se,openedFrom:fe,recentPageStores:Be,verifiedPageStores:_e,teamStores:Me,workspaceUserStores:Pe,connectedApps:Ee,trialEndData:we,modalState:De}=(0,o().O$)(j().L3),je=(0,o().K8)((()=>{var e;return Boolean(null===(e=n.getSettings())||void 0===e?void 0:e.business_trial_ending_modal_last_shown_at)}),[n]),ke=(0,s().useElements)(),{hasPaymentMethod:Ae,subscriptionItems:Te}=R({billingData:K,environment:E,spaceId:t.id,selectedBillingInterval:de,prices:M}),Ue=(0,s().useStripe)(),{handleUpgrade:Le,error:ze}=function(e){let{stripe:t,elements:n,environment:s,spaceStore:a,subscriptionItems:i,hasPaymentMethod:o,customerAddress:l,vatId:d}=e;const[c,u]=(0,r.useState)(!1),[p,g]=(0,r.useState)(),v=(0,m().tz)();return{handleUpgrade:async()=>{if(u(!0),W().wD(s,{modalId:"trial_ending_modal"}),!t||!n)return(0,Z().log)({level:"error",from:"MidtermCheckoutModal",type:"StripeError",error:{miscDataString:"Stripe elements not initialized when user tried to upgrade"}}),g(v.formatMessage({id:"spaceSubscriptionUpgradeModal.stripeNotLoaded",defaultMessage:"We could not reach our payment processor. Please reload the page or try again later."})),u(!1),{success:!1,error:p};let e;if(!o){const{error:r}=await n.submit();if(r)return W().$X(s,{error:"could not submit form",error_type:"payment_method"}),{success:!1,error:r};const a=await t.createPaymentMethod({elements:n});if(a.error)return W().$X(s,{error:a.error.message,error_type:"payment_method"}),{success:!1,error:a.error.message};if(!a.paymentMethod)return W().$X(s,{error:"could not create token",error_type:"payment_method"}),{success:!1,error:"could not create token"};e={type:"paymentMethodId",value:a.paymentMethod.id}}try{const n=await(0,Q().updateSubscription)({environment:s,from:"business_trial_ending_modal",spaceStore:a,desiredState:{items:i,trialEnd:void 0},paymentData:e,customerName:l.name,addressCity:l.city,addressCountry:l.country,addressLine1:l.addressLine1,addressLine2:l.addressLine2,addressState:l.state,addressZip:l.zipCode,vatId:d});await(0,Q().handlePaymentIntentNextActions)({paymentIntentData:n,stripe:t,onSuccess:async()=>await(0,Q().refreshAllBillingData)({environment:s,spaceStore:a})}),await J().A.awaitData(s,{spaceId:a.id});const r=await G().t.awaitData(s,{spaceId:a.id});if("trialing"===n.subscriptionStatus){const e=(0,_().r0)((0,B().a9)(r));H().D6({label:v.formatMessage({id:"selfServeBusinessTrialEndingModal.autoConvert",defaultMessage:"You will be upgraded in {days} {days, plural, one {day} other {days}} when your trial ends"},{days:e})})}return{success:!0}}catch{return{success:!1,error:v.formatMessage({id:"spaceSubscriptionUpgradeModal.payment.genericError",defaultMessage:"Your payment could not be processed. Please try again."})}}finally{u(!1)}},isSubmitting:c,error:p}}({stripe:Ue,elements:ke,environment:E,spaceStore:t,subscriptionItems:Te,hasPaymentMethod:Ae,customerAddress:V,vatId:O});(0,i().w)((()=>(0,v().u)({environment:E,event:{eventName:"self_serve_business_trial_ending_modal_viewed",eventProperties:{from:fe??"trial_ended_notification"}}}))),(0,r.useEffect)((()=>{"trial_ended_notification"===fe&&g().Z1(E)}),[E,je,fe]);const Ne=(0,o().K8)((()=>(0,y().wd)()),[]),Fe=(0,x().U)(),$e=(0,D().a)(n),Xe=function(e){let{environment:t,spaceStore:n}=e;const[{value:s}]=(0,ee().Yb)((async()=>{if(se().A.state.shouldUseEdgeCache){const e=await w().callApi({eventName:"listUsers",environment:t,data:{cursor:void 0,membershipFilter:"members",limit:oe().U,query:"",spaceId:n.id}});return"success"!==e.type?[]:(0,ne().lX)(e.data.users,e.data.users.length,(async e=>{const t=re().LU.createChildStore(n,{table:te().oo,id:e.id});return await t.load(),t}))}{await ie().subscriptionDataStoreInstance.waitUntilLoaded();const e=ie().subscriptionDataStoreInstance.state,t=e?ae().Ye(e):[];return(0,ne().lX)(t.slice(0,oe().U),oe().U,(async e=>{const t=re().LU.createChildStore(n,{table:te().oo,id:e.userId});return await t.load(),t}))}}),[t,n]);return s}({environment:E,spaceStore:t}),Ke=(0,r.useMemo)((()=>Xe||[]),[Xe]),Ve=Ce,qe=function(e){let{spaceId:t,userId:n}=e;const s=(0,a().v3)(),[i,o]=(0,r.useState)(null);return(0,r.useEffect)((()=>{(async()=>{if(!n)return;const e=await w().callApi({environment:s,eventName:"getSpaceBusinessTrialEndData",data:{spaceId:t}});"failed"!==e.type&&o(e.data)})()}),[s,t,n]),i}({spaceId:t.id,userId:ye}),Oe=(0,r.useMemo)((()=>({connectedApps:Ee??Ne,teamStores:Me??Fe,userStores:Pe??Ke,newPageStores:Be??Ve,verifiedPageStores:_e??$e,trialEndData:we??qe})),[Ee,Ne,Me,Fe,Pe,Ke,Be,Ve,_e,$e,we,qe]),Ye=(0,L().so)(Oe),Re=(0,o().K8)((()=>(0,L().is)(Ye,Oe)),[Oe,Ye]),Ze=(0,o().K8)((()=>{const e=["top-left","top-right","bottom-left","bottom-right"];return Re.map(((t,n)=>{const{component:s,getCount:r}=U().j[t],{trialEndData:a,...i}=Oe;return(0,ge.jsx)(s,{placement:e[n],countFromUsageData:r(Oe),...i},t)}))}),[Oe,Re]),We=(0,P().g)({spaceId:t.id}),He=(0,u().F$)(We),Je=Ze.length<xe,{title:Ge,highlightIndex:Qe,timelineItems:et}=(0,L().PA)(We,K),tt=(0,r.useCallback)((async()=>{if("initial"===De)(0,C().updateSelfServeBusinessTrialEndingModalState)("clickedPrimaryButton");else{me(void 0);const e=pe();if(!(0,p().Im)(e))return;const{success:t}=await Le();t&&(I().a(E,"self_serve_business_trial_ending_soon"),(0,C().closeSelfServeBusinessTrialEndingModal)())}}),[E,Le,De,pe]),nt=(0,r.useCallback)((()=>{const e=He&&(0,_().V9)(He);"clickedPrimaryButton"===De||e?(0,C().openSelfServeBusinessTrialLossAversionModal)({openedFrom:"business_trial_ending_modal",onPrimaryButtonClick:()=>(0,C().closeSelfServeBusinessTrialEndingModal)(),onSecondaryButtonClick:()=>(0,C().openSelfServeBusinessTrialEndingModal)({openedFrom:"self_serve_business_trial_loss_aversion_modal",modalState:"clickedPrimaryButton"})}):(0,C().closeSelfServeBusinessTrialEndingModal)()}),[De,He]),st=(0,r.useMemo)((()=>[{label:"clickedPrimaryButton"===De?(0,ge.jsx)(m().sA,{id:"selfServeBusinessTrialEndingModal.button.confirm",defaultMessage:"Confirm upgrade"}):(0,ge.jsx)(m().sA,{id:"selfServeBusinessTrialEndingModal.button.submit",defaultMessage:"Keep using Business"}),onClick:tt}]),[tt,De]),rt=(0,r.useMemo)((()=>[{label:"clickedPrimaryButton"===De?(0,ge.jsx)(m().sA,{id:"selfServeBusinessTrialEndingModal.button.nevermind",defaultMessage:"Never mind"}):(0,ge.jsx)(m().sA,{...He&&(0,_().V9)(He)?le().DZ.buttonCancel:le().DZ.buttonClose}),onClick:nt}]),[nt,De,He]);return(0,ge.jsx)(h().s,{isOpen:Se,onClosed:C().closeSelfServeBusinessTrialEndingModal,areaConstraint:{width:{type:"min",length:T().c4}},render:()=>(0,ge.jsx)(k().P,{handleClose:C().closeSelfServeBusinessTrialEndingModal,primaryButtons:st,secondaryButtons:rt,title:(0,ge.jsx)(m().sA,{...Ge}),timeline:{highlight:{index:Qe,color:"uiBluePrimary",backgroundColor:he.iconBackground.backgroundColor},timelineItems:et},leftPanel:K&&"clickedPrimaryButton"===De?(0,ge.jsx)(ve,{billingData:K,selectedBillingInterval:de,onSelectedBillingIntervalChange:ce,prices:M,spaceStore:t}):null,rightPanel:(0,ge.jsx)("div",{style:he.rightPanel,children:Ae||"initial"===De?Je?(0,ge.jsx)(Ie().O,{}):(0,ge.jsx)(A().a,{gridTemplateAreas:'\n\t\t\t\t\t\t\t\t\t\t\t"top-left top-right"\n\t\t\t\t\t\t\t\t\t\t\t"bottom-left bottom-right"\n\t\t\t\t\t\t\t\t\t\t',children:Ze}):(0,ge.jsx)(be,{validationErrors:$,error:ze,sessionId:z,customerAddress:V,vatId:O,onChange:e=>{e.customerAddress.name&&X((e=>({...e,name:void 0}))),(0,p().n4)(e.customerAddress,V)||q(e.customerAddress),O!==e.vatId&&Y(e.vatId)}})})})})}}}]);