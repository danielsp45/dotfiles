"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[5605,73801],{503388:(e,t,a)=>{a.d(t,{Jc:()=>_,U8:()=>m,Yj:()=>g,d8:()=>I,dH:()=>v,uC:()=>y});a(16280),a(898992),a(354520),a(581454);var o=()=>a(700500),n=()=>a(416845),r=()=>a(534177),c=()=>a(449506),s=()=>a(899193),i=()=>a(246826),l=()=>a(345913),d=()=>a(898486),p=()=>a(972435),u=()=>a(261450);function m(e){const{environment:t,sourceBlocks:a,targetRecordCache:n,transaction:c,spaceId:s}=e,l=a.map(((e,a)=>i().Wv({environment:t,type:o().xd.copyIndicator,inMemoryRecordCache:n,transaction:c,spaceId:s})));if(l.length!==a.length)throw new Error("copyIndicators must be same length as source blocks");if(!(0,r().EI)(l))throw new Error("copyIndicators must cannot be empty");return l}function g(e){for(const t of e)s().n_(t.id)}function v(e){for(const t of e)s().L7(t.id)}function I(e,t){for(const a of t)s().DW(e,a.id)}function _(e,t){const a=(0,n().op4)(e)?(0,d().DX)(p().A.getIntl(),e):void 0;t.resolve({status:"error",errorMessage:a??p().A.formatMessage(u().V.unknownError),error:e})}function y(e){const{environment:t,copyIndicators:a}=e;c().callApi({eventName:"deleteBlocks",environment:t,data:{blocks:a.filter((e=>e.useCrdt())).map((e=>({id:e.id,spaceId:e.pointer.spaceId}))),permanentlyDelete:!1}}),l().LS({environment:t,blocks:a.filter((e=>!e.useCrdt())),from:"server_duplication_copy_indicators"})}},605605:(e,t,a)=>{a.r(t),a.d(t,{localDuplicate:()=>_});a(944114);var o=()=>a(110192),n=()=>a(857639),r=()=>a(179034),c=()=>a(679156),s=()=>a(901389),i=()=>a(319975),l=()=>a(972435),d=()=>a(765957),p=()=>a(227440),u=()=>a(630116),m=()=>a(261450),g=()=>a(966152),v=()=>a(184468),I=()=>a(677733);function _(e){var t,a,_;const{environment:y,sourceBlockId:f,targetBlockPointer:k,sourceBlockSubtree:h,targetInMemoryRecordCache:S,options:C,shallowCopyNavigableBlock:B,duplicateDiscussions:b,transaction:M,installationImprint:T,templateInstallationMetadata:w,stopwatch:A}=e,D=performance.now();null==A||A.mark("local_duplicate_start");const P=k.spaceId,J=null===(t=h.getModel({id:f,table:r().ev}))||void 0===t?void 0:t.spaceId,R=[],U=P??(null===(a=d().default.state.currentSpaceStore)||void 0===a?void 0:a.id)??(null===(_=d().default.state.mainEditorCurrentBlockStore)||void 0===_?void 0:_.getSpaceId()),E=U?y.idCreator.getSpaceIdCreatorSync(U):void 0,{targetBlockStore:z,originalToDuplicate:L,subtreeSize:x}=(0,v().j)({environment:y,sourceBlockId:f,targetBlockPointer:k,sourceBlockSubtree:h,targetRecordCache:S,transaction:M,deepCopyTransclusionContainers:Boolean(C.deepCopyTransclusionContainers),duplicateDiscussions:b,shallowCopyNavigableBlock:B,resolveTemplateVariables:C.resolveTemplateVariables,preventLegacyTransclusions:C.preventLegacyTransclusions,createLegacyTransclusionCopyIndicator:{onCreate(e){R.push(e)}},installationImprint:T,templateInstallationMetadata:w,isTemplateInstantiation:C.isTemplateInstallation,spaceIdCreator:E,appendContentOnly:C.appendContentOnly});return null==A||A.mark("local_duplicate_initialize_template_success"),(0,g().JW)({environment:y,type:"local_duplicate_initialize_template_success",data:{message:"Successful initialize template",targetSpaceId:P,sourceSpaceId:J,targetBlockStore:z,subtreeSize:x}}),P!==J&&n().log({level:"info",from:"localDuplicate",type:"local_duplicate_across_spaces",data:{sourceSpaceId:J,targetSpaceId:P,sourceBlockId:f,subTreeSize:h.getSize()}}),C.addCopyName&&z&&z.isNavigableBlock()&&(!function(e){const{environment:t,transaction:a,targetBlockStore:n}=e,r=n.getTitleStore();if(!r)return;const c=r.getValue(),s=(0,o().g)(c);i().R9({environment:t,store:r,value:s,transaction:a}),(0,g().JW)({environment:t,type:"local_duplicate_text_set_value",data:{value:s,titleStoreId:r.id,targetBlockId:n.id}})}({environment:y,transaction:M,targetBlockStore:z}),null==A||A.mark("local_duplicate_add_copy_name")),R.length&&(!function(e){const{environment:t,transaction:a,targetBlockStore:o,targetRecordCache:n,sourceSpaceId:i,legacyTransclusionCopyIndicators:d,options:v,templateInstallationMetadata:_}=e,y=!p().A.state.online;y&&s().f1(l().A.formatMessage(m().V.offlineError));for(const c of d){(0,g().JW)({environment:t,type:"local_duplicate_legacy_transclusion_copy_indicators",data:{message:"Iterating legacyTransclusionCopyIndicators",info:c}});const e=o.getSpaceId(),s=u().Bv.createChildStore(o,{table:r().ev,id:c.duplicateBlockId});(0,I().serverDuplicate)({environment:t,targetSpaceId:e,targetInMemoryRecordCache:n,transaction:a,sourceBlocks:[{id:c.sourceBlockId,spaceId:i}],copyIndicators:[s],options:{...v,addCopyName:!1,convertExternalObjectInstancesToPlaceholders:v.convertExternalObjectInstancesToPlaceholders??!1},templateInstallationMetadata:_})}c().hi(t,{offline:y,num_blocks_duplicated:d.length,user_action:a.getUserActionForAnalyticsPurposesOnly()})}({environment:y,transaction:M,targetBlockStore:z,targetRecordCache:S,sourceSpaceId:J,legacyTransclusionCopyIndicators:R,options:C,templateInstallationMetadata:w}),null==A||A.mark("local_duplicate_legacy_transclusion_fix")),(0,m().E)({environment:y,success:!0,time:performance.now()-D,user_action:M.getUserActionForAnalyticsPurposesOnly(),is_duplication_local:!0,duplication_size:x,method:"local_duplication"}),null==A||A.mark("local_duplicate_success"),{targetBlockStore:z,originalToDuplicate:L}}},677733:(e,t,a)=>{a.r(t),a.d(t,{performServerDuplicate:()=>k,serverDuplicate:()=>f,shouldUseDuplicateAndTranslateTemplateBlock:()=>C,shouldUseDuplicateTemplateBlock:()=>S});a(16280),a(944114),a(581454);var o=()=>a(416504),n=()=>a(388821),r=()=>a(763824),c=()=>a(435345),s=()=>a(583835);const i=(0,s().Dv)("duplicateAndTranslateTemplateBlock"),l=(0,s().Dv)("duplicateTemplateBlock");var d=()=>a(466614),p=()=>a(449506),u=()=>a(357625),m=()=>a(898486),g=()=>a(972435),v=()=>a(217429),I=()=>a(261450),_=()=>a(503388),y=()=>a(966152);function f(e){const{environment:t,sourceBlocks:a,targetInMemoryRecordCache:o,transaction:c,options:s,targetSpaceId:i,installationImprint:l,templateInstallationMetadata:d={},shouldUseSynchronousDuplicationAPI:p,stopwatch:u}=e,m=performance.now();null==u||u.mark("server_duplicate_start");const g=e.copyIndicators??(0,_().U8)({environment:t,sourceBlocks:a,targetRecordCache:o,transaction:c,spaceId:i});null==u||u.mark("create_copy_indicators");const v=r().yX();return c.postSubmitCallbacks.push((async e=>{if(null==u||u.mark("transaction_post_submit_callback"),e)return(0,y().P0)({environment:t,type:"server_duplicate_transaction_post_submit_callback_error",data:{copyIndicatorIds:g.map((e=>e.id)),error:e,targetSpaceId:i,options:s}}),void(0,_().Jc)(e,v);(0,_().Yj)(g),null==u||u.mark("initialize_copy_indicators_progress_state");const o=await k({environment:t,copyIndicators:g,sourceBlocks:a,targetSpaceId:i,options:s,templateInstallationMetadata:d,installationImprint:l,shouldUseSynchronousDuplicationAPI:p,stopwatch:u});if(null==u||u.mark("perform_server_duplicate_finished"),(0,y().JW)({environment:t,type:"server_duplicate_duplicate_block_iterator_success",data:{result:o,targetSpaceId:i,options:s}}),(0,_().dH)(g),!o.success)return(0,_().uC)({environment:t,copyIndicators:g}),(0,y().P0)({environment:t,type:"server_duplicate_iterator_error",data:{errorMessage:o.errorMessage}}),void v.resolve({status:"error",errorMessage:o.errorMessage,error:o.error});(0,I().E)({environment:t,success:!0,time:performance.now()-m,user_action:c.getUserActionForAnalyticsPurposesOnly(),is_duplication_local:!1,duplication_size:o.size,method:"server_duplication"}),null==u||u.mark("server_duplicate_success"),v.resolve({status:"success",recordIdMap:o.recordIdMapJson?n().RecordMapPolymorphic.create(o.recordIdMapJson):void 0})})),{blockStores:g,onComplete:v.promise}}async function k(e){const{environment:t,copyIndicators:a,sourceBlocks:n,targetSpaceId:r,options:s,templateInstallationMetadata:d,installationImprint:v,shouldUseSynchronousDuplicationAPI:I,stopwatch:_}=e,y=n[0].spaceId||r,f=n.map((e=>({...e,spaceId:e.spaceId||y}))),k=a.map((e=>({id:e.id,spaceId:e.getSpaceId()}))),B=!!s.resolveTemplateVariables&&{currentUserId:t.currentUser.id,currentTimeZone:(0,o().P)()},b={sourceBlocks:f,targetBlocks:k,addCopyName:s.addCopyName,deepCopyTransclusionContainers:s.deepCopyTransclusionContainers,convertExternalObjectInstancesToPlaceholders:s.convertExternalObjectInstancesToPlaceholders,duplicateOnlyCollectionSchema:s.duplicateOnlyCollectionSchema,createActivities:s.createActivities,resolveTemplateVariables:B,allowRedundancy:s.allowRedundancy},M=S(d.source),T=C(s.shouldTranslate,s.sourceLanguage,s.targetLanguage);let w;if(M)if(I)w=await async function(e){const{environment:t,request:a,stopwatch:o}=e,n=await p().callApi({eventName:"duplicateTemplateBlockSynchronously",environment:t,data:a});if(null==o||o.mark("duplicate_template_synchronous_finished"),"failed"===n.type)return{success:!1,error:n.error,errorMessage:(0,m().A)(g().A.getIntl(),n.error)};return{success:!0,recordIdMapJson:n.data.recordIdMapJson,size:n.data.totalBlocks}}({environment:t,request:{...b,sourceLanguage:s.sourceLanguage,targetLanguage:s.targetLanguage}}),null==_||_.mark("duplicate_template_synchronously_finished");else{const e=u().UT(t,l,{...b,source:d.source,context:d.context,isEmailShared:d.isEmailShared,isFromDuplicateParam:d.isFromDuplicateParam},{spaceIds:[]});w=await h({environment:t,copyIndicators:a,targetSpaceId:r,options:s,duplicateBlockIterator:e}),null==_||_.mark("duplicate_template_finished")}else if(T){const e=u().UT(t,i,{...b,sourceLanguage:s.sourceLanguage,targetLanguage:s.targetLanguage},{spaceIds:[]});w=await h({environment:t,copyIndicators:a,targetSpaceId:r,options:s,duplicateBlockIterator:e}),null==_||_.mark("duplicate_and_translate_template_finished")}else if(I)w=await async function(e){const{environment:t,request:a}=e,o=await p().callApi({eventName:"duplicateBlockSynchronously",environment:t,data:a});if("failed"===o.type)return{success:!1,error:o.error,errorMessage:(0,m().A)(g().A.getIntl(),o.error)};return{success:!0,recordIdMapJson:o.data.recordIdMapJson,size:o.data.size}}({environment:t,request:{...b,installationImprint:v,returnRecordIdMapJson:s.returnRecordIdMap}}),null==_||_.mark("duplicate_block_synchronously_finished");else{const e=u().UT(t,c().w,{...b,installationImprint:v,returnRecordIdMapJson:s.returnRecordIdMap},{spaceIds:[...f.map((e=>e.spaceId)),...k.map((e=>e.spaceId))]});w=await h({environment:t,copyIndicators:a,targetSpaceId:r,options:s,duplicateBlockIterator:e}),null==_||_.mark("duplicate_block_finished")}return w}async function h(e){var t,a;const{environment:o,copyIndicators:n,targetSpaceId:r,options:c,duplicateBlockIterator:s}=e;let i;try{for await(const e of s)(0,y().JW)({environment:o,type:"server_duplicate_duplicate_block_iterator",data:{response:e,targetSpaceId:r,options:c}}),(0,_().d8)(e,n),d().$2(o,e),i=e}catch(u){}if(!i||i.error){var l,p;const e=null!==(l=i)&&void 0!==l&&l.error?(0,m().A)(g().A.getIntl(),i.error):g().A.formatMessage(I().V.unknownError);return{success:!1,error:(null===(p=i)||void 0===p?void 0:p.error)??new Error(e),errorMessage:e}}return{success:!0,recordIdMapJson:null===(t=i)||void 0===t?void 0:t.value.recordIdMapJson,size:(null===(a=i)||void 0===a?void 0:a.value.totalBlocks)??0}}function S(e){if(!e)return!1;const t=v().default.getConfigKey("enabled_installation_sources_for_duplicate_template_block",e);return Boolean(t)}function C(e,t,a){return Boolean(e&&t&&a)&&v().default.checkGate({gateName:"translate_template_top_bar"})}},966152:(e,t,a)=>{a.d(t,{JW:()=>r,P0:()=>c});var o=()=>a(857639),n=()=>a(217429);function r(e){const{environment:t,type:a,data:o}=e;s({environment:t,level:"info",from:"duplicateActions",type:a,data:o})}function c(e){const{environment:t,type:a,data:o}=e;s({environment:t,level:"warning",from:"duplicateActions",type:a,data:o})}function s(e){const{environment:t,level:a,from:r,type:c,data:s}=e,i=n().default.getConfigKey("page_template_duplication_verbose_logging_config","userIds");t.currentUser.id&&i.includes(t.currentUser.id)&&o().log({level:a,from:r,type:c,data:s})}}}]);