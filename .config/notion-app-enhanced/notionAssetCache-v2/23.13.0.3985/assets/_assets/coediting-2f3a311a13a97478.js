"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[53095],{29037:(e,t,n)=>{n.r(t),n.d(t,{checkmarkIcon:()=>r,iconDefinition:()=>o});n(296540);const o={viewBox:"0 0 20 20",fittedViewBox:"3.92 3.91 12.17 12.18",svg:(0,n(474848).jsx)("path",{d:"M15.784 4.002a.625.625 0 0 1 .214.857L9.445 15.784a.625.625 0 0 1-1.01.085l-4.37-5.098a.625.625 0 0 1 .948-.814l3.806 4.44 6.109-10.181a.625.625 0 0 1 .857-.214"})},r=(0,n(340498).wt)("checkmark",o)},72897:(e,t,n)=>{n.r(t),n.d(t,{clearCoEditingOverride:()=>l,setCoEditingOverride:()=>d,setCoEditingSetting:()=>c});var o=()=>n(488923),r=()=>n(751156),i=()=>n(755199),s=()=>n(2220),a=()=>n(642046);async function c(e){var t,n;const{environment:a,userSettingsStore:c,spaceId:d,active:l}=e,u=(null===(t=c.getSettings())||void 0===t?void 0:t.beta_ai_co_editing_settings)??{};if(((null===(n=u[d])||void 0===n?void 0:n.autocorrect)??!1)===l)return;r().createAndCommit({userAction:"AiCoEditingSettings.onToggleOption",environment:a,canUndo:!0,perform:e=>{i().mJ({userSettingsStore:c,data:{beta_ai_co_editing_settings:{...u,[d]:{autocorrect:l}}},transaction:e})}});const p=await(0,o().uZ)();l&&p.resetSessionId(),(0,s().u)({environment:a,event:{eventName:"co_editing_toggled",eventProperties:{toggle_status:l?"on":"off",session_id:p.getSessionId()}}}),l||p.resetSessionId()}async function d(e){const{environment:t,pageId:n,active:r}=e;a().t.setOverride(n,{autocorrect:r});const i=await(0,o().uZ)();(0,s().u)({environment:t,event:{eventName:"co_editing_override_updated",eventProperties:{new_state:r?"on":"off",session_id:i.getSessionId(),page_id:n}}})}async function l(e){const{environment:t,pageId:n}=e;a().t.clearOverride(n);const r=await(0,o().uZ)();(0,s().u)({environment:t,event:{eventName:"co_editing_override_updated",eventProperties:{new_state:"cleared",session_id:r.getSessionId(),page_id:n}}})}},105819:(e,t,n)=>{n.r(t),n.d(t,{iconDefinition:()=>o,pencilLineIcon:()=>r});n(296540);const o={viewBox:"0 0 20 20",fittedViewBox:"2.63 4.12 14.99 11.76",svg:(0,n(474848).jsx)("path",{d:"m13.987 5.682-.684.684-1.288-1.288.692-.691a.91.91 0 0 1 1.28 0c.35.35.35.93 0 1.28zm-9.433 9.433 7.914-7.914-1.289-1.289-7.92 7.908c-.122.122-.214.29-.274.457l-.336 1.082c-.06.229.153.442.366.366l1.082-.335q.252-.07.457-.275m12.446.76H5.61l1.25-1.25H17a.625.625 0 1 1 0 1.25"})},r=(0,n(340498).wt)("pencilLine",o)},406533:(e,t,n)=>{n.r(t),n.d(t,{iconDefinition:()=>r,questionMarkCircleIcon:()=>i});n(296540);var o=n(474848);const r={viewBox:"0 0 20 20",fittedViewBox:"2.37 2.37 15.26 15.25",svg:(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("path",{d:"M9.978 7.154c-.804 0-1.333.456-1.438.874a.625.625 0 0 1-1.213-.303c.28-1.121 1.44-1.82 2.65-1.82 1.365 0 2.714.905 2.714 2.298 0 .812-.49 1.477-1.13 1.872l-.755.516a.84.84 0 0 0-.381.677.625.625 0 1 1-1.25 0c0-.688.36-1.318.921-1.706l.003-.002.784-.535.014-.008c.374-.228.544-.537.544-.814 0-.459-.517-1.049-1.463-1.049m.662 6.336a.8.8 0 1 1-1.6 0 .8.8 0 0 1 1.6 0"}),(0,o.jsx)("path",{d:"M2.375 10a7.625 7.625 0 1 1 15.25 0 7.625 7.625 0 0 1-15.25 0M10 3.625a6.375 6.375 0 1 0 0 12.75 6.375 6.375 0 0 0 0-12.75"})]})},i=(0,n(340498).wt)("questionMarkCircle",r)},438632:(e,t,n)=>{n.d(t,{PD:()=>l,cb:()=>d,yR:()=>u});n(16280),n(944114),n(898992),n(354520),n(803949),n(581454);var o=n.n(n(625473)),r=n.n(n(716471)),i=()=>n(496603),s=()=>n(534177),a=()=>n(634201),c=()=>n(919709);let d=function(e){return e[e.removed=-1]="removed",e[e.added=1]="added",e[e.same=0]="same",e}({});function l(e,t){const n=new(r())({timeout:2,editCost:6}),o=n.main(t,e);return n.cleanupSemantic(o),o}function u(e){const{before:t,after:n,isIncompleteAfter:r,insertCursor:u}=e,p={count:0,encoding:{},decoding:{},annotationEncoding:{},annotationDecoding:{}},g=e=>{const t=p.encoding[e];if(t)return t;{const t=String.fromCharCode(p.count);return p.count++,p.encoding[e]=t,p.decoding[t]=e,t}},m=e=>{const t=o()(e),n=p.annotationEncoding[t];if(n)return n;{const n=String.fromCharCode(p.count);return p.count++,p.annotationEncoding[t]=n,p.annotationDecoding[n]=e,n}},f=t=>i().Bq(c().RQ(t).map((t=>{let n=[];if("word"===e.mode||"wordUnderlineFinal"===e.mode){if("undefined"==typeof Intl||!Intl.Segmenter)throw new Error("Intl.Segmenter is not supported");{const e=new Intl.Segmenter(void 0,{granularity:"word"}).segment(t[0]);n=Array.from(e).map((e=>e.segment))}}else n=a().PE(t[0]);const o=n.map(g);if(c().qXl(t)){const e=c().uPN(t),n=c().jhx(e);n&&(o[0]=m({type:"mention",value:n}),e.forEach((e=>{c().iGj(e)||c().gir(e)||c().lfl(e)||(o.unshift(m({type:"start",value:e})),o.push(m({type:"end",value:e})))})))}else if(c().GiG(t)){const e=c().uPN(t),n=c().j1D(e);if(n){o[0]=m({type:"equation",value:n});for(const t of e)c().iGj(t)||c().gir(t)||c().lfl(t)||(o.unshift(m({type:"start",value:t})),o.push(m({type:"end",value:t})))}}else if(c().BEe(t)){c().uPN(t).forEach((e=>{o.unshift(m({type:"start",value:e})),o.push(m({type:"end",value:e}))}))}return o}))).join("");if(p.count>65535)throw new Error("This string has way too many different characters.");const v=l(f(n),f(t)),h=[];let S=[],k=0;const y=r?i().Kl(v,(e=>0===e[0]||1===e[0])):0;let I=!1;const b=e.insertionAnnotation,B=e.deletionAnnotation;return v.forEach((t=>{let[n,o]=t;o.split("").forEach((t=>{if(p.decoding[t]){const o=p.decoding[t];n===d.added?h.push([o,[...S,"wordUnderlineFinal"===e.mode?e.underlineAnnotation:b]]):n===d.removed&&(!r||k<=y)?"wordUnderlineFinal"!==e.mode&&h.push([o,[...S,B]]):(r&&u&&!I&&k===y+1&&(I=!0,h.push(["",[["tc"]]])),h.push([o,S]))}else{const o=p.annotationDecoding[t];if(n===d.added)if("mention"===o.type)h.push([c().Sj,[...S,"wordUnderlineFinal"===e.mode?e.underlineAnnotation:b,o.value]]);else if("start"===o.type)S=[...S,o.value];else if("end"===o.type)S=S.filter((e=>!i().n4(e,o.value)));else if("equation"===o.type){const e=c().U35(o.value),t=c().G0H(e,[...S,b]);h.push(t)}else(0,s().HB)(o);else if(n===d.removed){if("mention"===o.type)"wordUnderlineFinal"!==e.mode&&h.push([c().Sj,[...S,B,o.value]]);else if("equation"===o.type){const e=c().U35(o.value),t=c().G0H(e,[...S,B]);h.push(t)}}else if(n===d.same)if("mention"===o.type)h.push([c().Sj,[...S,o.value]]);else if("start"===o.type)S=[...S,o.value];else if("end"===o.type)S=S.filter((e=>!i().n4(e,o.value)));else if("equation"===o.type){const e=c().U35(o.value),t=c().G0H(e,S);h.push(t)}else(0,s().HB)(o)}})),r&&(k+=1)})),c().__s(h)}},701545:(e,t,n)=>{n.d(t,{p:()=>r});n(296540);var o=n(474848);const r=(0,n(340498).wt)("checkMarkLine",{viewBox:"0 0 16 16",svg:(0,o.jsx)("path",{d:"M6.79297 13.2871C6.48047 13.2871 6.21484 13.1523 5.99609 12.8828L2.96094 9.14453C2.875 9.04297 2.8125 8.94336 2.77344 8.8457C2.73828 8.74805 2.7207 8.64648 2.7207 8.54102C2.7207 8.30664 2.79883 8.11328 2.95508 7.96094C3.11133 7.80859 3.30859 7.73242 3.54688 7.73242C3.81641 7.73242 4.04297 7.84766 4.22656 8.07812L6.76953 11.3008L11.7324 3.4375C11.834 3.28125 11.9395 3.17188 12.0488 3.10938C12.1582 3.04297 12.2949 3.00977 12.459 3.00977C12.6973 3.00977 12.8926 3.08398 13.0449 3.23242C13.1973 3.38086 13.2734 3.57031 13.2734 3.80078C13.2734 3.89453 13.2578 3.98828 13.2266 4.08203C13.1953 4.17578 13.1465 4.27344 13.0801 4.375L7.5957 12.8594C7.4082 13.1445 7.14062 13.2871 6.79297 13.2871Z"})})},919523:(e,t,n)=>{n.r(t),n.d(t,{CoEditingPresenceStore:()=>M,CoEditingTasksManager:()=>pe,HoverCoEditingOverlayRenderer:()=>ae,autoCorrectActions:()=>o,coEditingPresenceStoreActions:()=>r,coEditingSettingsActions:()=>F(),coEditingSuggestionActions:()=>i()});var o={};n.r(o),n.d(o,{applyAutoCorrectUnderlines:()=>P,applyAutoCorrectUnderlinesCrdt:()=>Q,assignEditIdsAndDeriveContext:()=>O,getAutoCorrectInference:()=>E,getContextForEdits:()=>j,logAutoCorrectFeedback:()=>R,modifyDiffWithEditIds:()=>q});var r={};n.r(r),n.d(r,{clearStore:()=>H,removePresenceForBlock:()=>N,setPresenceForBlock:()=>L});var i=()=>n(90881),s=(n(16280),n(944114),n(898992),n(354520),n(803949),n(581454),n(908872),()=>n(221844)),a=()=>n(438632),c=()=>n(386164),d=()=>n(919709),l=()=>n(439180),u=()=>n(532659),p=()=>n(498212),g=()=>n(488923),m=()=>n(449506),f=()=>n(884107),v=()=>n(319975),h=()=>n(751156),S=()=>n(108184),k=()=>n(2220),y=()=>n(659602),I=()=>n(335722),b=()=>n(594794),B=()=>n(496879);const C="initial-edit-id";var x=()=>n(270609),w=(n(672577),()=>n(220719)),_=()=>n(534177);var T=()=>n(780942);async function A(e){const{environment:t,completion:n,traceId:o,spaceId:r}=e,[i,a,c]=await Promise.all([f().R.clipboardActions.load(),y().g.load(),I().S.load()]);if(!i||!a||!c)throw new Error("Required dependencies not loaded for markdown conversion");const d=new(s().A)({name:"AutocorrectMarkdownConversion",isTemporaryData:!0}),l=h().createAndCommit({userAction:"blockActionRegistry.autoCorrectAction.convertMarkdown",environment:t,canUndo:!1,perform:e=>{const s=i.markdownToBlocks({environment:t,text:n,inMemoryRecordCache:d,transaction:e,markdownOptions:{},markdownLinkifyIt:a,tinyMceMicrosoftWordPasteFilter:c});return s?((0,S().postProcessAICreatedStores)(t,s),s[0].getTitleValue()):(r&&o&&R({environment:t,spaceId:r,traceId:o,feedback:"rejected",textContext:`Failed to convert markdown to blocks:\n ${n}`}),[])}}).performResult;if(!l)throw new Error("Failed to convert markdown to blocks");return d.addCacheFallback(t.defaultRecordCache.inMemoryRecordCache),l}async function E(e,t,n,o,r){const i=new AbortController,s=[{id:(0,b().Z1)({environment:e,table:"thread_message",spaceId:t}),type:"autocorrect",selectedText:n,navigableBlockPointer:r},{id:(0,b().Z1)({environment:e,table:"thread_message",spaceId:t}),type:"config",value:{type:"autocorrect"}}],a=await m().callStreamApi({eventName:"runInferenceTranscript",environment:e,data:{traceId:o,spaceId:t,transcript:s,generateTitle:!1},abortSignal:i.signal,headers:(0,c().WS)({spaceId:t})});if("success"!==a.type)throw a.error;let d="";if(u().hS.is(a.data))for await(const c of a.data){if("error"===c.type)throw new Error(`Failed to get inference ${c.errorCode}${c.message}`);"markdown-chat"===c.type&&(d+=c.value)}return d}async function P(e,t,n,o,r,s){const c=await A({environment:e,completion:o,traceId:r,spaceId:t.getSpaceId()});if((0,d().w9s)(c))return;const l=t.getTitleValue();h().createAndCommit({userAction:"aiCoEditing.applyAutocorrect",environment:e,canUndo:!0,perform:n=>{v().R9({environment:e,store:t.getBlockTitleStore(),value:c,transaction:n})}});const u=C,p=(0,a().yR)({mode:"wordUnderlineFinal",before:n,after:c,isIncompleteAfter:!1,insertCursor:!1,insertionAnnotation:[d().Ifu.Inserted],deletionAnnotation:[d().Ifu.Deleted],underlineAnnotation:[d().Ifu.TemporarySuggestionUnderline,u]}),g=(0,a().yR)({mode:"word",before:n,after:c,isIncompleteAfter:!1,insertCursor:!1,insertionAnnotation:[d().Ifu.Inserted,u],deletionAnnotation:[d().Ifu.Deleted,u]}),{modifiedDiff:m,edits:f}=O({diff:p,diffForContext:g,originalText:l,traceId:r});U({environment:e,edits:f,traceId:r,sessionId:s}),(0,i().setBlockSuggestion)(T().T,t,{type:"textValue",titleTextValue:m,edits:f})}async function Q(e){const{environment:t,blockStore:n,completion:o,traceId:r,sessionId:s}=e,c=await A({environment:t,completion:o,traceId:r,spaceId:n.getSpaceId()});if((0,d().w9s)(c))return;const u=function(e){const{blockStore:t,newBlockTitleTextValue:n,editIdGenerator:o,traceId:r}=e,i=(0,w().o9)(t.getBlockTitleTextSliceTree()),s=(0,w().o9)(t.getBlockTitleTextSliceTree()),c=(0,d().q4_)(s.getTextValue()).length,l=(0,w().o9)([(0,d().Ey_)((0,d().q4_)(t.getBlockTitleStore().getValue()))]),u=(0,w().o9)([(0,d().Ey_)((0,d().q4_)(n))]),p=o(),g=(0,a().yR)({mode:"word",before:l,after:u,isIncompleteAfter:!1,insertCursor:!1,insertionAnnotation:["+",p],deletionAnnotation:["-",p]});let m=[];if("undefined"==typeof Intl||!Intl.Segmenter)throw new Error("Intl.Segmenter is not supported");{const e=new Intl.Segmenter(void 0,{granularity:"word"}).segment((0,d().q4_)(l));m=Array.from(e).map((e=>e))}const f=[],v=[],h={};let S,k,y,I=0,b=0,B=!1,C=p;for(const a of g){const[e,t]=a,n=e.length;if(t&&t.find((e=>e[0]===d().BQP.Inserted&&e[1]===p))){B||(C=o()),h[C]||(h[C]={type:"crdt",editId:C,traceId:r,context:[],undoOperations:[],underlineOperations:[]});const t=h[C];let a=b;if(S){k=void 0,y=void 0;const[e,t]=S;t&&(0,d().azZ)(t)&&(a-=S[0].length)}const l=Math.max(0,Math.min(a,c)),u=s.getActiveAnnotationsBeforeIndex(l),p=[];for(const[e,n]of u.entries())p.push(n);const g=[(0,d().Ey_)(e,p)],m=i.getOperationsForInsertTextValue(I,g);m.operations.forEach((e=>{switch(e.type){case"insertText":i.applyInsertTextOperation(e);break;case"addAnnotation":case"removeAnnotation":i.applyAnnotationOperation(e);break;default:(0,_().HB)(e)}})),f.push(...m.operations),v.push(...m.invertedOperations),t.underlineOperations.push(...i.getOperationsForAddAnnotation(I,I+n-1,[d().BQP.TemporarySuggestionUnderline,C]).operations),t.undoOperations.push(...m.invertedOperations);const x=(0,d().Ey_)(e,[[d().BQP.Inserted,C]]);t.context.push(x),B=!0,I+=n}else if(t&&t.find((e=>e[0]===d().BQP.Deleted&&e[1]===p))){B||(C=o()),h[C]||(h[C]={type:"crdt",editId:C,traceId:r,context:[],undoOperations:[],underlineOperations:[]});const t=h[C],s=i.getOperationsForDeleteText(I,I+n-1);f.push(...s.operations),s.operations.forEach((e=>{i.applyDeleteOperation(e)})),v.push(...s.invertedOperations),t.undoOperations.push(...s.invertedOperations);const a=(0,d().Ey_)(e,[[d().BQP.Deleted,C]]);t.context.push(a);let c="",l=0,u="",p=I-1;const g=I-b;for(const e of m)if(e.index<b&&(e.isWordLike?(c=e.segment,l=e.index+g):c+=e.segment),e.index!==b&&e.index>=b+n){if(e.isWordLike){u+=e.segment,p+=e.segment.length;break}u+=e.segment,p+=e.segment.length}k=[...c?[(0,d().Ey_)(c)]:[],(0,d().Ey_)(e,[[d().BQP.Deleted,C]]),...u?[(0,d().Ey_)(u)]:[]],y=i.getOperationsForAddAnnotation(l,p,[d().BQP.TemporarySuggestionUnderline,C]).operations,B=!0,b+=n}else B&&k&&y&&(h[C].context=k,h[C].underlineOperations.push(...y)),B=!1,I+=n,b+=n;S=a}B&&k&&y&&(h[C].context=k,h[C].underlineOperations.push(...y));for(const a of Object.values(h))for(const e of a.underlineOperations)i.applyAnnotationOperation(e);return{type:"crdt",operations:f,invertedOperations:v,edits:h,titleTextValue:i.getTextValue()}}({blockStore:n,newBlockTitleTextValue:c,editIdGenerator:()=>(0,p().Ay)(),traceId:r});U({environment:t,edits:u.edits,traceId:r,sessionId:s}),h().createAndCommit({userAction:"aiCoEditing.applyAutocorrectCrdt",environment:t,canUndo:!0,perform:e=>{e.undoStartCallbacks.push((async()=>{const e=await(0,g().uZ)();e.submitEvent({type:"undo",blockStore:n}),(0,k().u)({environment:t,event:{eventName:"co_editing_undo",eventProperties:{session_id:e.getSessionId(),edit_id:Object.keys(u.edits)[0],edit_ids:Object.keys(u.edits),trace_id:r,source:"undo_shortcut"}}}),R({environment:t,spaceId:n.getSpaceId(),traceId:r,feedback:"rejected",textContext:JSON.stringify(Object.values(u.edits).map((e=>(null==e?void 0:e.context)??[])).reduce(((e,t)=>[...e,...t]),[]))});const o=(0,i().getBlockSuggestion)(T().T,n.id);if(o&&"crdt"===o.type){const e={...o.edits};Object.keys(u.edits).forEach((t=>e[t]=void 0));const t={...o,edits:e,titleTextValue:(0,x().L)(n,e)};(0,i().setBlockSuggestion)(T().T,n,t)}}));const o=u.operations.map((e=>(0,l().qA)({pointer:n.pointer,crdtOperation:e,fullTextValue:c}))),s=u.invertedOperations.map((e=>(0,B().c)({pointer:n.pointer,invertedCrdtOperation:e,previousTextValue:n.getTitleValue()})));h().applyCrdtTextOperations({store:n,operations:o,invertedOperations:s,transaction:e})}});const m=(0,i().getBlockSuggestion)(T().T,n.id);if(m&&"crdt"===m.type){const e={type:"crdt",operations:[...m.operations,...u.operations],invertedOperations:[...m.invertedOperations,...u.invertedOperations],titleTextValue:u.titleTextValue,edits:{...m.edits,...u.edits}};return e.edits=(0,x().q)((0,x().L)(n,e.edits),e.edits),e.titleTextValue=(0,x().L)(n,e.edits),void(0,i().setBlockSuggestion)(T().T,n,e)}(0,i().setBlockSuggestion)(T().T,n,u)}function O(e){const{diff:t,diffForContext:n,originalText:o,traceId:r}=e,{modifiedDiff:i,editIds:s}=q({diff:t});return{modifiedDiff:i,edits:j({diffForContext:n,editIds:s,originalText:o,traceId:r})}}function q(e){const{diff:t}=e,n=[];return{modifiedDiff:t.map((e=>{const[t,o]=e,r=(0,d().i54)(o??[]);if(o&&r){const e=(0,p().Ay)();n.push(e);const r=o.map((t=>(0,d().n5B)(t)?[d().Ifu.TemporarySuggestionUnderline,e]:t));return(0,d().Ey_)(t,r)}return e})),editIds:n}}function j(e){const{diffForContext:t,editIds:n,originalText:o,traceId:r}=e,i={};let s=null,a=[],c=0;function l(){i[n[c]]={type:"textValue",editId:n[c],context:a,originalText:o,traceId:r},c++,a=[]}if(t.forEach(((e,n)=>{if(a.length>0&&(0,d().byt)(a[a.length-1][1]??[])){const t=e[0].split(" ").filter(Boolean).slice(0,1)[0];a.push((0,d().Ey_)(t,e[1]??[])),l()}if((0,d().azZ)(e[1]??[])){if(s){var o;const e=(null===(o=s[0].match(/\S+\s*$/))||void 0===o?void 0:o[0])??"";a.push((0,d().Ey_)(e,s[1]??[]))}a.push(e)}(0,d().byt)(e[1]??[])&&(a.push(e),n===t.length-1&&l()),s=e})),a.length>0&&l(),c!==n.length)throw new Error("Edits length mismatch");return i}function R(e){const{environment:t,spaceId:n,traceId:o,feedback:r,textContext:i}=e;m().callApi({eventName:"saveInferenceTranscriptFeedback",environment:t,data:{type:"autocorrect",traceId:o,spaceId:n,feedbackType:"accepted"===r?"thumbs_up":"thumbs_down",userComment:i},headers:(0,c().WS)({spaceId:n})})}function U(e){const{environment:t,edits:n,traceId:o,sessionId:r}=e;Object.entries(n).forEach((e=>{let[n,i]=e;i&&(0,k().u)({environment:t,event:{eventName:"co_editing_edit",eventProperties:{session_id:r,edit_id:n,trace_id:o}}})}))}var F=()=>n(72897);class V extends(()=>n(757695))().Store{getInitialState(){return{presence:{}}}getPresencesForBlock(e){return this.state.presence[e]}}const M=new V;var D=()=>n(798880);function L(e){var t;const{navigableBlockId:n,blockId:o}=e;if(!n||!o)throw new Error("Invalid argument, navigableBlockId and blockId are required");const r={userId:D().zz.id,present:!0,activityTimestampNearestMinuteMs:Date.now(),blockId:o};(null===(t=M.getPresencesForBlock(n))||void 0===t?void 0:t.find((e=>e.blockId===o)))||M.setState({presence:{...M.getState().presence,[n]:[...M.getState().presence[n]||[],r]}})}function N(e){const{navigableBlockId:t,blockId:n}=e;var o;n?M.setState({presence:{...M.getState().presence,[t]:null===(o=M.getState().presence[t])||void 0===o?void 0:o.filter((e=>e.blockId!==n))}}):M.setState({presence:{...M.getState().presence,[t]:[]}})}function H(){M.setState({presence:{}})}n(296540);var Z=()=>n(484714),G=()=>n(56366),W=()=>n(551864),z=(n(737550),()=>n(401497)),K=()=>n(949306),J=()=>n(454503),$=()=>n(701545),X=()=>n(959013),Y=()=>n(284371),ee=()=>n(285790),te=()=>n(460292),ne=()=>n(712030),oe=()=>n(921855),re=n(474848);function ie(e){return e.map((e=>{const[t,n]=e;if(!n)return e;if(!n.some(d().XKU))return e;const o=t.replaceAll(" "," ");return(0,d().Ey_)(o,n)}))}function se(e){let{textValue:t,parentStore:n,mode:o,onAccept:r,onReject:i}=e;const s=(0,X().tz)(),a=(0,Z().v3)(),c=(0,z().DP)(),d=(0,G().K8)((()=>{const e=(0,oe().S5)({environment:a,textValue:{value:ie(t),spaceId:n.getSpaceId()},parentStore:n,disableHover:!0,disableStyleAnnotations:!1,disableInsertedDeletedAnnotations:!1,disableDateStyleAnnotations:!1,disableSuggestionAnnotations:!1,disabled:!0,theme:c,emojiType:(0,ne().FN)(a),katex:a.KatexStore.getKatex(),formulaValueTypes:[]});return(0,re.jsx)("span",{children:e})}),[a,t,c,n]),l=(0,z().IS)((e=>({container:{display:"grid",gridTemplateColumns:"auto 1fr",gap:5,alignItems:"center",padding:"5px 12px",width:"fit-content",minWidth:"min-content"},actionContainer:{display:"flex",alignItems:"center",gap:5},textContainer:{...Y().RC,fontSize:14,lineHeight:"22px",minWidth:"fit-content",whiteSpace:"pre-wrap"}})),[]);return(0,re.jsxs)("div",{style:l.container,children:[(0,re.jsx)("div",{style:l.actionContainer,children:"auto_accept"===o?(0,re.jsx)(ee().A,{style:{width:16,height:16},icon:e=>(0,J().arrowUTurnUpLeftIcon)({...e}),onClick:i,ariaLabel:s.formatMessage({id:"autoCorrectCard.undoAutoCorrection",defaultMessage:"Undo auto-correction"})}):(0,re.jsxs)(re.Fragment,{children:[(0,re.jsx)(ee().A,{style:{width:16,height:16},icon:e=>(0,$().p)({width:16,height:16,...e}),onClick:r,ariaLabel:s.formatMessage({id:"autoCorrectCard.acceptCorrection",defaultMessage:"Accept correction"})}),(0,re.jsx)(ee().A,{style:{width:16,height:16},icon:e=>(0,re.jsx)(te().Q,{iconGroup:K().Q,variantName:"default",style:{width:16,height:16,...e}}),onClick:i,ariaLabel:s.formatMessage({id:"autoCorrectCard.rejectCorrection",defaultMessage:"Reject correction"})})]})}),(0,re.jsx)("div",{style:l.textContainer,children:d})]})}function ae(e){let{store:t,annotation:n,onDismiss:o}=e;const r=(0,Z().v3)(),{suggestion:s,editId:a,parentStore:c}=(0,G().K8)((()=>{const e=t.getAncestorBlockStoreAtRootPath();if(!e)return{textValue:void 0,editId:void 0,parentStore:void 0};const o=d().JJX(n);if(!o)return{suggestion:void 0,editId:void 0,parentStore:void 0};const r=(0,i().getBlockSuggestion)(T().T,e.id);return r?{suggestion:r,editId:o,parentStore:e}:{suggestion:void 0,editId:void 0,parentStore:void 0}}),[t,n]);if(!s||!c||!a)return null;const l=s.edits[a];if(!l)return null;return(0,re.jsx)(se,{textValue:l.context,parentStore:c,mode:"auto_accept",onAccept:()=>{},onReject:async()=>{switch(l.type){case"textValue":h().createAndCommit({userAction:"aiCoEditing.undoUnderlineCorrection",environment:r,canUndo:!1,perform:e=>{v().R9({environment:r,store:c.getBlockTitleStore(),value:l.originalText,transaction:e})}});break;case"crdt":h().createAndCommit({userAction:"aiCoEditing.undoUnderlineCorrectionCrdt",environment:r,canUndo:!1,perform:e=>{l.undoOperations.map((t=>(0,W().e)({environment:r,store:c,transaction:e,operation:(0,B().c)({pointer:c.pointer,invertedCrdtOperation:t,previousTextValue:c.getTitleValue()})})))}});break;default:(0,_().HB)(l)}null==o||o();const e=await(0,g().uZ)();e.submitEvent({type:"undo",blockStore:c}),(0,k().u)({environment:r,event:{eventName:"co_editing_undo",eventProperties:{session_id:e.getSessionId(),edit_id:a,trace_id:l.traceId,source:"hover_card"}}}),R({environment:r,spaceId:c.getSpaceId(),traceId:l.traceId,feedback:"rejected",textContext:JSON.stringify(l.context)})}})}var ce=()=>n(502800),de=()=>n(102172);const le={text:!0,bulleted_list:!0,numbered_list:!0,toggle:!0,quote:!0,header:!0,sub_header:!0,sub_sub_header:!0,callout:!0,post:!0,to_do:!0,table:!1,table_row:!1,page:!1,personal_home_page:!1,person_profile:!1,factory:!1,button:!1,column_list:!1,column:!1,embed:!1,framer:!1,tweet:!1,gist:!1,drive:!1,audio:!1,maps:!1,invision:!1,mixpanel:!1,image:!1,video:!1,file:!1,bookmark:!1,equation:!1,code:!1,collection_view:!1,collection_view_page:!1,form:!1,breadcrumb:!1,copy_indicator:!1,divider:!1,link_to_page:!1,link_to_collection:!1,figma:!1,loom:!1,typeform:!1,codepen:!1,pdf:!1,table_of_contents:!1,whimsical:!1,miro:!1,abstract:!1,sketch:!1,excalidraw:!1,replit:!1,alias:!1,transclusion_container:!1,transclusion_reference:!1,external_object_instance:!1,tab:!1,external_object_instance_page:!1,hex:!1,deepnote:!1,ai_block:!1,drawing:!1,slide:!1,workflow:!1,transcription:!1},ue={[d().BQP.Bold]:!0,[d().BQP.Italic]:!0,[d().BQP.Strike]:!0,[d().BQP.Code]:!0,[d().BQP.Underline]:!0,[d().BQP.Link]:!0,[d().BQP.Discussion]:!1,[d().BQP.Highlight]:!1,[d().BQP.Date]:!1,[d().BQP.User]:!1,[d().BQP.Bot]:!1,[d().BQP.Page]:!1,[d().BQP.ExternalObjectInstance]:!1,[d().BQP.Group]:!1,[d().BQP.Team]:!1,[d().BQP.CustomEmoji]:!1,[d().BQP.LinkMention]:!1,[d().BQP.Equation]:!1,[d().BQP.FormulaError]:!1,[d().BQP.Inserted]:!1,[d().BQP.Deleted]:!1,[d().BQP.TemporaryComment]:!1,[d().BQP.TemporaryPage]:!1,[d().BQP.TemplateVariable]:!1,[d().BQP.Comment]:!1,[d().BQP.Citation]:!1,[d().BQP.TemporaryEquation]:!1,[d().BQP.TemporaryInput]:!1,[d().BQP.TemporarySelection]:!1,[d().BQP.TemporaryCommentHighlight]:!1,[d().BQP.TemporarySuggestionUnderline]:!1,[d().BQP.FormulaPageProperty]:!1,[d().BQP.FormulaContextValue]:!1,[d().BQP.TemporaryFindHighlight]:!1,[d().BQP.TemporarySelectedFindHighlight]:!1,[d().BQP.TemporaryCursor]:!1,[d().BQP.SuggestionInsertText]:!1,[d().BQP.SuggestionRemoveText]:!1,[d().BQP.SuggestionAnnotate]:!1,[d().BQP.SuggestionUnannotate]:!1,[d().BQP.TemporaryHighlight]:!1,[d().BQP.TemporaryNativeMABFilter]:!1,[d().BQP.TemporaryDictation]:!1,[d().BQP.AssistantInstructionsCollection]:!1,[d().BQP.Place]:!1,[d().BQP.SlackSpecialMention]:!1,[d().BQP.TemporarySearchFilter]:!1,[d().BQP.TitleOnly]:!1};class pe{constructor(){this.requests=[],this.currentRequest=null,this.currentRequestCancelled=!1,this.dropUntilMs={},this.currentEnvironment=void 0,this.currentBlockStore=void 0,this.sessionId=void 0,this.handleTextSelectionStoreChange=e=>{const t=e.getState();switch(t.mode){case"readOnly":case"empty":this.submitEvent({type:"textSelectionCleared"});break;case"editing":{var n;const e=t.multiSelection.start.store.getAncestorBlockStoreAtRootPath();if(!e)return void this.submitEvent({type:"textSelectionCleared"});e.id!==(null===(n=this.currentBlockStore)||void 0===n?void 0:n.id)&&this.submitEvent({type:"blockEntered",blockStore:e});break}default:(0,_().HB)(t)}},n(24157).default.addListener(this.handleTextSelectionStoreChange),this.sessionId=(0,p().lZ)()}submitEvent(e){switch(e.type){case"textSelectionCleared":case"blockEntered":this.currentBlockStore&&this.currentEnvironment&&this.isBlockStoreValidForAutoCorrect(this.currentBlockStore)&&this.addRequest({type:"blockAutoCorrectUnderlines",environment:this.currentEnvironment,blockStore:this.currentBlockStore}),this.currentBlockStore=void 0,this.currentEnvironment=void 0;break;case"blockUpdated":this.currentBlockStore||(this.currentBlockStore=e.blockStore,this.currentEnvironment=e.environment),this.currentBlockStore&&this.currentBlockStore.id!==e.blockStore.id&&this.currentEnvironment&&this.isBlockStoreValidForAutoCorrect(this.currentBlockStore)&&(this.addRequest({type:"blockAutoCorrectUnderlines",environment:this.currentEnvironment,blockStore:this.currentBlockStore}),this.currentBlockStore=e.blockStore,this.currentEnvironment=e.environment);break;case"undo":this.dropUntilMs[e.blockStore.id]=Date.now()+3e5;break;default:(0,_().HB)(e)}}addRequest(e){var t,n;if(e.blockStore.id===(null===(t=this.currentRequest)||void 0===t?void 0:t.blockStore.id)&&e.type===(null===(n=this.currentRequest)||void 0===n?void 0:n.type)&&(this.currentRequestCancelled=!0),this.requests.some((t=>t.blockStore.id===e.blockStore.id&&t.type===e.type)))return;const o=(0,w().o9)(e.blockStore.getNavigableBlockStore());o&&this.currentEnvironment&&(0,de().BP)(o,this.currentEnvironment,this.currentEnvironment.device)&&(L({navigableBlockId:o.id,blockId:o.id}),this.requests.push(e),this.triggerRun())}triggerRun(){this.currentRequest||this.run()}async run(){var e;if(this.currentRequest)throw new Error("CoEditingTasksManager.run called while a request is already in progress");if(!this.currentEnvironment)return;const t=null===(e=this.currentBlockStore)||void 0===e?void 0:e.getNavigableBlockStore();if(!this.currentBlockStore||!t)return;if(!(0,de().BP)(t,this.currentEnvironment,this.currentEnvironment.device))return;const o=this.requests.shift();if(!o)return;this.currentRequest=o;const r=(0,w().o9)(this.currentRequest.blockStore.getNavigableBlockStore());try{L({navigableBlockId:r.id,blockId:this.currentRequest.blockStore.id});const e=o.type;if("blockAutoCorrectUnderlines"===e)await this.runBlockAutoCorrectUnderlines(o);else(0,_().HB)(e)}catch(i){!function(e,t){const o=n(449412).Fg(t,{tags:{from:"coEditingTaskManager"}});n(857639).log({level:"error",from:"coEditingTaskManager",type:e,error:(0,ce().convertErrorToLog)(t),data:{},sentryEventId:o})}(o.type,i)}finally{N({navigableBlockId:r.id,blockId:this.currentRequest.blockStore.id}),this.currentRequest=null,this.currentRequestCancelled=!1}this.run()}async runBlockAutoCorrectUnderlines(e){const{environment:t,blockStore:n}=e,o=n.getTitleValue(),r=n.getNavigableBlockStore();if(!r)return;const i=(0,p().lZ)(),s=await E(t,n.getSpaceId(),o,i,r.pointer);if(!s||this.currentRequestCancelled)return;const a=(0,d().q4_)(o);a===(0,d().q4_)(n.getTitleValue())&&a!==s&&n.useCrdt()&&await Q({environment:t,blockStore:n,completion:s,traceId:i,sessionId:this.sessionId})}getSessionId(){return this.sessionId}resetSessionId(){return this.sessionId=(0,p().lZ)(),this.sessionId}isBlockStoreValidForAutoCorrect(e){var t;if(this.dropUntilMs[e.id]&&this.dropUntilMs[e.id]>Date.now())return!1;if(e.isNavigableBlock()||e.isLocked()||!e.canEdit())return!1;const n=e.getType();if(!n)return!1;if(!le[n])return!1;if(e.getDiscussionStores().filter((e=>!e.getResolved())).length>0)return!1;const o=null===(t=e.getTitleStore())||void 0===t?void 0:t.getValue();if(!o)return!1;return!o.some((e=>{if(2!==e.length)return!1;return e[1].some((e=>!ue[e[0]]))}))}}}}]);