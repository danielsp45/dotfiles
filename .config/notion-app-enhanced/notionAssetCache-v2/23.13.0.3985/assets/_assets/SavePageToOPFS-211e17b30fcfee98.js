"use strict";(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[82094],{281795:(e,n,t)=>{t.d(n,{E:()=>i});var a=()=>t(963589),r=()=>t(706762);function i(){const e=(0,a().X)("opfs_recordmap_cache",!1,!1),n=(0,r().s)();return e&&n}},402245:(e,n,t)=>{t.r(n),t.d(n,{SavePageToOPFS:()=>T});t(517642),t(658004),t(733853),t(845876),t(432475),t(515024),t(731698),t(898992),t(354520),t(908872);var a=t(296540),r=()=>t(395361),i=()=>t(484714),o=()=>t(56366),c=()=>t(452540),s=()=>t(134025),u=()=>t(179034),d=()=>t(963589);var l=()=>t(495074),g=()=>t(765957),f=()=>t(733539),k=(t(944114),()=>t(585515)),v=()=>t(577449),m=()=>t(388821),p=()=>t(780054),h=()=>t(870618),b=()=>t(882368);var _=()=>t(281795);function C(e){const n=(0,i().v3)(),t=(0,_().E)(),[C,T]=(0,a.useState)(!1),y=(0,d().X)("opfs_save_page_strategy_revision_tracking"),w=(0,d().X)("opfs_save_page_strategy_sync_tracking"),S=(0,d().X)("opfs_save_page_strategy_background"),E=(0,d().X)("opfs_save_page_strategy_navigation"),L=(0,o().uB)(g().default),P={revisionTracking:y,syncTracking:w,backgrounded:S,navigation:E},A=(0,a.useCallback)((e=>{var t;null!==(t=L.state.currentLoadingContainerStore)&&void 0!==t&&t.state.endOfResultsReached&&async function(e,n){const t=(0,b().getOPFSPageCache)();if(!n.currentUser.id||!g().default.state.currentSpaceStore||!t)return;performance.mark("generate-chunk-start");const a=[];let r={stack:[]};for(;r;){const t=m().RecordMapWithRole.create(),i=await(0,k().T)({page:{spaceId:g().default.state.currentSpaceStore.id,id:e},limit:30,cursor:r,verticalColumns:!0,baseUrl:p().A.domainBaseUrl,publicDomainName:p().A.publicDomainName,shouldTraverseToggleBlocks:!0,loadButtonBlockChildren:!0,contentBatchSize:30},v().h.fromMonomorphicFunctionUnsafe((async e=>{const a=await h().h7({environment:n,pointer:e,useInMemoryCacheOnly:!0,skipAccessWrites:!0});return a?(t.setModelAndRole(e,a.model,a.role),a.model):void 0})));if(a.push(t),0===i.cursorValue.stack.length){r=void 0;break}r=i.cursorValue}performance.mark("generate-chunk-end"),performance.measure("generate-chunk","generate-chunk-start","generate-chunk-end"),await t.write(n.currentUser.id,e,a)}(e,n).catch((e=>{}))}),[n,L]),B=(0,r().Y)((e=>{window.requestIdleCallback?window.requestIdleCallback((()=>A(e)),{timeout:1e4}):setTimeout((()=>A(e)),2e3)}),1e3),D=(0,a.useCallback)((function(){for(var n=arguments.length,t=new Array(n),a=0;a<n;a++)t[a]=arguments[a];for(const r of t){const n=(0,c().W8)({combinedId:r.combinedId});"track_page"===r.type&&n.id===e?T(!0):"untrack_page"===r.type&&n.id===e&&T(!1)}}),[e]);(0,a.useEffect)((()=>{if(!P.revisionTracking&&!P.syncTracking)return void l().A.removeListener(D);l().A.addListener(D);return l().A.getPageBlockTrackerForPage({table:u().ev,id:e})&&T(!0),()=>l().A.removeListener(D)}),[e,D,P.revisionTracking,P.syncTracking]);const I=(0,a.useMemo)((()=>{if(!1!==C)return l().A.getPageBlockTrackerForPage({table:u().ev,id:e})}),[e,C]),U=(0,a.useCallback)((()=>{if(!I)return;performance.mark("revisionChangeDetectionStart");const n=f().default.state,t=n.undoStack[n.undoStack.length-1];if(!t)return;const a=t.transactions.reduce(((e,n)=>{for(const t of n.operations)if(t.pointer.table===u().ev&&e.add(t.pointer.id),(0,s().mP)(t)&&t.additionalUpdatedPointers)for(const n of t.additionalUpdatedPointers)n.table===u().ev&&e.add(n.id);return e}),new Set),r=I.getLiveBlocks().filter((e=>{let{blockStore:n}=e;return a.has(n.id)}));performance.mark("revisionChangeDetectionEnd");performance.measure("revisionChangeDetection","revisionChangeDetectionStart","revisionChangeDetectionEnd");r.length>0&&B(e)}),[I,e,B]);(0,a.useEffect)((()=>{if(t&&P.revisionTracking&&I)return f().default.addListener(U),()=>f().default.removeListener(U)}),[t,P.revisionTracking,I,U]);const M=(0,a.useCallback)((()=>{B(e)}),[e,B]),F=(0,r().Y)(M,50);(0,a.useEffect)((()=>{if(t&&P.syncTracking&&I)return I.addListener(F),()=>{I.removeListener(F)}}),[t,P.syncTracking,I,F]),(0,a.useEffect)((()=>{if(P.navigation)return()=>{B(e)}}),[P.navigation,e,B]);!function(e,n){const t=(0,r().Y)(e,(null==n?void 0:n.debounceTimeMs)??256),i=(0,a.useCallback)((()=>{document.hidden&&t()}),[t]),o=(0,a.useCallback)((()=>{t()}),[t]);(0,a.useEffect)((()=>(document.addEventListener("visibilitychange",i),window.addEventListener("blur",o),()=>{document.removeEventListener("visibilitychange",i),window.removeEventListener("blur",o),t.cancel()})),[t,i,o])}((0,a.useCallback)((()=>{t&&P.backgrounded&&B(e)}),[t,P.backgrounded,e,B]))}function T(e){let{pageId:n}=e;return C(n),null}}}]);