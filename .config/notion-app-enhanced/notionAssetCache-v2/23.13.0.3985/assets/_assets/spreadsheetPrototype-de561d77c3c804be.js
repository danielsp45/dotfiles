(globalThis.webpackChunknotion_next=globalThis.webpackChunknotion_next||[]).push([[87543],{185608:(e,t,l)=>{"use strict";l.r(t),l.d(t,{SpreadsheetPrototypeNotInProd:()=>p});l(944114);var s=l(296540),o=()=>l(484714),n=()=>l(187174),r=()=>l(919709),a=()=>l(220719),i=()=>l(763824),c=()=>l(319975),d=()=>l(751156),h=()=>l(522200),u=l(474848);function p(e){const{store:t}=e,p=(0,s.useRef)(null),f=(0,o().v3)(),[m,g]=(0,s.useState)(0),[v]=(0,n().Yb)((()=>async function(e){await e.load();const t=e.getContentStores();await(0,i().lX)(t,10,(e=>e.load()));const l=e.getFormat().table_block_column_order;if(!l)return[];const s=[];for(const o of t){const e=[];if(o.isType("table_row")){for(const t of l){const l={store:o.getPropertyStore(t),value:(0,r().q4_)(o.getPropertyValue(t))};e.push(l)}s.push(e)}}return s}(t)),[t,m]);return(0,s.useEffect)((()=>{if(!v.value||0===v.value.length||!p.current)return;const e=v.value,{SpreadsheetModel:t,SpreadsheetView:s,SpreadsheetController:o}=l(214528),n=p.current,i=(0,a().o9)(n.querySelector(".spreadsheet")),h=e.length,u=e[0].length,C=new t(h,u);for(let l=0;l<h;l++)for(let t=0;t<u;t++)C.setCellValue(l+1,t+1,e[l][t].value,!1);C.evaluateFormulas();C.addListener(((t,l)=>{const s=C.getRawCellValue(t,l),o=e[t-1][l-1].store;d().createAndCommit({environment:f,userAction:"spreadsheetPrototype.onCellChange",perform(e){c().R9({environment:f,store:o,value:(0,r().x9d)(s.toString()),transaction:e})},canUndo:!1})}));const m=e=>{g.handleKeyDown(e),e.stopPropagation()};n.addEventListener("keydown",m);const g=new s(C,i,n);new o(C,g);return()=>{n.removeEventListener("keydown",m)}}),[f,v]),(0,u.jsxs)("div",{ref:p,children:[(0,u.jsx)("style",{children:C}),(0,u.jsx)("div",{className:"spreadsheet-prototype",children:(0,u.jsxs)("div",{className:"spreadsheet-app",children:[(0,u.jsxs)("div",{className:"formula-bar",children:[(0,u.jsx)("input",{type:"text",className:"formula-input",onMouseDown:e=>{e.stopPropagation()}}),"Â ",(0,u.jsx)("input",{type:"color",className:"color-picker",style:{marginRight:4,display:"none"}}),(0,u.jsx)("input",{type:"button",value:"Reload",onClick:()=>{g((e=>e+1))},style:{marginRight:4}}),(0,u.jsx)("input",{type:"button",value:"View as simple table",onClick:()=>{h().A.setState({...h().A.getState(),[t.id]:!1})}})]}),(0,u.jsx)("div",{className:"grid-container",children:(0,u.jsx)("table",{className:"spreadsheet"})})]})})]},m)}const C='\n.spreadsheet-prototype {\n.spreadsheet-app {\n  display: flex;\n  flex-direction: column;\n\n}\n\n.formula-bar {\n  display:flex;\n  padding: 10px;\n  background-color: #f0f0f0;\n}\n\n.formula-input {\n  width: 100%;\n  padding: 5px;\n}\n\n.grid-container {\n  flex-grow: 1;\n  overflow: auto;\n}\n\ntable {\n  border-collapse: collapse;\n}\n\nth, td {\n  border: 1px solid #ccc;\n  padding: 5px;\n  min-width: 80px;\n  height: 25px;\n}\n\nth {\n  background-color: #f0f0f0;\n  font-weight: bold;\n  position: sticky;\n  top: 0;\n  z-index: 1;\n}\n\n.selected {\n  background-color: #e6f3ff;\n  outline: 2px solid #0078d4;\n}\n\ninput[type="button"] {\n  font-size: 12px;\n}\n}\n'},214528:e=>{e.exports={SpreadsheetModel:class{constructor(e,t){this.rows=e,this.cols=t,this.data={},this.evaluatedData={},this.backgroundColors={},this.listeners=[]}resetModel(){this.data={},this.backgroundColors={}}copyCell(e,t){const l=`${e},${t}`;return{value:this.data[l]||"",backgroundColor:this.backgroundColors[l]||""}}pasteCell(e,t,l){this.setCellValue(e,t,l.value,!0),this.setCellBackgroundColor(e,t,l.backgroundColor)}setCellBackgroundColor(e,t,l){const s=`${e},${t}`;this.backgroundColors[s]=l,this.notifyListeners(e,t)}getCellBackgroundColor(e,t){const l=`${e},${t}`;return this.backgroundColors[l]||""}getCellValue(e,t){const l=`${e},${t}`;return void 0!==this.evaluatedData[l]?this.evaluatedData[l]:this.data[l]||""}getRawCellValue(e,t){const l=`${e},${t}`;return this.data[l]||""}setCellValue(e,t,l,s){const o=`${e},${t}`;this.data[o]=l,s&&(this.evaluateFormulas(),this.notifyListeners(e,t))}addListener(e){this.listeners.push(e)}notifyListeners(e,t,l){this.listeners.forEach((s=>s(e,t,l)))}evaluateFormulas(){this.evaluatedData={};for(const[e,t]of Object.entries(this.data))"string"==typeof t&&t.startsWith("=")?this.evaluatedData[e]=this.evaluateFormula(t.slice(1)):this.evaluatedData[e]=t}evaluateFormula(e){try{return e.toUpperCase().startsWith("SUM(")&&e.endsWith(")")?this.evaluateSum(e.slice(4,-1)):this.parseFormula(e)}catch(t){return"#ERROR!"}}evaluateSum(e){const[t,l]=e.split(":");if(!t||!l)throw new Error("Invalid range format");const s=t.charCodeAt(0)-65,o=parseInt(t.slice(1)),n=l.charCodeAt(0)-65,r=parseInt(l.slice(1));let a=0;for(let i=o;i<=r;i++)for(let e=s;e<=n;e++){const t=this.getCellValue(i,e+1);a+=isNaN(t)||""===t?0:parseFloat(t)}return a}parseFormula(e){const t=e.match(/([A-Z]\d+)|([+\-*/()])|(\d+(\.\d+)?)/g)||[],l=[],s=[],o={"+":1,"-":1,"*":2,"/":2};for(const n of t)if(/^[A-Z]\d+$/.test(n)){const[e,t]=[n.charCodeAt(0)-64,parseInt(n.slice(1))],s=this.getCellValue(t,e);l.push(isNaN(s)?0:parseFloat(s))}else if(/\d+(\.\d+)?/.test(n))l.push(parseFloat(n));else if(n in o){for(;s.length&&o[s[s.length-1]]>=o[n];)l.push(s.pop());s.push(n)}else if("("===n)s.push(n);else if(")"===n){for(;s.length&&"("!==s[s.length-1];)l.push(s.pop());s.pop()}for(;s.length;)l.push(s.pop());return this.evaluateRPN(l)}evaluateRPN(e){const t=[];for(const l of e)if("number"==typeof l)t.push(l);else{let e=t.pop(),s=t.pop();switch(isNaN(e)&&(e=0),isNaN(s)&&(s=0),l){case"+":t.push(s+e);break;case"-":t.push(s-e);break;case"*":t.push(s*e);break;case"/":t.push(s/e)}}return t[0]}},SpreadsheetView:class{constructor(e,t,l){this.model=e,this.element=t,this.selectedCell={row:1,col:1},this.formulaInput=l.querySelector(".formula-input"),this.colorPicker=l.querySelector(".color-picker"),this.copiedCell=null,this.render(),this.addEventListeners()}render(){const e=document.createElement("table"),t=document.createElement("tr");t.appendChild(document.createElement("th"));for(let l=1;l<=this.model.cols;l++){const e=document.createElement("th");e.textContent=String.fromCharCode(64+l),t.appendChild(e)}e.appendChild(t);for(let l=1;l<=this.model.rows;l++){const t=document.createElement("tr"),s=document.createElement("th");s.textContent=l,t.appendChild(s);for(let e=1;e<=this.model.cols;e++){const s=document.createElement("td"),o=this.model.getCellValue(l,e);s.textContent=o,s.dataset.row=l,s.dataset.col=e,this.applyCellAlignment(s,o);const n=this.model.getCellBackgroundColor(l,e);n&&(s.style.backgroundColor=n),t.appendChild(s)}e.appendChild(t)}this.element.innerHTML="",this.element.appendChild(e),this.highlightSelectedCell()}applyCellAlignment(e,t){this.isNumber(t)?e.style.textAlign="right":e.style.textAlign="left"}isNumber(e){if("number"==typeof e)return!0;if("string"==typeof e){if(e.startsWith("=")){return"number"==typeof this.model.parseFormula(e.slice(1))}return!isNaN(parseFloat(e))&&isFinite(e)}return!1}highlightSelectedCell(){const e=this.element.querySelector(".selected");e&&e.classList.remove("selected");const t=this.element.querySelector(`td[data-row="${this.selectedCell.row}"][data-col="${this.selectedCell.col}"]`);if(t){t.classList.add("selected");const e=this.model.getRawCellValue(this.selectedCell.row,this.selectedCell.col);this.formulaInput.value=e,this.formulaInput.focus(),this.formulaInput.select();const l=this.model.getCellBackgroundColor(this.selectedCell.row,this.selectedCell.col);this.colorPicker.value=l||"#ffffff"}}addEventListeners(){this.element.addEventListener("click",this.handleCellClick.bind(this)),this.formulaInput.addEventListener("change",this.handleFormulaInput.bind(this)),this.colorPicker.addEventListener("change",this.handleColorChange.bind(this))}handleColorChange(e){const t=e.target.value;this.model.setCellBackgroundColor(this.selectedCell.row,this.selectedCell.col,t)}handleCellClick(e){const t=e.target.closest("td");t&&(this.selectedCell={row:parseInt(t.dataset.row),col:parseInt(t.dataset.col)},this.highlightSelectedCell())}handleKeyDown(e){const{key:t}=e,{row:l,col:s}=this.selectedCell;switch(t){case"ArrowUp":l>1&&this.selectedCell.row--;break;case"ArrowDown":l<this.model.rows&&this.selectedCell.row++;break;case"ArrowLeft":s>1&&this.selectedCell.col--;break;case"ArrowRight":s<this.model.cols&&this.selectedCell.col++;break;default:return void((e.ctrlKey||e.metaKey)&&"c"===e.key?(e.preventDefault(),this.copiedCell=this.model.copyCell(this.selectedCell.row,this.selectedCell.col)):(e.ctrlKey||e.metaKey)&&"v"===e.key&&(e.preventDefault(),this.copiedCell&&this.pasteCopiedCell()))}e.preventDefault(),this.highlightSelectedCell()}pasteCopiedCell(){if(!this.copiedCell)return;const{row:e,col:t}=this.selectedCell;this.model.pasteCell(e,t,this.copiedCell),this.render()}handleFormulaInput(e){const{row:t,col:l}=this.selectedCell;this.model.setCellValue(t,l,e.target.value,!0)}},SpreadsheetController:class{constructor(e,t){this.model=e,this.view=t,this.model.addListener((()=>{this.view.render()}))}}}}}]);